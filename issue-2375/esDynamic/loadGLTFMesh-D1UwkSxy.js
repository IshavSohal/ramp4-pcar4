import{s as L,a2 as P,c4 as B,aO as C,ca as z,cb as S,cc as D,j8 as G,aJ as U,d$ as N}from"./main-C02UbYD7.js";import{e as M}from"./mat3f64-Dh9_zhFu.js";import{w as q,m as V,h as k,c as J}from"./Mesh-BjHuAs0y.js";import{l as K}from"./MeshVertexAttributes-Dl07RD-s.js";import{s as E}from"./meshVertexSpaceUtils-BMxKAlqa.js";import{c as R,x as A,L as Q,O,i as _,E as H,T as W,u as X}from"./BufferView-1RW1XqdH.js";import{t as Y,r as Z,u as ee,n as $}from"./vec3-BZAykMFH.js";import{f as te,o as oe,u as F}from"./vec4-CS29-giu.js";import{e as re}from"./types-ChhhI6OU.js";import{n as ne,l as se,o as ae,f as le,a as w,b as ie,c as ue,e as ce,d as fe,g as me}from"./DefaultMaterial_COLOR_GAMMA-C616Hb0y.js";import{M as pe}from"./vertexSpaceConversion-B53LQZTS.js";import{r as de}from"./resourceUtils-BhZvoyZ-.js";import{D as b}from"./enums-DDkmfb-t.js";function ge(e,t,o){const i=e.typedBuffer,n=e.typedBufferStride,a=t.typedBuffer,c=t.typedBufferStride,l=o?o.count:t.count;let s=(o?.dstIndex??0)*n,m=(o?.srcIndex??0)*c;for(let u=0;u<l;++u){for(let r=0;r<9;++r)i[s+r]=a[m+r];s+=n,m+=c}}Object.freeze(Object.defineProperty({__proto__:null,copy:ge},Symbol.toStringTag,{value:"Module"}));function xe(e,t,o){const i=e.typedBuffer,n=e.typedBufferStride,a=t.typedBuffer,c=t.typedBufferStride,l=o?o.count:t.count;let s=(o?.dstIndex??0)*n,m=(o?.srcIndex??0)*c;for(let u=0;u<l;++u){for(let r=0;r<16;++r)i[s+r]=a[m+r];s+=n,m+=c}}Object.freeze(Object.defineProperty({__proto__:null,copy:xe},Symbol.toStringTag,{value:"Module"}));function T(e,t){return new e(new ArrayBuffer(t*e.ElementCount*re(e.ElementType)))}async function Te(e,t,o){const i=new ne(ye(o)),n=(await se(i,t,o,!0)).model,a=n.lods.shift(),c=new Map,l=new Map;n.textures.forEach((x,h)=>c.set(h,be(x))),n.materials.forEach((x,h)=>l.set(h,ve(x,c)));const s=we(a);for(const x of s.parts)Be(s,x,l);const{position:m,normal:u,tangent:r,color:f,texCoord0:p}=s.vertexAttributes,g=E(e,o),j=e.spatialReference.isGeographic?E(e):g,v=pe({vertexAttributes:{position:m.typedBuffer,normal:u?.typedBuffer,tangent:r?.typedBuffer},vertexSpace:j,spatialReference:e.spatialReference},g,{allowBufferReuse:!0,sourceUnit:"meters"});if(!v)throw new L("loadGLTFMesh()","Failed to load mesh from glTF due to projection errors");return{transform:null,vertexSpace:g,components:s.components,spatialReference:e.spatialReference,vertexAttributes:new K({...v,color:f?.typedBuffer,uv:p?.typedBuffer})}}function ye(e){const t=e?.resolveFile;return t?{busy:!1,request:async(o,i,n)=>{const a=t?.(o)??o;return(await P(a,{responseType:i==="image"?"image":i==="binary"||i==="image+type"?"array-buffer":"json",signal:n?.signal,timeout:0})).data}}:null}function y(e,t){if(e==null)return"-";const o=e.typedBuffer;return`${B(t,o.buffer,()=>t.size)}/${o.byteOffset}/${o.byteLength}`}function he(e){return e!=null?e.toString():"-"}function we(e){let t=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},i=new Map,n=new Map,a=[];for(const c of e.parts){const{attributes:{position:l,normal:s,color:m,tangent:u,texCoord0:r}}=c,f=`
      ${y(l,i)}/
      ${y(s,i)}/
      ${y(m,i)}/
      ${y(u,i)}/
      ${y(r,i)}/
      ${he(c.transform)}
    `;let p=!1;const g=B(n,f,()=>(p=!0,{start:t,length:l.count}));p&&(t+=l.count),s&&(o.normal=!0),m&&(o.color=!0),u&&(o.tangent=!0),r&&(o.texCoord0=!0),a.push({gltf:c,writeVertices:p,region:g})}return{vertexAttributes:{position:T(W,t),normal:o.normal?T(_,t):null,tangent:o.tangent?T(R,t):null,color:o.color?T(A,t):null,texCoord0:o.texCoord0?T(X,t):null},parts:a,components:[]}}function be(e){return new q({data:(de(e.data),e.data),wrap:Me(e.parameters.wrap)})}function ve(e,t){const o=new C(Ee(e.color,e.opacity)),i=e.emissiveFactor?new C(Re(e.emissiveFactor)):null,n=a=>a?new J({scale:a.scale?[a.scale[0],a.scale[1]]:[1,1],rotation:N(a.rotation??0),offset:a.offset?[a.offset[0],a.offset[1]]:[0,0]}):null;return new V({color:o,colorTexture:t.get(e.textureColor),normalTexture:t.get(e.textureNormal),emissiveColor:i,emissiveTexture:t.get(e.textureEmissive),occlusionTexture:t.get(e.textureOcclusion),alphaMode:Se(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.get(e.textureMetallicRoughness),colorTextureTransform:n(e.colorTextureTransform),normalTextureTransform:n(e.normalTextureTransform),occlusionTextureTransform:n(e.occlusionTextureTransform),emissiveTextureTransform:n(e.emissiveTextureTransform),metallicRoughnessTextureTransform:n(e.metallicRoughnessTextureTransform)})}function Be(e,t,o){t.writeVertices&&Ce(e,t);const{indices:i,attributes:n,primitiveType:a,material:c}=t.gltf;let l=ae(i||n.position.count,a);const s=t.region.start;if(s){const m=new Uint32Array(l);for(let u=0;u<l.length;u++)m[u]+=s;l=m}e.components.push(new k({name:t.gltf.name,faces:l,material:o.get(c),shading:n.normal?"source":"flat",trustSourceNormals:!0}))}function Ce(e,t){const{position:o,normal:i,tangent:n,color:a,texCoord0:c}=e.vertexAttributes,l=t.region.start,{attributes:s,transform:m}=t.gltf,u=s.position.count;if(Y(o.slice(l,u),s.position,m),s.normal!=null&&i!=null){const r=z(M(),m),f=i.slice(l,u);Z(f,s.normal,r),S(r)&&ee(f,f)}else i!=null&&le(i,0,0,1,{dstIndex:l,count:u});if(s.tangent!=null&&n!=null){const r=D(M(),m),f=n.slice(l,u);te(f,s.tangent,r),S(r)&&oe(f,f)}else n!=null&&w(n,0,0,1,1,{dstIndex:l,count:u});if(s.texCoord0!=null&&c!=null?ie(c.slice(l,u),s.texCoord0):c!=null&&ue(c,0,0,{dstIndex:l,count:u}),s.color!=null&&a!=null){const r=s.color,f=a.slice(l,u);if(r.elementCount===4)r instanceof R?F(f,r,255):r instanceof A?ce(f,r):r instanceof Q&&F(f,r,1/256);else{w(f,255,255,255,255);const p=O.fromTypedArray(f.typedBuffer,f.typedBufferStride);r instanceof _?$(p,r,255):r instanceof O?fe(p,r):r instanceof H&&$(p,r,1/256)}}else a!=null&&w(a.slice(l,u),255,255,255,255)}function Se(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Me(e){return{horizontal:I(e.s),vertical:I(e.t)}}function I(e){switch(e){case b.CLAMP_TO_EDGE:return"clamp";case b.MIRRORED_REPEAT:return"mirror";case b.REPEAT:return"repeat"}}function d(e){return e**(1/me)*255}function Ee(e,t){return G(d(e[0]),d(e[1]),d(e[2]),t)}function Re(e){return U(d(e[0]),d(e[1]),d(e[2]))}export{Te as loadGLTFMesh};
