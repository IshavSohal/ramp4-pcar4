import{fg as P,S as v,T as g,fh as b,fi as j,fj as z,D as C,s as I,fk as Q,V as W,bi as A,G as k,H as B,fl as F,M as N,b8 as Y,c4 as J,O as w,P as q,Q as K,aR as X,fm as Z}from"./main-C02UbYD7.js";import{j as $,m as M}from"./perspectiveUtils-BlGTGsow.js";import"./GeometryUtils-C38J0GTP.js";import"./UpdateTracking2D-Dbow3jYu.js";import{d as x}from"./enums-BsbtGCGp.js";import"./definitions-Doe0g1C2.js";import"./floatRGBA-BLC568ta.js";import{s as ee}from"./Container-opHDNgle.js";import"./WGLContainer-DpYvmPLF.js";import{e as te,c as G}from"./Texture-BNs5xfWp.js";import{D as se,E as re,F as H}from"./enums-DDkmfb-t.js";import{c as D}from"./Program-kooLQgoA.js";import"./LabelMetric-BYq7UFJE.js";import"./StyleDefinition-Dfu7Kx8O.js";import"./enums-qHpGJ28Q.js";import"./MagnifierPrograms-gHYFEO3-.js";import"./FeatureCommandQueue-CZzTPMLL.js";import"./PieChartMeshWriter-DHDfWlls.js";import"./renderState-DjM_esgh.js";import"./interfaces-Aq8q9x0N.js";import"./testSVGPremultipliedAlpha-DFSsxJlf.js";import"./GraphicsView2D-RmB8rv3h.js";import"./earcut-BxtRhkib.js";import"./vec3f32-BS0cezmI.js";import{e as ie}from"./mat3f64-Dh9_zhFu.js";import{f as ne}from"./utils-B9vCU6Yh.js";import{o as ae}from"./ProgramTemplate-zI547AoJ.js";import{f as oe}from"./OverlayContainer-DTz9rl8F.js";import{f as le,y as he}from"./LayerView-Cq7I41Ey.js";const me=[1,1],ce=4,c=ie(),de={none:x.None,loop:x.Loop,oscillate:x.Oscillate};function ue(t){return t?{...t,playAnimation:t.playing,repeatType:t.repeatType?de[t.repeatType]:void 0}:{}}class pe extends ee{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=P(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(v(()=>this.elementView.element.opacity,s=>this.opacity=s,g),v(()=>[this.elementView.coords],()=>{this.requestRender()},g),v(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._playHandle?.remove(),this.texture=b(this.texture),this.requestRender()},g),j(()=>this.elementView.element.loaded,()=>{const s=this.elementView.element;this.ready(),s.type==="video"&&s.content!=null&&this._handles.push(z(s.content,"play",()=>this.requestRender()))},g)),e.element.load().catch(s=>{C.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new I("element-load-error","Element cannot be displayed",{element:e,error:s}))})}getMesh(e){throw new Error("Method not implemented.")}destroy(){this._playHandle?.remove(),this._handles.forEach(e=>e.remove()),this.texture=b(this.texture)}get textureSize(){return me}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:s}=e,r=this.elementView.element.content;if(r!=null){const i=r instanceof HTMLImageElement,a=r instanceof HTMLVideoElement,n=i?r.naturalWidth:a?r.videoWidth:r.width,h=i?r.naturalHeight:a?r.videoHeight:r.height;if(this._updatePerspectiveTransform(n,h),this.texture)a&&!r.paused&&(this.texture.setData(r),this.requestRender(),this.texture.generateMipmap());else{const l=new te;if(l.wrapMode=se.CLAMP_TO_EDGE,l.preMultiplyAlpha=!0,l.width=n,l.height=h,"getFrame"in r){const p=m=>{this.texture?this.texture.setData(m):this.texture=new G(s,l,m),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=ne(r,ue(this.elementView.element.animationOptions),null,p))}else this.texture=new G(s,l,r);this.texture.generateMipmap(),a&&!r.paused&&this.requestRender()}}super.beforeRender(e)}_createTransforms(){return null}draw(e){e.drawArrays(re.TRIANGLE_STRIP,0,ce)}updateDrawCoords(e,s,r,i){const{coords:a,bounds:n}=this.elementView;if(a==null||n==null)return;const[h,l,p,m]=a.rings[0],L=this._vertices,{x:f,y}=e;L.set([l[0]-f,l[1]-y,h[0]-f,h[1]-y,p[0]-f,p[1]-y,m[0]-f,m[1]-y]);let _=s;if(i){const[R,,T]=n,{worldWidth:E,xBounds:O}=i,[V,S]=O;R<V&&T>V?_=E:T>S&&R<S&&(_=-E)}this.wrapAroundShift=_,this.isWrapAround=_!==0}getVAO(e,s,r){if(this.elementView.coords==null)return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=D.createVertex(e,H.DYNAMIC_DRAW,i);const a=D.createVertex(e,H.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new ae(e,r,s,{geometry:this._geometryVbo,tex:a})}return this._vao}_updatePerspectiveTransform(e,s){const r=this._vertices;$(c,[0,0,e,0,0,s,e,s],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),Q(this.perspectiveTransform,c[6]/c[8]*e,c[7]/c[8]*s)}}let d=class extends le(he){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new W}attach(){this.addAttachHandles([A(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(t=>this._updateTile(t)),this.requestUpdate()}),A(()=>this.layer.effectiveSource,"change",({element:t})=>this._elementUpdateHandler(t))]),this._overlayContainer=new oe,this.container.addChild(this._overlayContainer),this._fetchQueue=new k({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(t,e)=>this._queryElements(t,e)}),this._tileStrategy=new B({cachePolicy:"purge",resampling:!0,acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(t){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(t){this._tileStrategy.update(t),this._debugGraphicsView?.update(t)}async hitTest(t,e){const s=[],r=t.normalize(),i=[r.x,r.y];for(const{projectedElement:{normalizedCoords:a,element:n}}of this._elementReferences.values())a!=null&&F(a.rings,i)&&s.push({type:"media",element:n,layer:this.layer,mapPoint:t,sourcePoint:n.toSource(t)});return s.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh(t=>this._updateTile(t))}_acquireTile(t){const e=new fe(t.clone());return this._updateTile(e),e}_updateTile(t){this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(e=>{const[s,r]=t.setElements(e);this._referenceElements(t,s),this._dereferenceElements(t,r),this.requestUpdate()},e=>{N(e)||C.getLogger(this).error(e)}))}_releaseTile(t){this._fetchQueue.abort(t.key.id),t.elements&&this._dereferenceElements(t,t.elements),this.requestUpdate()}async _queryElements(t,e){const s=this.layer.effectiveSource;if(s==null)return[];this.view.featuresTilingScheme.getTileBounds(o,t,!0);const r=new Y({xmin:o[0],ymin:o[1],xmax:o[2],ymax:o[3],spatialReference:this.view.spatialReference});return s.queryElements(r,e)}_referenceElements(t,e){if(this.layer.source!=null)for(const s of e)this._referenceElement(t,s)}_referenceElement(t,e){J(this._elementReferences,e.uid,()=>{const s=new M({element:e,spatialReference:this.view.spatialReference}),r=new pe(s);return this._overlayContainer.addChild(r),this.elements.add(e),{tiles:new Set,projectedElement:s,overlay:r,debugGraphic:null}}).tiles.add(t)}_dereferenceElements(t,e){for(const s of e)this._dereferenceElement(t,s)}_dereferenceElement(t,e){const s=this._elementReferences.get(e.uid);s.tiles.delete(t),s.tiles.size||(this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),this._debugGraphicsView?.graphics.remove(s.debugGraphic))}_elementUpdateHandler(t){let e=this._elementReferences.get(t.uid);if(e){const r=e.projectedElement.normalizedCoords;if(r==null)return this._overlayContainer.removeChild(e.overlay),e.overlay.destroy(),e.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),void this._debugGraphicsView?.graphics.remove(e.debugGraphic);const i=[],a=[];for(const n of this._tileStrategy.tiles){const h=U(this.view.featuresTilingScheme,n,r);e.tiles.has(n)?h||a.push(n):h&&i.push(n)}for(const n of i)this._referenceElement(n,t);for(const n of a)this._dereferenceElement(n,t);return e=this._elementReferences.get(t.uid),void(e?.debugGraphic&&(e.debugGraphic.geometry=e.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:e.debugGraphic,property:"geometry"})))}const s=new M({element:t,spatialReference:this.view.spatialReference}).normalizedCoords;if(s!=null)for(const r of this._tileStrategy.tiles)U(this.view.featuresTilingScheme,r,s)&&this._referenceElement(r,t)}};w([q()],d.prototype,"layer",void 0),w([q({readOnly:!0})],d.prototype,"elements",void 0),d=w([K("esri.views.2d.layers.MediaLayerView2D")],d);const o=X(),u={xmin:0,ymin:0,xmax:0,ymax:0};function U(t,e,s){return t.getTileBounds(o,e.key,!0),u.xmin=o[0],u.ymin=o[1],u.xmax=o[2],u.ymax=o[3],Z(u,s)}class fe{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){const s=[],r=new Set(this.elements);this.elements=e;for(const i of e)r.has(i)?r.delete(i):s.push(i);return this.isReady=!0,[s,Array.from(r)]}destroy(){}}const ye=d;export{ye as default};
