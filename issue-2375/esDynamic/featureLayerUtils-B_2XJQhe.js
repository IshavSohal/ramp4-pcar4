import{L as P,h as E,g as x,d as N,l as O,a as f,i as d,f as y}from"./main-C02UbYD7.js";import{$ as J,j as $}from"./utils-llxYaimi.js";import{t as D,a as R,i as g}from"./fetchService-zmqvXODx.js";const p="Feature Service",m="feature-layer-utils",F=`${m}-save`,K=`${m}-save-as`;function h(e){return{isValid:P(e)&&(e.type!=="feature"||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function b(e){const a=[],r=[];for(const{layer:t,layerJSON:o}of e)t.isTable?r.push(o):a.push(o);return{layers:a,tables:r}}function T(e){return b([e])}async function M(e,a){return/\/\d+\/?$/.test(e.url)?T(a[0]):j(a,e)}async function j(e,a){if(e.reverse(),!a)return b(e);const r=await G(a,e);for(const t of e)A(t.layer,t.layerJSON,r);return B(r,e),r}async function G(e,a){let r=await e.fetchData("json");if(Y(r))return r;r||={},_(r);const{layer:{url:t,customParameters:o,apiKey:n}}=a[0];return await U(r,{url:t??"",customParameters:o,apiKey:n},a.map(s=>s.layer.layerId)),r}function Y(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function _(e){e.layers||=[],e.tables||=[]}function B(e,a){const r=[],t=[];for(const{layer:o}of a){const{isTable:n,layerId:s}=o;n?t.push(s):r.push(s)}v(e.layers,r),v(e.tables,t)}function v(e,a){if(e.length<2)return;const r=[];for(const{id:t}of e)r.push(t);E(r.sort(I),a.slice().sort(I))&&e.sort((t,o)=>{const n=a.indexOf(t.id),s=a.indexOf(o.id);return n<s?-1:n>s?1:0})}function I(e,a){return e<a?-1:e>a?1:0}async function U(e,a,r){const{url:t,customParameters:o,apiKey:n}=a,{serviceJSON:s,layersJSON:i}=await D(t,{customParameters:o,apiKey:n}),l=w(e.layers,s.layers,r),u=w(e.tables,s.tables,r);e.layers=l.itemResources,e.tables=u.itemResources;const c=[...l.added,...u.added],L=i?[...i.layers,...i.tables]:[];await V(e,c,t,L)}function w(e,a,r){const t=x(e,a,(n,s)=>n.id===s.id);e=e.filter(n=>!t.removed.some(s=>s.id===n.id));const o=t.added;return o.forEach(({id:n})=>{e.push({id:n})}),{itemResources:e,added:o.filter(({id:n})=>!r.includes(n))}}async function V(e,a,r,t){const o=await k(a),n=a.map(({id:s,type:i})=>new(o.get(i))({url:r,layerId:s,sourceJSON:t.find(({id:l})=>l===s)}));await Promise.allSettled(n.map(s=>s.load())),n.forEach(s=>{const{layerId:i,loaded:l,defaultPopupTemplate:u}=s;if(!l||u==null)return;const c={id:i,popupInfo:u.toJSON()};s.operationalLayerType!=="ArcGISFeatureLayer"&&(c.layerType=s.operationalLayerType),A(s,c,e)})}async function k(e){const a=[];e.forEach(({type:o})=>{const n=g(o),s=R[n];a.push(s())});const r=await Promise.all(a),t=new Map;return e.forEach(({type:o},n)=>{t.set(o,r[n])}),t}function A(e,a,r){e.isTable?S(r.tables,a):S(r.layers,a)}function S(e,a){const r=e.findIndex(({id:t})=>t===a.id);r===-1?e.push(a):e[r]=a}async function q(e,a){const{url:r,layerId:t,title:o,fullExtent:n,isTable:s}=e,i=N(r);a.url=(i?.serverType==="FeatureServer"?r:`${r}/${t}`)??null,a.title||=o,a.extent=null,s||n==null||(a.extent=await O(n)),f(a,y.METADATA),f(a,y.MULTI_LAYER),d(a,y.SINGLE_LAYER),s&&d(a,y.TABLE)}async function H(e,a){return J({layer:e,itemType:p,validateLayer:h,createItemData:(r,t)=>M(t,[r]),errorNamePrefix:F},a)}async function Q(e,a,r){return $({layer:e,itemType:p,validateLayer:h,createItemData:(t,o)=>Promise.resolve(T(t)),errorNamePrefix:K,newItem:a,setItemProperties:q},r)}export{H as save,Q as saveAs};
