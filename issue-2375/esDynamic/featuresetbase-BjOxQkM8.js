import{m as Fe}from"./TimeOnly-CAgpzQQx.js";import{a as E,v as De,w as J,B as x,N as v,b as c,r as m,G as $,m as N,y as Te,A as ue,X as de,W as ce,P as S,F as k,U as A,H as G,I as be,Q as U,_ as Ee,g as O,D as Ne,K as Ae,S as _,T as Y,V as xe,$ as X}from"./arcadeUtils-Cqggt430.js";import{q as Le,G as me,d as Se,c as B,e as Ce,a as ve,b as $e,T as ee,E as Pe,N as Ze,O as Re,B as M,f as Ue,k as K,L as C,I as te}from"./featureSetUtils-zgVU0_h1.js";import{t as Me}from"./ImmutableArray-CiJxhY8_.js";import{l as ke}from"./portalUtils-ZbYR0uQE.js";import{u as Oe,D as ye}from"./SpatialFilter-BUrqUC35.js";import{C as pe,eC as ze,em as ne,dv as j}from"./main-C02UbYD7.js";import{O as b}from"./WhereClause-CoIZdsJ6.js";function He(s){if(s.length===1){if(A(s[0]))return X("distinct",s[0],-1);if(U(s[0]))return X("distinct",s[0].toArray(),-1)}return X("distinct",s,-1)}async function ie(s,t,i){const p=s.getVariables();if(p.length>0){const F=[];for(let n=0;n<p.length;n++){const l={name:p[n]};F.push(await t.evaluateIdentifier(i,l))}const e={};for(let n=0;n<p.length;n++)e[p[n]]=F[n];return s.parameters=e,s}return s}function d(s,t,i=null){for(const p in s)if(p.toLowerCase()===t.toLowerCase())return s[p];return i}function we(s){if(s===null)return null;const t={type:d(s,"type",""),name:d(s,"name","")};if(t.type==="range")t.range=d(s,"range",[]);else{t.codedValues=[];for(const i of d(s,"codedValues",[]))t.codedValues.push({name:d(i,"name",""),code:d(i,"code",null)})}return t}function ae(s){if(s===null)return null;const t={},i=d(s,"wkt");i!==null&&(t.wkt=i);const p=d(s,"wkid");return p!==null&&(t.wkid=p),t}function he(s){if(s===null)return null;const t={hasZ:d(s,"hasz",!1),hasM:d(s,"hasm",!1)},i=d(s,"spatialreference");i!=null&&(t.spatialReference=ae(i));const p=d(s,"x",null);if(p!==null)return t.x=p,t.y=d(s,"y",null),t.hasZ&&(t.z=d(s,"z",null)),t.hasM&&(t.m=d(s,"m",null)),t;const F=d(s,"rings",null);if(F!==null)return t.rings=F,t;const e=d(s,"paths",null);if(e!==null)return t.paths=e,t;const n=d(s,"points",null);if(n!==null)return t.points=n,t;for(const l of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=d(s,l,null);r!==null&&(t[l]=r)}return t}function We(s,t){for(const i of t)if(i===s)return!0;return!1}function je(s){return!!s.layerDefinition&&!!s.featureSet&&We(s.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&A(s.layerDefinition.fields)!==!1&&A(s.featureSet.features)!==!1}function z(s){return s?.toLowerCase()==="utc"?"UTC":s?.toLowerCase()==="unknown"?"Unknown":s}function Ge(s){s.mode==="async"&&(s.functions.timezone=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,1,2,t,i),De(e[0])||J(e[0]))return"Unknown";if(x(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?z("unknown"):z(e[0].dateFieldsTimeZone);if(!(e[1]instanceof v)||e[1].hasField("type")===!1)throw new c(t,m.InvalidParameter,i);const r=e[1].field("type");if($(r)===!1)throw new c(t,m.InvalidParameter,i);switch(N(r).toLowerCase()){case"preferredtimezone":return z(e[0].preferredTimeZone);case"editfieldsinfo":return z(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return z(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&$(e[1].field("fieldname")))return z(e[0].fieldTimeZone(N(e[1].field("fieldname"))))}throw new c(t,m.InvalidParameter,i)}const n=Te(e[0],ue(t));if(n===null)return null;const l=n.timeZone;return l==="system"?Fe.systemTimeZoneCanonicalName:l.toLowerCase()==="utc"?"UTC":l.toLowerCase()==="unknown"?"Unknown":l})},s.functions.sqltimestamp=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{E(e,1,3,t,i);const n=e[0];if(de(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(N(e[1])).toSQLWithKeyword();throw new c(t,m.InvalidParameter,i)}if(J(n))return n.toSQLWithKeyword();if(x(n)){if(e.length!==3)throw new c(t,m.InvalidParameter,i);await n.load();const l=N(e[1]);if(J(e[2]))return e[2].toSQLWithKeyword();if(de(e[2])===!1)throw new c(t,m.InvalidParameter,i);const r=n.fieldTimeZone(l);return r===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(r).toSQLWithKeyword()}throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"sqltimestamp",min:2,max:4}),s.functions.featuresetbyid=function(t,i){return s.standardFunctionAsync(t,i,(p,F,e)=>{if(E(e,2,4,t,i),ce(e[0])){const n=N(e[1]);let l=S(e[2],null);const r=k(S(e[3],!0));if(l===null&&(l=["*"]),A(l)===!1)throw new c(t,m.InvalidParameter,i);return e[0].featureSetById(n,r,l)}throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"featuresetbyid",min:2,max:4}),s.functions.getfeatureset=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,1,2,t,i),G(e[0])){let n=S(e[1],"datasource");return n===null&&(n="datasource"),n=N(n).toLowerCase(),Le(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference??null)}throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"getfeatureset",min:1,max:2}),s.functions.featuresetbyportalitem=function(t,i){return s.standardFunctionAsync(t,i,(p,F,e)=>{if(E(e,2,5,t,i),e[0]===null)throw new c(t,m.PortalRequired,i);if(e[0]instanceof be){const f=N(e[1]),a=N(e[2]);let o=S(e[3],null);const u=k(S(e[4],!0));if(o===null&&(o=["*"]),A(o)===!1)throw new c(t,m.InvalidParameter,i);let w;return w=t.services?.portal?t.services.portal:pe.getDefault(),w=ke(e[0],w),me(f,a,t.spatialReference??null,o,u,w,t.lrucache,t.interceptor)}if($(e[0])===!1)throw new c(t,m.PortalRequired,i);const n=N(e[0]),l=N(e[1]);let r=S(e[2],null);const y=k(S(e[3],!0));if(r===null&&(r=["*"]),A(r)===!1)throw new c(t,m.InvalidParameter,i);return me(n,l,t.spatialReference??null,r,y,t.services?.portal??pe.getDefault(),t.lrucache,t.interceptor)})},s.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),s.functions.featuresetbyname=function(t,i){return s.standardFunctionAsync(t,i,(p,F,e)=>{if(E(e,2,4,t,i),ce(e[0])){const n=N(e[1]);let l=S(e[2],null);const r=k(S(e[3],!0));if(l===null&&(l=["*"]),A(l)===!1)throw new c(t,m.InvalidParameter,i);return e[0].featureSetByName(n,r,l)}throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"featuresetbyname",min:2,max:4}),s.functions.featureset=function(t,i){return s.standardFunction(t,i,(p,F,e)=>{E(e,1,1,t,i);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if($(e[0])){const l=JSON.parse(e[0]);l.layerDefinition!==void 0?(n.layerDefinition=l.layerDefinition,n.featureSet=l.featureSet,l.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=l.layerDefinition.spatialReference)):(n.featureSet.features=l.features,n.featureSet.geometryType=l.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=l.objectIdFieldName??"",n.layerDefinition.typeIdField=l.typeIdFieldName,n.layerDefinition.globalIdField=l.globalIdFieldName,n.layerDefinition.fields=l.fields,l.spatialReference&&(n.layerDefinition.spatialReference=l.spatialReference))}else{if(!(e[0]instanceof v))throw new c(t,m.InvalidParameter,i);{const l=JSON.parse(e[0].castToText(!0)),r=d(l,"layerdefinition");if(r!==null){n.layerDefinition.geometryType=d(r,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=d(r,"globalidfield",""),n.layerDefinition.objectIdField=d(r,"objectidfield",""),n.layerDefinition.typeIdField=d(r,"typeidfield",""),n.layerDefinition.hasZ=d(r,"hasz",!1)===!0,n.layerDefinition.hasM=d(r,"hasm",!1)===!0;const y=d(r,"spatialreference");y&&(n.layerDefinition.spatialReference=ae(y));const f=[];for(const o of d(r,"fields",[])){const u={name:d(o,"name",""),alias:d(o,"alias",""),type:d(o,"type",""),nullable:d(o,"nullable",!0),editable:d(o,"editable",!0),length:d(o,"length",null),domain:we(d(o,"domain"))};f.push(u)}n.layerDefinition.fields=f;const a=d(l,"featureset");if(a){const o={};for(const u of f)o[u.name.toLowerCase()]=u.name;for(const u of d(a,"features",[])){const w={},D=d(u,"attributes",{});for(const I in D)w[o[I.toLowerCase()]]=D[I];n.featureSet.features.push({attributes:w,geometry:he(d(u,"geometry"))})}}}else{n.layerDefinition.hasZ=d(l,"hasz",!1)===!0,n.layerDefinition.hasM=d(l,"hasm",!1)===!0,n.layerDefinition.geometryType=d(l,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=d(l,"objectidfieldname",""),n.layerDefinition.typeIdField=d(l,"typeidfieldname","");const y=d(l,"spatialreference");y&&(n.layerDefinition.spatialReference=ae(y));const f=[],a=d(l,"fields",null);if(!A(a))throw new c(t,m.InvalidParameter,i);for(const w of a){const D={name:d(w,"name",""),alias:d(w,"alias",""),type:d(w,"type",""),nullable:d(w,"nullable",!0),editable:d(w,"editable",!0),length:d(w,"length",null),domain:we(d(w,"domain"))};f.push(D)}n.layerDefinition.fields=f;const o={};for(const w of f)o[w.name.toLowerCase()]=w.name;let u=d(l,"features",null);if(A(u))for(const w of u){const D={},I=d(w,"attributes",{});for(const T in I)D[o[T.toLowerCase()]]=I[T];n.featureSet.features.push({attributes:D,geometry:he(d(w,"geometry",null))})}else u=null,n.featureSet.features=u}}}if(je(n)===!1)throw new c(t,m.InvalidParameter,i);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),Se.create(n,t.spatialReference)})},s.signatures.push({name:"featureset",min:1,max:1}),s.functions.filter=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,2,2,t,i),A(e[0])||U(e[0])){const n=[];let l,r=e[0];if(r instanceof Me&&(r=r.toArray()),!Ee(e[1]))throw new c(t,m.InvalidParameter,i);l=e[1].createFunction(t);for(const y of r){const f=l(y);ze(f)?await f===!0&&n.push(y):f===!0&&n.push(y)}return n}if(x(e[0])){const n=await e[0].load(),l=b.create(e[1],n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC),r=l.getVariables();if(r.length>0){const y=[];for(let a=0;a<r.length;a++){const o={name:r[a]};y.push(await s.evaluateIdentifier(t,o))}const f={};for(let a=0;a<r.length;a++)f[r[a]]=y[a];return l.parameters=f,new B({parentfeatureset:e[0],whereclause:l})}return new B({parentfeatureset:e[0],whereclause:l})}throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"filter",min:2,max:2}),s.functions.orderby=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,2,2,t,i),x(e[0])){const n=new Ce(e[1]);return new ve({parentfeatureset:e[0],orderbyclause:n})}throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"orderby",min:2,max:2}),s.functions.top=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,2,2,t,i),x(e[0]))return new $e({parentfeatureset:e[0],topnum:e[1]});if(A(e[0]))return O(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,O(e[1]));if(U(e[0]))return O(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,O(e[1]));throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"top",min:2,max:2}),s.functions.first=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,1,1,t,i),x(e[0])){const n=await e[0].first(p.abortSignal);if(n!==null){const l=Ne.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return l._underlyingGraphic=n,l}return n}return A(e[0])?e[0].length===0?null:e[0][0]:U(e[0])?e[0].length()===0?null:e[0].get(0):null})},s.signatures.push({name:"first",min:1,max:1}),s.functions.attachments=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{E(e,1,2,t,i);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof v){if(e[1].hasField("minsize")&&(n.minsize=O(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=k(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=O(e[1].field("maxsize"))),e[1].hasField("types")){const l=Ae(e[1].field("types"),!1);l.length>0&&(n.types=l)}}else if(e[1]!==null)throw new c(t,m.InvalidParameter,i)}if(G(e[0])){let l=e[0]._layer;return l instanceof ne&&(l=ee(l,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),l===null?[]:x(l)===!1?[]:(await l.load(),l.queryAttachments(e[0].field(l.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata))}if(e[0]===null)return[];throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"attachments",min:1,max:2}),s.functions.featuresetbyrelationshipname=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{E(e,2,4,t,i);const n=e[0],l=N(e[1]);let r=S(e[2],null);const y=k(S(e[3],!0));if(r===null&&(r=["*"]),A(r)===!1)throw new c(t,m.InvalidParameter,i);if(e[0]===null)return null;if(!G(e[0]))throw new c(t,m.InvalidParameter,i);let f=n._layer;if(f instanceof ne&&(f=ee(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),f===null||x(f)===!1)return null;f=await f.load();const a=f.relationshipMetaData().filter(I=>I.name===l);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return Pe(f,a[0],n.field(f.objectIdField),f.spatialReference,r,y,t.lrucache,t.interceptor);let o=f.serviceUrl();if(!o)return null;o=o.charAt(o.length-1)==="/"?o+a[0].relatedTableId.toString():o+"/"+a[0].relatedTableId.toString();const u=await Ze(o,f.spatialReference,r,y,t.lrucache,t.interceptor);await u.load();let w=u.relationshipMetaData();if(w=w.filter(I=>I.id===a[0].id),n.hasField(a[0].keyField)===!1||n.field(a[0].keyField)===null){const I=await f.getFeatureByObjectId(n.field(f.objectIdField),[a[0].keyField]);if(I){const T=b.create(w[0].keyField+"= @id",u.getFieldsIndex(),u.dateFieldsTimeZoneDefaultUTC);return T.parameters={id:I.attributes[a[0].keyField]},u.filter(T)}return new Oe({parentfeatureset:u})}const D=b.create(w[0].keyField+"= @id",u.getFieldsIndex(),u.dateFieldsTimeZoneDefaultUTC);return D.parameters={id:n.field(a[0].keyField)},u.filter(D)})},s.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),s.functions.featuresetbyassociation=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{E(e,2,3,t,i);const n=e[0],l=N(S(e[1],"")).toLowerCase(),r=$(e[2])?N(e[2]):null;if(e[0]===null)return null;if(!G(e[0]))throw new c(t,m.InvalidParameter,i);let y=n._layer;if(y instanceof ne&&(y=ee(y,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),y===null||x(y)===!1)return null;await y.load();const f=y.serviceUrl(),a=await Re(f,t.spatialReference);let o=null,u=null,w=!1;if(r!==null&&r!==""&&r!==void 0){for(const g of a.terminals)g.terminalName===r&&(u=g.terminalId);u===null&&(w=!0)}const D=a.associations.getFieldsIndex(),I=D.get("TOGLOBALID").name,T=D.get("FROMGLOBALID").name,V=D.get("TOTERMINALID").name,Q=D.get("FROMTERMINALID").name,H=D.get("FROMNETWORKSOURCEID").name,W=D.get("TONETWORKSOURCEID").name,R=D.get("ASSOCIATIONTYPE").name,Ie=D.get("ISCONTENTVISIBLE").name,ge=D.get("OBJECTID").name;for(const g of y.fields)if(g.type==="global-id"){o=n.field(g.name);break}let P=null,se=new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),b.create("0",a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC)),le=new M(new j({name:"side",alias:"side",type:"string"}),b.create("''",a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC));const L="globalid",oe="globalId",re={};for(const g in a.lkp)re[g]=a.lkp[g].sourceId;const Z=new Ue(new j({name:"classname",alias:"classname",type:"string"}),null,re);let h="";switch(l){case"midspan":{h=`((${I}='${o}') OR ( ${T}='${o}')) AND (${R} IN (5))`,Z.codefield=b.create(`CASE WHEN (${I}='${o}') THEN ${H} ELSE ${W} END`,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC);const g=Y(C.findField(a.associations.fields,T));g.name=L,g.alias=L,P=new M(g,b.create(`CASE WHEN (${T}='${o}') THEN ${I} ELSE ${T} END`,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC)),se=a.unVersion>=4?new te(C.findField(a.associations.fields,D.get("PERCENTALONG").name)):new M(new j({name:"percentalong",alias:"percentalong",type:"double"}),b.create("0",a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC));break}case"junctionedge":{h=`((${I}='${o}') OR ( ${T}='${o}')) AND (${R} IN (4,6))`,Z.codefield=b.create(`CASE WHEN (${I}='${o}') THEN ${H} ELSE ${W} END`,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC);const g=Y(C.findField(a.associations.fields,T));g.name=L,g.alias=L,P=new M(g,b.create(`CASE WHEN (${T}='${o}') THEN ${I} ELSE ${T} END`,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC)),le=new M(new j({name:"side",alias:"side",type:"string"}),b.create(`CASE WHEN (${R}=4) THEN 'from' ELSE 'to' END`,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC));break}case"connected":{let g=`${I}='@T'`,fe=`${T}='@T'`;u!==null&&(g+=` AND ${V}=@A`,fe+=` AND ${Q}=@A`),h="(("+g+") OR ("+fe+"))",h=_(h,"@T",o??""),g=_(g,"@T",o??""),u!==null&&(g=_(g,"@A",u.toString()),h=_(h,"@A",u.toString())),Z.codefield=b.create("CASE WHEN "+g+` THEN ${H} ELSE ${W} END`,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC);const q=Y(C.findField(a.associations.fields,T));q.name=L,q.alias=L,P=new M(q,b.create("CASE WHEN "+g+` THEN ${T} ELSE ${I} END`,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC));break}case"container":h=`${I}='${o}' AND ${R} = 2`,u!==null&&(h+=` AND ${V} = `+u.toString()),Z.codefield=H,h="( "+h+" )",P=new K(C.findField(a.associations.fields,T),L,L);break;case"content":h=`(${T}='${o}' AND ${R} = 2)`,u!==null&&(h+=` AND ${Q} = `+u.toString()),Z.codefield=W,h="( "+h+" )",P=new K(C.findField(a.associations.fields,I),L,L);break;case"structure":h=`(${I}='${o}' AND ${R} = 3)`,u!==null&&(h+=` AND ${V} = `+u.toString()),Z.codefield=H,h="( "+h+" )",P=new K(C.findField(a.associations.fields,T),L,oe);break;case"attached":h=`(${T}='${o}' AND ${R} = 3)`,u!==null&&(h+=` AND ${Q} = `+u.toString()),Z.codefield=W,h="( "+h+" )",P=new K(C.findField(a.associations.fields,I),L,oe);break;default:throw new c(t,m.InvalidParameter,i)}return w&&(h="1 <> 1"),new C({parentfeatureset:a.associations,adaptedFields:[new te(C.findField(a.associations.fields,ge)),new te(C.findField(a.associations.fields,Ie)),P,le,Z,se],extraFilter:h?b.create(h,a.associations.getFieldsIndex(),a.associations.dateFieldsTimeZoneDefaultUTC):null})})},s.signatures.push({name:"featuresetbyassociation",min:2,max:6}),s.functions.groupby=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,3,3,t,i),!x(e[0]))throw new c(t,m.InvalidParameter,i);const n=await e[0].load(),l=[],r=[];let y=!1,f=[];if($(e[1]))f.push(e[1]);else if(e[1]instanceof v)f.push(e[1]);else if(A(e[1]))f=e[1];else{if(!U(e[1]))throw new c(t,m.InvalidParameter,i);f=e[1].toArray()}for(const a of f)if($(a)){const o=b.create(N(a),n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC),u=ye(o)===!0?N(a):"%%%%FIELDNAME";l.push({name:u,expression:o}),u==="%%%%FIELDNAME"&&(y=!0)}else{if(!(a instanceof v))throw new c(t,m.InvalidParameter,i);{const o=a.hasField("name")?a.field("name"):"%%%%FIELDNAME",u=a.hasField("expression")?a.field("expression"):"";if(o==="%%%%FIELDNAME"&&(y=!0),!o)throw new c(t,m.InvalidParameter,i);l.push({name:o,expression:b.create(u||o,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC)})}}if(f=[],$(e[2]))f.push(e[2]);else if(A(e[2]))f=e[2];else if(U(e[2]))f=e[2].toArray();else{if(!(e[2]instanceof v))throw new c(t,m.InvalidParameter,i);f.push(e[2])}for(const a of f){if(!(a instanceof v))throw new c(t,m.InvalidParameter,i);{const o=a.hasField("name")?a.field("name"):"",u=a.hasField("statistic")?a.field("statistic"):"",w=a.hasField("expression")?a.field("expression"):"";if(!o||!u||!w)throw new c(t,m.InvalidParameter,i);r.push({name:o,statistic:u.toLowerCase(),expression:b.create(w,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC)})}}if(y){const a={};for(const u of n.fields)a[u.name.toLowerCase()]=1;for(const u of l)u.name!=="%%%%FIELDNAME"&&(a[u.name.toLowerCase()]=1);for(const u of r)u.name!=="%%%%FIELDNAME"&&(a[u.name.toLowerCase()]=1);let o=0;for(const u of l)if(u.name==="%%%%FIELDNAME"){for(;a["field_"+o.toString()]===1;)o++;a["field_"+o.toString()]=1,u.name="FIELD_"+o.toString()}}for(const a of l)await ie(a.expression,s,t);for(const a of r)await ie(a.expression,s,t);return e[0].groupby(l,r)})},s.signatures.push({name:"groupby",min:3,max:3}),s.functions.distinct=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(x(e[0])){E(e,2,2,t,i);const n=await e[0].load(),l=[];let r=[];if($(e[1]))r.push(e[1]);else if(e[1]instanceof v)r.push(e[1]);else if(A(e[1]))r=e[1];else{if(!U(e[1]))throw new c(t,m.InvalidParameter,i);r=e[1].toArray()}let y=!1;for(const f of r)if($(f)){const a=b.create(N(f),n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC),o=ye(a)===!0?N(f):"%%%%FIELDNAME";l.push({name:o,expression:a}),o==="%%%%FIELDNAME"&&(y=!0)}else{if(!(f instanceof v))throw new c(t,m.InvalidParameter,i);{const a=f.hasField("name")?f.field("name"):"%%%%FIELDNAME",o=f.hasField("expression")?f.field("expression"):"";if(a==="%%%%FIELDNAME"&&(y=!0),!a)throw new c(t,m.InvalidParameter,i);l.push({name:a,expression:b.create(o||a,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC)})}}if(y){const f={};for(const o of n.fields)f[o.name.toLowerCase()]=1;for(const o of l)o.name!=="%%%%FIELDNAME"&&(f[o.name.toLowerCase()]=1);let a=0;for(const o of l)if(o.name==="%%%%FIELDNAME"){for(;f["field_"+a.toString()]===1;)a++;f["field_"+a.toString()]=1,o.name="FIELD_"+a.toString()}}for(const f of l)await ie(f.expression,s,t);return e[0].groupby(l,[])}return He(e)})},s.functions.getfeaturesetinfo=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,1,1,t,i),!x(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?v.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},ue(t),!1,!1):null})},s.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),s.functions.filterbysubtypecode=function(t,i){return s.standardFunctionAsync(t,i,async(p,F,e)=>{if(E(e,2,2,t,i),x(e[0])){const n=await e[0].load(),l=e[1];if(!xe(l))throw new c(t,m.InvalidParameter,i);if(n.subtypeField){const y=b.create(`${n.subtypeField}= ${e[1]}`,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC);return new B({parentfeatureset:e[0],whereclause:y})}if(n.typeIdField===null||n.typeIdField==="")throw new c(t,m.FeatureSetDoesNotHaveSubtypes,i);const r=b.create(`${n.typeIdField}= ${e[1]}`,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC);return new B({parentfeatureset:e[0],whereclause:r})}throw new c(t,m.InvalidParameter,i)})},s.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{Ge as registerFunctions};
