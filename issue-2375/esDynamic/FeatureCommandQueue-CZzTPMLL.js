import{J as w,K as S,L as bt,P as ne,M as vt,N as W,R as _,T as Q,U as ce,V as n,X as G,Y as V,_ as gt,a0 as xt,a1 as A,a2 as b,a3 as q,a4 as $e,a5 as Fi,a6 as we,a7 as J,a8 as pe,a9 as Me,aa as Pe,ab as Ae,ac as We,ad as wt,ae as Ke,e as E,af as St,ag as Ii,ah as Ci,ai as Oi,aj as Ei,ak as Di,al as Li,am as Bi,an as ee,ao as Vt,ap as je,aq as Xe,ar as _t,as as zt,at as Tt,au as D,av as Mt,aw as Pt,ax as Ze,ay as ki,az as ie,aA as At,aB as Ye,aC as Rt,aD as Ni,aE as Se,aF as Ft,aG as Hi,aH as It,aI as Qe,aJ as Ui,aK as Gi,F as qi,H as $i,aL as Ct,aM as Ot,aN as Et,aO as Dt,aP as Lt,aQ as Bt,aR as Je,aS as kt,aT as Wi,aU as Nt,aV as et,aW as Ht,aX as tt,aY as Ki,aZ as ji,D as Xi,E as Zi,q as Yi,a_ as Qi,a$ as Ji,b0 as es,b1 as ts,b2 as is,b3 as ss,b4 as as,b5 as os,b6 as se,b7 as de,b8 as ae,p as Ve,b9 as rs,b as ns,d as ls}from"./UpdateTracking2D-Dbow3jYu.js";import{O as c,pJ as R,kZ as us,s as Re,fh as Ut,D as Gt,aQ as cs,l_ as it,jw as qt,cN as fe,bo as ps,oR as ds,pB as fs,$ as hs,nj as ms,eI as ys}from"./main-C02UbYD7.js";import{a as H,J as $t,K as bs,c as Wt,U as vs,p as gs}from"./definitions-Doe0g1C2.js";import{E as le,S as ue,f as st,p as M,y as C,d as F,M as L,e as xs,g as $,w as Fe,L as Ie}from"./Container-opHDNgle.js";import{C as K,F as Kt,L as he,D as at,B as jt,E as ws,U as Ce,_ as ot,G as me,P as Xt,O as Ss,I as rt}from"./enums-DDkmfb-t.js";import{c as Zt,s as Vs,i as Yt,E as Qt}from"./Program-kooLQgoA.js";import{o as _s}from"./ProgramTemplate-zI547AoJ.js";import{t as zs}from"./VertexElementDescriptor-BAy1DPb3.js";import{a as Jt}from"./LabelMetric-BYq7UFJE.js";import{e as Oe,c as ei}from"./Texture-BNs5xfWp.js";import{o as Ts}from"./constants-DVpDF9P6.js";import{c as ti}from"./WGLContainer-DpYvmPLF.js";let Ms=class{constructor(){this.drawPhase=le.MAP|le.HITTEST|le.HIGHLIGHT|le.DEBUG}startup(){}shutdown(e){}},B=class extends Ms{constructor(){super(...arguments),this.overrideStencilRef=null,this.symbologyPlane=ue.FILL,this.postProcessingEnabled=!1}postProcess(e,t){}},ii=class extends bt{};c([w(0,b)],ii.prototype,"pos",void 0);let Ps=class extends we{},si=class extends ne{};c([S(n)],si.prototype,"dotSize",void 0);let Ee=class extends ne{};c([S(q)],Ee.prototype,"locations",void 0),c([S(n)],Ee.prototype,"pixelRatio",void 0),c([S(n)],Ee.prototype,"tileZoomFactor",void 0);const As=1e-6;class ye extends vt{vertex(t){const s=new W(1,0,0,0,-1,0,0,1,1).multiply(new _(t.pos.xy.divide(H),1)),i=Q(this.draw.locations,s.xy),a=ce(this.instance.dotSize.divide(2),new n(1));let o=new n(0);o=o.add(G(i.a,new n(As)).multiply(2));let r=a.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new _(t.pos.add(.5),1)),u=new V(l.xy,o,1),p=this.instance.dotSize.divide(r),d=new n(-1).divide(a.divide(r));return r=r.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:r,color:i,ratio:p,invEdgeRatio:d}}fragment(t){const s=gt(t.glPointCoord.subtract(.5)).multiply(2),i=xt(new n(0),new n(1),t.invEdgeRatio.multiply(s.subtract(t.ratio)).add(1)),a=new $e;return a.glFragColor=t.color.multiply(i),a}}c([S(si)],ye.prototype,"instance",void 0),c([S(Ee)],ye.prototype,"draw",void 0),c([S(Fi)],ye.prototype,"view",void 0),c([R(0,A(ii))],ye.prototype,"vertex",null),c([R(0,A(Ps))],ye.prototype,"fragment",null);class ai extends Me{}c([w(3,n)],ai.prototype,"inverseArea",void 0);let De=class extends ne{};c([S(J.ofType(V,2))],De.prototype,"isActive",void 0),c([S(J.ofType(V,8))],De.prototype,"colors",void 0),c([S(n)],De.prototype,"dotValue",void 0);let be=class extends ne{};c([S(q)],be.prototype,"dotTexture0",void 0),c([S(q)],be.prototype,"dotTexture1",void 0),c([S(n)],be.prototype,"tileZoomFactor",void 0),c([S(n)],be.prototype,"pixelRatio",void 0),c([S(n)],be.prototype,"tileDotsOverArea",void 0);let ve=class extends Pe{_dotThreshold(e,t,s){return e.divide(t).divide(s)}vertex(e){const t=new W(2/H,0,0,0,-2/H,0,-1,1,1).multiply(new _(e.pos,1)),s=this.clip(e.id),i=new V(t.xy,s,1),a=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),r=this.draw.tileZoomFactor.multiply(H).divide(this.draw.pixelRatio),l=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),u=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),p=e.pos.add(.5).divide(r);return{glPosition:i,color:new V(0,0,0,0),textureCoords:p,thresholds0:l,thresholds1:u}}fragment(e){const t=new $e,s=Q(this.draw.dotTexture0,e.textureCoords),i=Q(this.draw.dotTexture1,e.textureCoords),a=e.thresholds0.subtract(s),o=e.thresholds1.subtract(i);let r;const l=Ae.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),u=Ae.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const p=G(new n(0),a),d=G(new n(0),o),f=We(p,a).add(We(d,o)),h=G(f,new n(0)),v=new n(1).subtract(h),m=f.add(h),y=a.multiply(p).divide(m),g=o.multiply(d).divide(m),x=l.multiply(y).add(u.multiply(g));r=v.multiply(x)}else{const p=ce(wt(a),wt(o)),d=G(p,new n(0)),f=new n(1).subtract(d),h=G(p,a),v=G(p,o),m=l.multiply(h).add(u.multiply(v));r=f.multiply(m)}return t.glFragColor=r,t}hittest(e){return Ke(this.hittestRequest)}};c([pe],ve.prototype,"blending",void 0),c([S(De)],ve.prototype,"instance",void 0),c([S(be)],ve.prototype,"draw",void 0),c([R(0,A(ai))],ve.prototype,"vertex",null),c([R(0,A(we))],ve.prototype,"fragment",null);const nt={[K.BYTE]:1,[K.UNSIGNED_BYTE]:1,[K.SHORT]:2,[K.UNSIGNED_SHORT]:2,[K.HALF_FLOAT]:2,[K.INT]:4,[K.UNSIGNED_INT]:4,[K.FLOAT]:4};let Rs=class{constructor(e,t){this._boundPart=null;const s=[];for(const a of t.vertex){const o=Zt.createVertex(e,Kt.STATIC_DRAW,a);s.push(o)}const i=[];for(const a of t.index||[]){const o=Zt.createIndex(e,Kt.STATIC_DRAW,a);i.push(o)}this.groups=[];for(const a of t.groups){let o;if(a.index!=null){if(!t.index)throw new Error("No index data.");const{BYTES_PER_ELEMENT:f}=t.index[a.index];f===2?o=K.UNSIGNED_SHORT:f===4&&(o=K.UNSIGNED_INT)}const r=a.index!=null?i[a.index]:null,l=new Map,u={},p={};for(const f of a.attributes){const{name:h,count:v,type:m,offset:y,normalized:g,divisor:x,stride:k,vertex:U,location:Y}=f,T=`vertex-buffer-${U}`;let P=u[T];P||(P=u[T]=[]);const I=new zs(h,v,m,y,k,g,x);P.push(I),l.set(h,Y),p[T]=s[U]}const d=new _s(e,l,u,p,r);this.groups.push({...a,vertexArray:d,locations:l,layout:u,indexing:o})}this.parts=t.parts}bind(e,t){this._boundPart=t;const{group:s}=this.parts[this._boundPart],{vertexArray:i}=this.groups[s];e.bindVAO(i)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:t,count:s}=this.parts[this._boundPart],{group:i}=this.parts[this._boundPart],{indexing:a,primitive:o}=this.groups[i];a?e.drawElements(o,s,a,t*nt[a]):e.drawArrays(o,t,s)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArray:e}of this.groups)e.dispose()}},Fs=class Ai extends Rs{static create(t,s){const i=[];let{stride:a,hash:o}=s.layout;if(a==null){a=0;for(const{count:h,type:v,offset:m}of s.layout.attributes){if(m!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");a+=h*nt[v]}}let r=0,l=0;for(const{count:h,name:v,offset:m,type:y,normalized:g}of s.layout.attributes){m!=null&&(l=m);const x={name:v,location:r,vertex:0,count:h,type:y,offset:l,stride:a,divisor:0,normalized:g!=null&&g};i.push(x),r++,l+=h*nt[y]}const u={attributes:i,primitive:s.primitive};s.index!=null&&(u.index=0);let{count:p}=s;if(p==null&&(p=s.index?s.index.length:s.vertex.byteLength/a,Math.floor(p)!==p))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${a}.`);const d={start:0,count:p,group:0,primitive:s.primitive},f={vertex:[s.vertex],parts:[d],groups:[u]};return s.index!=null&&(f.index=[s.index]),o==null&&(o=Jt(i)),new Ai(t,f,{hash:o,attributes:i,stride:a})}constructor(t,s,i){super(t,s),this.layout=i}bind(t,s=0){super.bind(t,s)}},Is=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){const t=H,s=H,i=new Oe(t,s);i.samplingMode=he.NEAREST,i.wrapMode=at.CLAMP_TO_EDGE;const a=new Vs(e,new Yt(jt.DEPTH_STENCIL,t,s));this._dotFBO=new Qt(e,i,a)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){const t=H,s=t*t,i=2,a=new Int16Array(s*i);for(let l=0;l<t;l++)for(let u=0;u<t;u++)a[i*(u+l*t)]=u,a[i*(u+l*t)+1]=l;const o=[{count:2,type:K.UNSIGNED_SHORT,name:"a_position",offset:0}],r={hash:Jt(o),attributes:o,stride:4};this._dotMesh=Fs.create(e,{primitive:ws.POINTS,vertex:a,count:s,layout:r})}return this._dotMesh}getDotDensityTextures(e,t,s){if(this._dotTextureSize===t&&this._seed===s||(this._disposeTextures(),this._dotTextureSize=t,this._seed=s),this._dotTextures===null){const i=new us(s);this._dotTextures=[this._allocDotDensityTexture(e,t,i),this._allocDotDensityTexture(e,t,i)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,s){const i=new Float32Array(t*t*4);for(let o=0;o<i.length;o++)i[o]=s.getFloat();const a=new Oe;return a.dataType=Ce.FLOAT,a.samplingMode=he.NEAREST,a.width=t,a.height=t,new ei(e,a,i)}},Cs=class extends B{constructor(){super(...arguments),this.type=E.DotDensity,this.shaders={polygon:new ve,point:new ye,fill:new St},this._resources=new Map}render(e,t){st(e)||M(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:s}=e;s.setShader({shader:this.shaders.fill,uniforms:{...C(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...F(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:M(e)}),s.setPipelineState(L(e)),s.submitDraw(e,t)}_renderDotDensity(e,t){const{context:s,painter:i,requiredLevel:a}=e,o=t.instance.getInput().uniforms,r=this._getOrCreateResourcesRecord(s),l=r.getDotDensityTextures(s,H,o.seed),u=1/2**(a-t.target.key.level),p=H,d=p*window.devicePixelRatio*p*window.devicePixelRatio,f=1/u*(1/u),h=o.dotScale?e.state.scale/o.dotScale:1,v=o.dotValue*h*f;i.setShader({shader:this.shaders.polygon,uniforms:{...C(e,t.target),instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,v)},draw:{dotTexture0:{unit:$t,texture:l[0]},dotTexture1:{unit:bs,texture:l[1]},tileZoomFactor:u,pixelRatio:window.devicePixelRatio,tileDotsOverArea:d/(H*window.devicePixelRatio*H*window.devicePixelRatio)}},defines:{...F(e),blending:o.blending},optionalAttributes:{},useComputeBuffer:!1}),i.setPipelineState(L(e));const m=s.getViewport();s.setViewport(0,0,H,H);const y=s.getBoundFramebufferObject(),g=r.getFBO(s);s.bindFramebuffer(g),s.setClearColor(0,0,0,0),i.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),i.updatePipelineState(s),s.clear(ot.COLOR_BUFFER_BIT),i.submitDraw(e,t),s.bindFramebuffer(y),s.setViewport(m.x,m.y,m.width,m.height);const x=r.getFBO(s).colorTexture;i.setShader({shader:this.shaders.point,uniforms:{view:xs(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:$t,texture:x},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...F(e)},optionalAttributes:{},useComputeBuffer:!1}),i.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),i.submitDrawMesh(s,r.getDotDensityMesh(s))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Is,this._resources.set(e,t)),t}},Os=class extends B{constructor(){super(...arguments),this.type=E.ComplexFill,this.shaders={geometry:new Ii}}render(e,t){const{context:s,painter:i}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,a.uniforms),...C(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:Fe(t.target)},defines:{...F(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:M(e)}),i.setPipelineState(L(e)),i.submitDraw(e,t)}};function _e(e){const t=1/e;return{antialiasing:t,blur:0+t}}let Es=class extends B{constructor(){super(...arguments),this.type=E.ComplexOutlineFill,this.shaders={geometry:new Ci}}render(e,t){const{context:s,painter:i,pixelRatio:a}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,o.uniforms),...C(e,t.target),antialiasingControls:_e(a),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:Fe(t.target)},defines:{...F(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:M(e)}),i.setPipelineState(L(e)),i.submitDraw(e,t)}},Ds=class extends B{constructor(){super(...arguments),this.type=E.Fill,this.shaders={geometry:new St}}render(e,t){const{painter:s}=e,i=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,i.uniforms),...C(e,t.target)},defines:F(e),optionalAttributes:i.optionalAttributes,useComputeBuffer:M(e)}),s.setPipelineState(L(e)),s.submitDraw(e,t)}},Ls=class extends B{constructor(){super(...arguments),this.type=E.OutlineFill,this.shaders={geometry:new Oi}}render(e,t){const{painter:s,pixelRatio:i}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,a.uniforms),...C(e,t.target),antialiasingControls:_e(i)},defines:{...F(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:M(e)}),s.setPipelineState(L(e)),s.submitDraw(e,t)}},Bs=class extends B{constructor(){super(...arguments),this.type=E.PatternFill,this.shaders={geometry:new Ei}}render(e,t){const{context:s,painter:i}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,a.uniforms),...C(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:Fe(t.target)},defines:{...F(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:M(e)}),i.setPipelineState(L(e)),i.submitDraw(e,t)}},ks=class extends B{constructor(){super(...arguments),this.type=E.PatternOutlineFill,this.shaders={geometry:new Di}}render(e,t){const{context:s,painter:i,pixelRatio:a}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,o.uniforms),...C(e,t.target),antialiasingControls:_e(a),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey),localTileOffset:Fe(t.target)},defines:{...F(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:M(e)}),i.setPipelineState(L(e)),i.submitDraw(e,t)}},oi=class{constructor(e,t,s,i){this.dataType=e,this.samplingMode=t,this.pixelFormat=s,this.internalFormat=i}};function Ns(e,t){const{textureFloatLinear:s,colorBufferFloat:i}=e.capabilities,a=i?.textureFloat,o=i?.textureHalfFloat,r=i?.floatBlend,l=e.driverTest.floatBufferBlend.result;if(!a&&!o)throw new Re("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(r&&l||o))throw new Re("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(l?"":" This device claims support for EXT_float_blend, but does not actually support it."));const u=a&&r&&l,p=o,d=s,f=!!i?.R32F,h=!!i?.R16F;if(u&&d)return d||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new oi(Ce.FLOAT,d?he.LINEAR:he.NEAREST,f?me.RED:me.RGBA,f?Xt.R32F:me.RGBA);if(p)return new oi(Ce.HALF_FLOAT,he.LINEAR,h?me.RED:me.RGBA,h?Xt.R16F:me.RGBA);throw new Re("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}const Hs=()=>Gt.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");let Us=class{destroy(){this._accumulateFramebuffer=Ut(this._accumulateFramebuffer),this._resolveGradientTexture=Ut(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){const t=Ns(e,Hs());this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==Ce.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,s){if(this._accumulateFramebuffer==null){const{dataType:i,samplingMode:a,pixelFormat:o,internalFormat:r}=this.loadQualityProfile(e),l=new Oe(t,s);l.pixelFormat=o,l.internalFormat=r,l.dataType=i,l.samplingMode=a,l.wrapMode=at.CLAMP_TO_EDGE;const u=new Yt(jt.DEPTH_STENCIL,t,s);this._accumulateFramebuffer=new Qt(e,l,u)}else{const{width:i,height:a}=this._accumulateFramebuffer;i===t&&a===s||this._accumulateFramebuffer.resize(t,s)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,s){if(this._resolveGradientTexture==null){const i=new Oe;i.wrapMode=at.CLAMP_TO_EDGE,this._resolveGradientTexture=new ei(e,i)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(s.length/4,1),this._resolveGradientTexture.setData(s),this._prevGradientHash=t);return this._resolveGradientTexture}};function ri(e){return e?.25:1}let ni=class extends Me{};c([w(5,b)],ni.prototype,"offset",void 0);let Gs=class extends we{},lt=class extends ne{};c([S(n)],lt.prototype,"radius",void 0),c([S(n)],lt.prototype,"isFieldActive",void 0);class ze extends Pe{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(t){const{radius:s,isFieldActive:i}=this.kernelControls,a=t.offset,o=i.multiply(this.storage.getVVData(t.id).x).add(new n(1).subtract(i)),r=this.view.displayViewScreenMat3.multiply(new _(t.pos,1)).add(this.view.displayViewMat3.multiply(new _(a,0)).multiply(s)),l=this.clip(t.id);return{glPosition:new V(r.xy,l,1),offset:a,fieldValue:o,color:new V(0),...this.maybeRunHittest(t,{},null)}}fragment(t){const{offset:s,fieldValue:i}=t,a=gt(s),o=G(a,new n(1)),r=new n(1).subtract(a.multiply(a)),l=r.multiply(r),u=o.multiply(l).multiply(i).multiply(new n(ri(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new V(u),t)}hittest(t){const{viewMat3:s,tileMat3:i}=this.view,a=s.multiply(i).multiply(new _(t.pos,1));return Li(a.xy,this.kernelControls.radius,this.hittestRequest.position)}}c([pe],ze.prototype,"usesHalfFloatPrecision",void 0),c([S(lt)],ze.prototype,"kernelControls",void 0),c([R(0,A(ni))],ze.prototype,"vertex",null),c([R(0,A(Gs))],ze.prototype,"fragment",null);let li=class extends bt{};c([w(0,b)],li.prototype,"pos",void 0);let qs=class extends Bi{},Le=class extends ne{};c([S(q)],Le.prototype,"texture",void 0),c([S(b)],Le.prototype,"minAndInvRange",void 0),c([S(n)],Le.prototype,"normalization",void 0);let ui=class extends ne{};c([S(q)],ui.prototype,"texture",void 0);let ge=class extends vt{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new V(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){const{accumulatedDensity:t,gradient:s}=this;let i=Q(t.texture,e.uv).r.multiply(new n(ri(this.usesHalfFloatPrecision)));i=i.multiply(t.normalization),i=i.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const a=Q(s.texture,new b(i,.5)),o=new $e;return o.glFragColor=new V(a.rgb.multiply(a.a),a.a),o}};c([pe],ge.prototype,"usesHalfFloatPrecision",void 0),c([S(Le)],ge.prototype,"accumulatedDensity",void 0),c([S(ui)],ge.prototype,"gradient",void 0),c([R(0,A(li))],ge.prototype,"vertex",null),c([R(0,A(qs))],ge.prototype,"fragment",null);let $s=class extends B{constructor(){super(...arguments),this.type=E.Heatmap,this.shaders={accumulate:new ze,resolve:new ge},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=ci}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:s,painter:i,state:a}=e,o=t.instance.getInput(),{isFieldActive:r}=o.uniforms,l=this._getOrCreateResourcesRecord(s),u=l.loadQualityProfile(s);if(st(e))return;M(e)||this._bind(e,l,o),i.setShader({shader:this.shaders.accumulate,uniforms:{...C(e,t.target),kernelControls:{radius:di(o,a),isFieldActive:r?1:0}},defines:{...F(e),...u.defines},optionalAttributes:{},useComputeBuffer:M(e)});const p=M(e)?Ks:pi;i.setPipelineState(p),i.submitDraw(e,t)}postProcess(e,t){if(M(e)||st(e))return;const{context:s,painter:i}=e,a=this._resources.get(s);if(this._prevFBO==null||this._prevViewport==null||!a?.initialized)return;const{defines:o}=a.loadQualityProfile(s),{minDensity:r,maxDensity:l,radius:u}=t.getInput().uniforms,p=8,d=9,f=a.accumulateFramebuffer,h=a.resolveGradientTexture;i.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:p,texture:f.colorTexture},minAndInvRange:[r,1/(l-r)],normalization:3/(u*u*Math.PI)},gradient:{texture:{unit:d,texture:h}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),s.bindFramebuffer(this._prevFBO),s.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),s.bindTexture(f.colorTexture,p),s.bindTexture(h,d),i.setPipelineState(js),i.submitDrawQuad(s),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Us,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,s){if(this._isBound)return;const{context:i,state:a,pixelRatio:o}=e,r=i.getBoundFramebufferObject(),l=i.getViewport();this._prevFBO=r,this._prevViewport=l;const{gradient:u,gradientHash:p}=s.uniforms;t.ensureResolveGradientTexture(i,p,u);const{width:d,height:f}=l,h=Ws(di(s,a),o),v=d*h,m=f*h,y=t.ensureAccumulateFBO(i,v,m);i.blitFramebuffer(r,y,0,0,r.width,r.height,0,0,y.width,y.height,ot.STENCIL_BUFFER_BIT,he.NEAREST),i.bindFramebuffer(y),i.setViewport(0,0,y.width,y.height),i.setColorMask(!0,!0,!0,!0),i.setClearColor(0,0,0,0),i.clear(ot.COLOR_BUFFER_BIT),this._isBound=!0}};function Ws(e,t){const s=t>1.5?.25:.5;return e<1/(2*s)?1:s}function ci(e){return e.key.level+1}const pi={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:ci,compare:Ss.GEQUAL,mask:255,op:{fail:rt.KEEP,zFail:rt.KEEP,zPass:rt.REPLACE}}}},Ks={...pi,stencil:!1},js={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function di(e,t){const{referenceScale:s,radius:i}=e.uniforms;return i*(s!==0?s/t.scale:1)}let ut=class extends ne{getVVRotationMat4(e){return ee(Vt(e),Ae.identity(),()=>{const t=this._getNormalizedAngle(e).multiply(_t),s=zt(t),i=Tt(t);return new Ae(i,s,0,0,s.multiply(new n(-1)),i,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return ee(Vt(e),W.identity(),()=>{const t=this._getNormalizedAngle(e).multiply(_t),s=zt(t),i=Tt(t);return new W(i,s,0,s.multiply(new n(-1)),i,0,0,0,1)})}_getNormalizedAngle(e){const t=je(this.rotationType,new n(Xe.Arithmatic));return ee(t,new n(90).subtract(e),e)}};c([S(n)],ut.prototype,"rotationType",void 0);const Xs=360/254;let j=class extends Me{};c([w(3,V)],j.prototype,"color",void 0),c([w(4,b)],j.prototype,"offset",void 0),c([w(5,b)],j.prototype,"textureUV",void 0),c([w(6,n)],j.prototype,"fontSize",void 0),c([w(7,n)],j.prototype,"referenceSize",void 0),c([w(8,n)],j.prototype,"haloFontSize",void 0),c([w(9,V)],j.prototype,"haloColor",void 0),c([w(10,b)],j.prototype,"zoomRange",void 0),c([w(11,n)],j.prototype,"clipAngle",void 0),c([w(12,V)],j.prototype,"referenceSymbol",void 0);let ct=class extends Mt{};c([w(13,b)],ct.prototype,"offsetNextVertex1",void 0),c([w(14,b)],ct.prototype,"offsetNextVertex2",void 0);let Zs=class extends we{},O=class extends Pe{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,s){const i=t.multiply(Xs),a=Pt(this.view.rotation.subtract(i)),o=Ze(new n(360).subtract(a),a);let r=new n(0);const l=ki(this.view.currentZoom.multiply(Wt)).divide(Wt),u=e.x,p=e.y,d=new n(1).subtract(G(u,l)).multiply(2),f=G(new n(90),o).multiply(2),h=new n(2).multiply(new n(1).subtract(G(l,p)));return r=r.add(s.multiply(d)),r=r.add(s.multiply(f)),r=r.add(h),r}vertex(e,t){const s=ie(e.bitset,qi),i=new n(1).subtract(s);let a=e.fontSize,o=a.divide(At);const r=this.isHaloPass?e.haloColor:this._getVertexColor(e),l=this.isLabel?this.storage.getAnimationValue(e.id):new n(1),u=this.isLabel?r.multiply(l):r,p=this.view.displayViewScreenMat3.multiply(new _(e.pos,1));let d=e.offset,f=new n(1),h=W.identity(),v=new b(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const T=e.referenceSymbol,P=T.xy,I=T.z,N=this._unpackDirection(T.w),z=Ye(this,e.id,I).divide(2),qe=N.multiply(z.add(vs));v=P.add(qe),d=d.add(v)}else f=Ye(this,e.id,e.referenceSize).divide(e.referenceSize),a=a.multiply(f),o=o.multiply(f),d=d.multiply(f),h=Rt(this,e.id),d=h.multiply(new _(d,0)).xy;const m=ie(e.bitset,$i),y=this._getViewRotationMatrix(m).multiply(new _(d,0));let g=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,m):this.clip(e.id,e.zoomRange);g=this.isBackgroundPass?g.add(i.multiply(2)):g.add(s.multiply(2));const x=this.isLabel?Ni(Se(g,new n(1)),je(l,new n(0))):new Ft(!1),k=new V(p.xy.add(y.xy),g,1),U=e.textureUV.divide(this.mosaicInfo.size);let Y=new n(0);return this.isHaloPass&&(Y=e.haloFontSize.divide(o).divide(Hi)),{glPosition:k,color:u,size:o,textureUV:U,antialiasingWidth:new n(.105*At).divide(a).divide(this.view.pixelRatio),haloDistanceOffset:Y,...this.maybeRunHittest(e,t,{vvSizeAdjustment:f,vvRotation:h,labelOffset:v,labelClipped:x})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,s=this.view.displayMat3,i=new n(1).subtract(e);return t.multiply(e).add(s.multiply(i))}fragment(e){const t=new n(.25),s=new n(1).subtract(t),i=Q(this.mosaicInfo.texture,e.textureUV).a;let a=s.subtract(e.haloDistanceOffset);this.highlight&&(a=a.divide(2));const o=e.antialiasingWidth,r=xt(a.subtract(o),a.add(o),i);return this.getFragmentOutput(e.color.multiply(r),e)}hittest(e,t,{vvSizeAdjustment:s,vvRotation:i,labelOffset:a,labelClipped:o}){let r,l,u;this.isLabel?(r=new _(e.offset.add(a),0),l=new _(t.offsetNextVertex1.add(a),0),u=new _(t.offsetNextVertex2.add(a),0)):(r=i.multiply(new _(e.offset.multiply(s),0)),l=i.multiply(new _(t.offsetNextVertex1.multiply(s),0)),u=i.multiply(new _(t.offsetNextVertex2.multiply(s),0)));const{viewMat3:p,tileMat3:d}=this.view,f=p.multiply(d).multiply(new _(e.pos,1)),h=f.add(d.multiply(r)).xy,v=f.add(d.multiply(l)).xy,m=f.add(d.multiply(u)).xy,y=It(this.hittestRequest.position,h.xy,v.xy,m.xy);return this.isLabel?ee(o,Ke(this.hittestRequest),y):y}_unpackDirection(e){const t=new Qe(e),s=Ui(t,new Qe(2)),i=Gi(t,new Qe(3));return new b(new n(s).subtract(1),new n(i).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const s=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(s,e.color,new Ft(!1))}if(this.visualVariableOpacity){const s=this.storage.getOpacityValue(e.id),i=this.visualVariableOpacity.getOpacity(s);t=t.multiply(i)}return t}};c([D(Ct)],O.prototype,"visualVariableColor",void 0),c([D(Ot)],O.prototype,"visualVariableOpacity",void 0),c([D(ut)],O.prototype,"visualVariableRotation",void 0),c([D(Et)],O.prototype,"visualVariableSizeMinMaxValue",void 0),c([D(Dt)],O.prototype,"visualVariableSizeScaleStops",void 0),c([D(Lt)],O.prototype,"visualVariableSizeStops",void 0),c([D(Bt)],O.prototype,"visualVariableSizeUnitValue",void 0),c([S(Je)],O.prototype,"mosaicInfo",void 0),c([pe],O.prototype,"isHaloPass",void 0),c([pe],O.prototype,"isBackgroundPass",void 0),c([pe],O.prototype,"isLabel",void 0),c([R(0,A(j)),R(1,A(ct))],O.prototype,"vertex",null),c([R(0,A(Zs))],O.prototype,"fragment",null);let Ys=class extends B{constructor(){super(...arguments),this.type=E.Label,this.shaders={geometry:new O},this.drawPhase=le.LABEL|le.LABEL_ALPHA|le.HITTEST,this.symbologyPlane=ue.TEXT}render(e,t){const{context:s,painter:i}=e,a=F(e),o={...L(e)},r=t.instance.getInput(),l={shader:this.shaders.geometry,uniforms:{...$(e,t.target,r.uniforms),...C(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!0},optionalAttributes:r.optionalAttributes,useComputeBuffer:M(e)};i.setShader(l),i.setPipelineState(o),i.submitDraw(e,t),i.setShader({...l,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!0}}),i.setPipelineState(o),i.submitDraw(e,t),i.setShader({...l,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!0}}),i.setPipelineState(o),i.submitDraw(e,t)}},Qs=class extends B{constructor(){super(...arguments),this.type=E.Line,this.shaders={geometry:new kt},this.symbologyPlane=ue.LINE}render(e,t){const{painter:s,pixelRatio:i}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,a.uniforms),...C(e,t.target),antialiasingControls:_e(i)},defines:{...F(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:M(e)}),s.setPipelineState(L(e)),s.submitDraw(e,t)}};class Be extends Wi{}c([w(9,n)],Be.prototype,"accumulatedDistance",void 0),c([w(10,b)],Be.prototype,"segmentDirection",void 0),c([w(11,V)],Be.prototype,"tlbr",void 0);class pt extends kt{_getLineWidthRatio(t,s){const i=new n(Ts),a=ie(t.bitset,Xi);return a.multiply(ce(s,new n(.25))).add(new n(1).subtract(a)).divide(i)}_getSDFAlpha(t){const{halfWidth:s,normal:i,tlbr:a,patternSize:o,accumulatedDistance:r,lineWidthRatio:l}=t,u=o.x.multiply(new n(2)).multiply(l),p=Nt(r.divide(u)),d=new n(.25).multiply(i.y).add(new n(.5)),f=et(a.xy,a.zw,new b(p,d)),h=Ht(Q(this.mosaicInfo.texture,f)).subtract(new n(.5)).multiply(s),v=tt(new n(.5).subtract(h),new n(0),new n(1));return new V(v)}_getPatternColor(t){const{halfWidth:s,normal:i,color:a,accumulatedDistance:o,patternSize:r,sampleAlphaOnly:l,tlbr:u}=t,p=r.y.multiply(new n(2).multiply(s).divide(r.x)),d=Nt(o.divide(p)),f=new n(.5).multiply(i.y).add(new n(.5)),h=et(u.xy,u.zw,new b(f,d));let v=Q(this.mosaicInfo.texture,h);return this.visualVariableColor!=null&&(v=ee(Se(l,new n(.5)),new V(a.a),a)),v}vertex(t,s){const{segmentDirection:i,tlbr:a,bitset:o}=t,r=Ki(this,t),l=t.accumulatedDistance.divide(this.view.displayZoomFactor).add(We(i,r.scaledOffset)),u=new b(a.z.subtract(a.x),a.w.subtract(a.y)),p=a.divide(this.mosaicInfo.size.xyxy),d=ie(o,Zi),f=ie(o,Yi),h=ee(Se(d,new n(.5)),this._getLineWidthRatio(t,r.scaledHalfWidth),new n(1));return{...r,tlbr:p,patternSize:u,accumulatedDistance:l,isSDF:d,sampleAlphaOnly:f,lineWidthRatio:h,...this.maybeRunHittest(t,s,r.halfWidth)}}fragment(t){const{color:s,opacity:i,isSDF:a}=t,o=ji(t,this.antialiasingControls.blur),r=ee(Se(a,new n(.5)),this._getSDFAlpha(t),this._getPatternColor(t)),l=s.multiply(i).multiply(o).multiply(r);return this.getFragmentOutput(l,t)}}c([S(Je)],pt.prototype,"mosaicInfo",void 0),c([R(0,A(Be)),R(1,A(Qi))],pt.prototype,"vertex",null);let Js=class extends B{constructor(){super(...arguments),this.type=E.TexturedLine,this.shaders={geometry:new pt},this.symbologyPlane=ue.LINE}render(e,t){const{context:s,painter:i,pixelRatio:a}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,o.uniforms),...C(e,t.target),antialiasingControls:_e(a),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey)},defines:{...F(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:M(e)}),i.setPipelineState(L(e)),i.submitDraw(e,t)}};class oe extends Me{}c([w(3,V)],oe.prototype,"color",void 0),c([w(4,V)],oe.prototype,"outlineColor",void 0),c([w(5,b)],oe.prototype,"offset",void 0),c([w(6,b)],oe.prototype,"textureUV",void 0),c([w(7,V)],oe.prototype,"sizing",void 0),c([w(8,n)],oe.prototype,"placementAngle",void 0),c([w(9,n)],oe.prototype,"sizeRatio",void 0),c([w(10,b)],oe.prototype,"zoomRange",void 0);class Te extends Mt{}c([w(12,b)],Te.prototype,"offsetNextVertex1",void 0),c([w(13,b)],Te.prototype,"offsetNextVertex2",void 0),c([w(14,b)],Te.prototype,"textureUVNextVertex1",void 0),c([w(15,b)],Te.prototype,"textureUVNextVertex2",void 0);class ea extends we{}function re(e,t,s,i){return t.multiply(e.x).add(s.multiply(e.y)).add(i.multiply(e.z))}function dt(e){return e.multiply(e).divide(128)}class X extends Pe{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(t,s){const i=dt(t.sizing.x),a=dt(t.sizing.y),o=dt(t.sizing.z),r=t.placementAngle,l=ie(t.bitset,Ve.bitset.isSDF),u=ie(t.bitset,Ve.bitset.isMapAligned),p=ie(t.bitset,Ve.bitset.scaleSymbolsProportionally),d=Ji(t.bitset,Ve.bitset.colorLocked),f=es(this,t.id),h=ts(this,t.id,t.color,d).multiply(f),v=this.view.displayViewScreenMat3.multiply(new _(t.pos.xy,1)),m=Ye(this,t.id,o).divide(o),y=i.multiply(m),g=t.offset.xy.multiply(m);let x=a.multiply(p.multiply(m.subtract(1)).add(1));x=Ze(x,ce(y.subtract(.99),new n(0)));const k=ce(x,new n(1)),U=Ze(x,new n(1)),Y=W.fromRotation(r.multiply(is)),T=Rt(this,t.id),P=this._getViewRotationMatrix(u).multiply(T).multiply(Y).multiply(new _(g.xy,0)),I=this.clip(t.id,t.zoomRange),N=new V(v.xy.add(P.xy),I,1),z=t.textureUV.divide(this.mosaicInfo.size),qe=t.outlineColor.multiply(U),Ri=ie(t.bitset,Ve.bitset.overrideOutlineColor),yt=t.sizeRatio.multiply(y).multiply(.5);return{glPosition:N,color:h,textureUV:z,outlineColor:qe,outlineSize:k,distanceToPx:yt,isSDF:l,overrideOutlineColor:Ri,...this.maybeRunHittest(t,s,{pos:t.pos,size:y,sizeCorrection:m,isMapAligned:u,vvRotationMat3:T,placementMat3:Y,outlineSize:k,distanceToPx:yt,isSDF:l})}}fragment(t){const s=this._getColor(t.textureUV,t);return this.getFragmentOutput(s,t)}hittest(t,s,i){return ee(ss(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(t,s,i),this._hittestMarker(t,s,i))}_getViewRotationMatrix(t){const s=this.view.displayViewMat3,i=this.view.displayMat3,a=new n(1).subtract(t);return s.multiply(t).add(i.multiply(a))}_getViewScreenMatrix(t){const s=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,a=new n(1).subtract(t);return s.multiply(t).add(i.multiply(a))}_getColor(t,s){return ee(je(s.isSDF,new n(1)),this._getSDFColor(t,s),this._getSpriteColor(t,s))}_getSpriteColor(t,s){return Q(this.mosaicInfo.texture,t).multiply(s.color)}_getSDFColor(t,s){const i=Q(this.mosaicInfo.texture,t),a=new n(.5).subtract(Ht(i)).multiply(s.distanceToPx).multiply(as),o=tt(new n(.5).subtract(a),new n(0),new n(1)),r=s.color.multiply(o);let l=s.outlineSize;this.highlight&&(l=ce(l,s.overrideOutlineColor.multiply(4)));const u=l.multiply(.5),p=Pt(a).subtract(u),d=tt(new n(.5).subtract(p),new n(0),new n(1)),f=et(s.outlineColor,s.color,s.overrideOutlineColor).multiply(d);return new n(1).subtract(f.a).multiply(r).add(f)}_hittestSmallMarker(t,s,i){const{position:a,distance:o,smallSymbolDistance:r}=this.hittestRequest,l=o.subtract(r),{viewMat3:u,tileMat3:p}=this.view,d=u.multiply(p).multiply(new _(i.pos,1)).xy,f=i.size.multiply(.5);return os(d,a).subtract(f).add(l)}_hittestMarker(t,s,i){const{pos:a,sizeCorrection:o,isMapAligned:r}=i,l=new _(t.offset.multiply(o),0),u=new _(s.offsetNextVertex1.multiply(o),0),p=new _(s.offsetNextVertex2.multiply(o),0),{viewMat3:d,tileMat3:f}=this.view,h=d.multiply(f).multiply(new _(a,1)),v=this._getViewScreenMatrix(r).multiply(i.vvRotationMat3).multiply(i.placementMat3),m=h.add(v.multiply(l)).xy,y=h.add(v.multiply(u)).xy,g=h.add(v.multiply(p)).xy,x=this.hittestRequest.position,k=this.hittestRequest.distance,U=It(x,m,y,g);return ee(Se(U,k),U,this._hittestSamples(m,y,g,t,s,i))}_hittestSamples(t,s,i,a,o,r){const{outlineSize:l,isSDF:u,distanceToPx:p}=r,d=this.hittestRequest.position,f=this.hittestRequest.distance,h=se(d.add(new b(de(f),de(f))),t,s,i),v=se(d.add(new b(0,de(f))),t,s,i),m=se(d.add(new b(f,de(f))),t,s,i),y=se(d.add(new b(de(f),0)),t,s,i),g=se(d,t,s,i),x=se(d.add(new b(f,0)),t,s,i),k=se(d.add(new b(de(f),f)),t,s,i),U=se(d.add(new b(0,f)),t,s,i),Y=se(d.add(new b(f,f)),t,s,i),T=a.textureUV.divide(this.mosaicInfo.size),P=o.textureUVNextVertex1.divide(this.mosaicInfo.size),I=o.textureUVNextVertex2.divide(this.mosaicInfo.size),N={color:new V(1),outlineColor:new V(1),overrideOutlineColor:new n(1),outlineSize:l,distanceToPx:p,isSDF:u};let z=new n(0);return z=z.add(ae(h).multiply(this._getColor(re(h,T,P,I),N).a)),z=z.add(ae(v).multiply(this._getColor(re(v,T,P,I),N).a)),z=z.add(ae(m).multiply(this._getColor(re(m,T,P,I),N).a)),z=z.add(ae(y).multiply(this._getColor(re(y,T,P,I),N).a)),z=z.add(ae(g).multiply(this._getColor(re(g,T,P,I),N).a)),z=z.add(ae(x).multiply(this._getColor(re(x,T,P,I),N).a)),z=z.add(ae(k).multiply(this._getColor(re(k,T,P,I),N).a)),z=z.add(ae(U).multiply(this._getColor(re(U,T,P,I),N).a)),z=z.add(ae(Y).multiply(this._getColor(re(Y,T,P,I),N).a)),G(z,new n(.05)).multiply(Ke(this.hittestRequest))}}c([D(Ct)],X.prototype,"visualVariableColor",void 0),c([D(Ot)],X.prototype,"visualVariableOpacity",void 0),c([D(ut)],X.prototype,"visualVariableRotation",void 0),c([D(Et)],X.prototype,"visualVariableSizeMinMaxValue",void 0),c([D(Dt)],X.prototype,"visualVariableSizeScaleStops",void 0),c([D(Lt)],X.prototype,"visualVariableSizeStops",void 0),c([D(Bt)],X.prototype,"visualVariableSizeUnitValue",void 0),c([S(Je)],X.prototype,"mosaicInfo",void 0),c([R(0,A(oe)),R(1,A(Te))],X.prototype,"vertex",null),c([R(0,A(ea))],X.prototype,"fragment",null);let ta=class extends B{constructor(){super(...arguments),this.type=E.Marker,this.shaders={geometry:new X},this.symbologyPlane=ue.MARKER}render(e,t){const{context:s,painter:i}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...$(e,t.target,a.uniforms),...C(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey,!0)},defines:{...F(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:M(e)}),i.setPipelineState(L(e)),i.submitDraw(e,t)}},ia=class{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map(([i,a])=>`${i}.${a}`).join("."),s=cs(t);this._locationInfo={hash:s,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,s]of this.locationsMap.entries())e.set("a_"+t,s);return e}getShaderKey(e,t,s){return`${Object.keys(e).map(i=>`${i}.${e[i]}`).join(".")}.${Object.keys(s).filter(i=>s[i]).map(i=>`${i}_${s[i].toString()}`).join(".")}.${Object.keys(t).filter(i=>this.optionPropertyKeys.has(i)).join(".")}`}getProgram(e,t,s,i){let a="",o="";for(const r in s)if(s[r]){const l=typeof s[r]=="boolean"?`#define ${r}
`:`#define ${r} ${s[r]}
`;a+=l,o+=l}return a+=this.vertexShader,o+=this.fragmentShader,new rs(a,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const s in this.required){const i=this.required[s];t.push({uniformHydrated:null,shaderModulePath:s,uniformName:s,uniformType:i.type,uniformArrayElementType:fi(i),uniformArrayLength:hi(i)})}for(const s in e){const i=this.options[s];if(e[s])for(const a in i){const o=i[a];t.push({uniformHydrated:null,shaderModulePath:`${s}.${a}`,uniformName:a,uniformType:o.type,uniformArrayElementType:fi(o),uniformArrayLength:hi(o)})}}return t}};const fi=e=>e.type==="array"?e.elementType?.type:void 0,hi=e=>e.type==="array"?e.size:void 0,sa={hittestDist:n,hittestPos:b},aa={filterFlags:q,animation:q,visualVariableData:q,dataDriven0:q,dataDriven1:q,dataDriven2:q,gpgpu:q,size:n},oa={displayViewScreenMat3:W,displayViewMat3:W,displayMat3:W,viewMat3:W,tileMat3:W,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:b,currentScale:n,currentZoom:n,metersPerSRUnit:n};let ra=class extends ia{constructor(){super(...arguments),this.vertexShader=ti("materials/pie/pie.vert"),this.fragmentShader=ti("materials/pie/pie.frag"),this.required={...aa,...oa,outlineWidth:n,colors:J,defaultColor:V,othersColor:V,outlineColor:V,donutRatio:n,sectorThreshold:n},this.options={hittestUniforms:sa,visualVariableSizeMinMaxValue:{minMaxValueAndSize:V},visualVariableSizeScaleStops:{sizes:{...J.ofType(n,8),type:"array",elementType:n,size:8},values:{...J.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeStops:{sizes:{...J.ofType(n,8),type:"array",elementType:n,size:8},values:{...J.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:{...J.ofType(n,8),type:"array",elementType:n,size:8},opacityValues:{...J.ofType(n,8),type:"array",elementType:n,size:8}}},this.locations={pos:{index:0,type:b},id:{index:1,type:_},bitset:{index:2,type:n},offset:{index:3,type:b},texCoords:{index:4,type:b},size:{index:5,type:b},referenceSize:{index:6,type:n},zoomRange:{index:7,type:b}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...J.ofType(V,e),type:"array",elementType:V,size:e}}},na=class extends B{constructor(){super(...arguments),this.type=E.PieChart,this.shaders={geometry:new ra},this.symbologyPlane=ue.MARKER}render(e,t){const{painter:s}=e,{instance:i,target:a}=t,o=this.shaders.geometry,r=i.getInput(),l=r.uniforms.numberOfFields,u=M(e),p=C(e,a),d=F(e);o.setNumberOfFields(l),s.setShader({shader:o,uniforms:{...$(e,t.target,r.uniforms.shader),...p.storage,...p.view,hittestUniforms:p.hittestRequest?{hittestDist:p.hittestRequest?.distance,hittestPos:p.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!r.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!r.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!r.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!r.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!r.uniforms.shader.visualVariableOpacity,HITTEST:u,highlight:p.highlight?1:0,...d,numberOfFields:l},optionalAttributes:{},useComputeBuffer:u}),s.setPipelineState(L(e)),s.submitDraw(e,t)}},la=class extends B{constructor(){super(...arguments),this.type=E.Text,this.shaders={geometry:new O},this.symbologyPlane=ue.TEXT}render(e,t){const{context:s,painter:i}=e,a=F(e),o=t.instance.getInput(),r={shader:this.shaders.geometry,uniforms:{...$(e,t.target,o.uniforms),...C(e,t.target),mosaicInfo:i.textureManager.getMosaicInfo(s,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!1},optionalAttributes:o.optionalAttributes,useComputeBuffer:M(e)};i.setShader(r),i.setPipelineState(L(e)),i.submitDraw(e,t),i.setShader({...r,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!1}}),i.submitDraw(e,t),i.setShader({...r,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!1}}),i.submitDraw(e,t)}};const Z={fill:new Ds,patternFill:new Bs,complexFill:new Os,outlineFill:new Ls,patternOutlineFill:new ks,complexOutlineFill:new Es,marker:new ta,pieChart:new na,line:new Qs,texturedLine:new Js,text:new la,label:new Ys,heatmap:new $s,dotDensity:new Cs};function ua(){for(const e in Z)Z[e].startup()}function ca(e){for(const t in Z)Z[t].shutdown(e)}function ke(e,t){const s=e.slice(0,t),i=t-s.length;for(let a=0;a<i;a++){const o=s[s.length-1];s.push(o)}return s}function mi(e){if(!e)return[0,0,0,0];const{r:t,g:s,b:i,a}=e;return[t*(a/255),s*(a/255),i*(a/255),a]}const Ne=8,yi=Ne-2,bi=()=>Gt.getLogger("esri.views.2d.layers.features.support.rendererUtils");function vi(e){return e.map(t=>pa(t)?da(t.clone()):t)}function pa(e){return(e.type==="size"||e.type==="color"||e.type==="opacity")&&e.stops!=null}function da(e){return e.stops=ma(e.type,e.stops??[]),e}function xe(e,t,s){return(1-s)*e+s*t}function fa(e,t){const[s,...i]=t,a=i.pop(),o=i[0].value,r=i[i.length-1].value,l=(r-o)/yi,u=[];for(let p=o;p<r;p+=l){let d=0;for(;p>=i[d].value;)d++;const f=i[d],h=t[d-1],v=p-h.value,m=f.value===h.value?1:v/(f.value-h.value);if(e==="color"){const y=i[d],g=t[d-1],x=y.color.clone();x.r=xe(g.color.r,x.r,m),x.g=xe(g.color.g,x.g,m),x.b=xe(g.color.b,x.b,m),x.a=xe(g.color.a,x.a,m),u.push({value:p,color:x,label:y.label})}else if(e==="size"){const y=i[d],g=t[d-1],x=qt(y.size),k=xe(qt(g.size),x,m);u.push({value:p,size:k,label:y.label})}else{const y=i[d],g=xe(t[d-1].opacity,y.opacity,m);u.push({value:p,opacity:g,label:y.label})}}return[s,...u,a]}function ha(e){const[t,...s]=e,i=s.pop();for(;s.length>yi;){let a=0,o=0;for(let r=1;r<s.length;r++){const l=s[r-1],u=s[r],p=Math.abs(u.value-l.value);p>o&&(o=p,a=r)}s.splice(a,1)}return[t,...s,i]}function ma(e,t){return t.length<=Ne?t:(bi().warn(`Found ${t.length} Visual Variable stops, but MapView only supports ${Ne}. Displayed stops will be simplified.`),t.length>2*Ne?fa(e,t):ha(t))}function ya(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:s}=it();return e&&t||s}function ba(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!ya()){const t=it(),s=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!t[i]).join(", ");return bi().errorOnce(new Re("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${s}`)),!1}}return!0}const va=1.25,He=128,ga=128;function xa(e){if(!e.stops?.length)return null;const t=e.stops.sort((o,r)=>o.value-r.value),s=ke(t,8),i=s.map(({value:o})=>o),a=s.map(({color:o})=>mi(o));return{values:i,colors:a}}function wa(e){if(!e.stops?.length)return null;const t=e.stops.sort((i,a)=>i.value-a.value),s=ke(t,8);return{opacityValues:s.map(({value:i})=>i),opacities:s.map(({opacity:i})=>i)}}function Sa(e){return{rotationType:e.rotationType==="geographic"?Xe.Geographic:Xe.Arithmatic}}function ft(e){if(!e.stops?.length)return null;if(e.stops.some(i=>i.useMaxValue||i.useMinValue))return(i,a)=>{const o=i.statisticsByLevel.get(a.key.level),r=e.stops.map(u=>({value:u.useMaxValue?o?.get(e.field)?.maxValue??0:u.useMinValue?o?.get(e.field)?.minValue??0:u.value,size:u.size?fe(u.size):gs})).sort((u,p)=>u.value-p.value),l=ke(r,8);return{values:l.map(({value:u})=>u),sizes:l.map(({size:u})=>u)}};const t=e.stops.sort((i,a)=>i.value-a.value),s=ke(t,8);return{values:s.map(({value:i})=>i),sizes:s.map(({size:i})=>fe(i))}}function Va(e){return t=>{const{state:s}=t;return{unitValueToPixelsRatio:ps(s.spatialReference)/ds[e.valueUnit??"meters"]/s.resolution}}}function gi(e,t){const s=t.length;if(e<t[0].value||s===1)return t[0].size;for(let i=1;i<s;i++)if(e<t[i].value){const a=(e-t[i-1].value)/(t[i].value-t[i-1].value);return t[i-1].size+a*(t[i].size-t[i-1].size)}return t[s-1].size}function _a(e){const{minDataValue:t,maxDataValue:s,minSize:i,maxSize:a}=e;if(typeof i=="object"&&typeof a=="object")return(o,r)=>{const l=o.state.scale,u=fe(gi(l,i.stops)),p=fe(gi(l,a.stops));return{minMaxValueAndSize:[t,s,u,p]}};if(typeof i=="object"||typeof a=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,s,fe(i),fe(a)]}}const Ue={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function ht(e,t=ga,s=va){if(e.visualVariableSizeMinMaxValue)return e.visualVariableSizeMinMaxValue instanceof Function?He:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*s,t);if(e.visualVariableSizeScaleStops){if(e.visualVariableSizeScaleStops instanceof Function)return He;const i=e.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*s,t)}if(e.visualVariableSizeStops){if(e.visualVariableSizeStops instanceof Function)return He;const i=e.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*s,t)}return e.visualVariableSizeUnitValue?2*He:0}function za(e){const t={...Ue};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const s of vi(e.visualVariables))switch(s.type){case"color":t.visualVariableColor=xa(s);break;case"opacity":t.visualVariableOpacity=wa(s);break;case"rotation":t.visualVariableRotation=Sa(s);break;case"size":switch(Ta(s)){case"field-stops":t.visualVariableSizeStops=ft(s);break;case"scale-stops":s.target==="outline"?t.visualVariableSizeOutlineScaleStops=ft(s):t.visualVariableSizeScaleStops=ft(s);break;case"min-max":t.visualVariableSizeMinMaxValue=_a(s);break;case"unit-value":t.visualVariableSizeUnitValue=Va(s)}break}return t}function Ta(e){return typeof e.minDataValue=="number"&&typeof e.maxDataValue=="number"&&e.minSize!=null&&e.maxSize!=null?"min-max":e?.valueExpression==="$view.scale"&&Array.isArray(e.stops)?"scale-stops":e.field==null&&e?.valueExpression==="$view.scale"||!(Array.isArray(e.stops)||"levels"in e&&e.levels)?e.field!=null||e?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function xi(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function Ma(e){return!!e.visualVariableRotation}function wi(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function te(e){if(e==null)return null;if(Array.isArray(e)){const[t,s,i,a]=e;return[t,s,i,255*a]}return typeof e=="string"?e:{...e,defaultValue:te(e?.defaultValue)}}async function Pa(e,t){const{cimResourceManager:s,cimAnalyzer:i,scaleExpression:a}=t.schemaOptions;await Promise.all(ns.fetchResources(e.symbol,s,[]));const o=i.analyzeSymbolReference(e,!1),r={scaleInfo:wi(e),scaleExpression:a},l=[];for(const u of o)switch(u.type){case"marker":l.push(...Aa(u,t,r));break;case"fill":l.push(...Fa(u,t,r));break;case"line":l.push(...Ia(u,t,r));break;case"text":l.push(...Ca(u,t,r))}return l}function Aa(e,t,s){const{uniforms:i,schemaOptions:a}=t,{store:o}=a,r=e.isOutline?{...Ue,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return Si(o.ensureInstance(Z.marker,{uniforms:r,optionalAttributes:{zoomRange:!!s.scaleInfo}}),e,i,s)}function Si(e,t,s,{scaleInfo:i,scaleExpression:a}){const o=xi(s);return[e.createMeshInfo({size:t.size,scaleX:t.scaleX,anchorX:t.anchorPoint.x,anchorY:t.anchorPoint.y,angle:t.rotation,color:te(t.color)??[0,0,0,0],colorLocked:t.colorLocked,frameHeight:t.frameHeight,widthRatio:t.widthRatio,scaleInfo:i,offsetX:t.offsetX,offsetY:t.offsetY,outlineColor:te(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineWidth,referenceSize:t.referenceSize||fs.CIMVectorMarker.size,rotateClockwise:t.rotateClockwise,scaleFactor:a??1,sizeRatio:t.sizeRatio,alignment:t.alignment,isAbsoluteAnchorPoint:t.isAbsoluteAnchorPoint,scaleSymbolsProportionally:t.scaleSymbolsProportionally,sprite:t.spriteRasterizationParam,hasSizeVV:o,placement:t.markerPlacement,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,transforms:t.transform,minPixelBuffer:ht(s)})]}function Ra(e,t,s){const{uniforms:i,schemaOptions:a}=t,{store:o}=a;return Vi(o.ensureInstance(Z.fill,{uniforms:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!s.scaleInfo}}),e,s)}function Vi(e,t,{scaleInfo:s}){return[e.createMeshInfo({color:te(t.color)??[0,0,0,0],scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Fa(e,t,s){if(!e.spriteRasterizationParam)return Ra(e,t,s);const{uniforms:i,schemaOptions:a}=t,{store:o}=a;return _i(o.ensureInstance(Z.complexFill,{uniforms:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!s.scaleInfo}}),e,i.visualVariableColor!=null,s)}function _i(e,t,s,{scaleInfo:i}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const a=!!t.hasUnresolvedReplacementColor&&(!s||t.colorLocked),o=t.sampleAlphaOnly&&!a,r=t.spriteRasterizationParam;return[e.createMeshInfo({color:te(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:o,scaleProportionally:r.resource.type==="CIMHatchFill",sprite:r,scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Ia(e,t,s){const{uniforms:i,schemaOptions:a}=t,{store:o}=a,r=e.isOutline?{...Ue,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={uniforms:r,optionalAttributes:{zoomRange:!!s.scaleInfo}},u=!!(r.visualVariableSizeMinMaxValue||r.visualVariableSizeScaleStops||r.visualVariableSizeStops||r.visualVariableSizeUnitValue);return e.spriteRasterizationParam?Mi(o.ensureInstance(Z.texturedLine,l),e,u,s):Ti(o.ensureInstance(Z.line,l),e,u,s)}function zi(e,t,{scaleInfo:s}){return{color:te(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:s,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}function Ti(e,t,s,i){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const a=zi(t,s,i);return[e.createMeshInfo(a)]}function Mi(e,t,s,i){const{spriteRasterizationParam:a,scaleDash:o,sampleAlphaOnly:r}=t;if(!a)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({...zi(t,s,i),shouldScaleDash:o??!1,shouldSampleAlphaOnly:r,isSDF:a.resource.type!=="CIMPictureStroke",sprite:a})]}function Ca(e,t,s){const{uniforms:i,schemaOptions:a}=t,{store:o}=a;return Pi(o.ensureInstance(Z.text,{uniforms:{visualVariableColor:e.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!s.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),e,i,s)}function Pi(e,t,s,{scaleInfo:i,scaleExpression:a}){return[e.createMeshInfo({boxBackgroundColor:te(t.backgroundColor),boxBorderLineColor:te(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:te(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:te(t.outlineColor)??[0,0,0,0],haloFontSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:a??1,minPixelBuffer:ht(s),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1})]}function Oa(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:it().maxTextureSize},bindings:Ea(e)}}function Ge(e){switch(e){case"opacity":return Ie.OPACITY;case"color":return Ie.COLOR;case"rotation":return Ie.ROTATION;case"size":return Ie.SIZE;default:return null}}function Ea(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return mt(e);case"dot-density":return Da(e);case"pie-chart":return La(e);case"heatmap":return Ba(e)}}function Da(e){const t=[];for(const s of e.attributes)t.push({binding:t.length,expression:s.valueExpression,field:s.field});return t}function La(e){const t=mt(e);let s=4;for(const i of e.attributes)t.push({binding:s++,expression:i.valueExpression,field:i.field});return t}function Ba({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}function mt(e){return!("visualVariables"in e)||!e.visualVariables?.length?[]:vi(e.visualVariables).map(t=>Ga(t)).filter(hs)}function ka(e){return e.valueExpression==="$view.scale"?null:{binding:Ge(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}function Na(e){return{binding:Ge(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}function Ha(e){return{binding:Ge(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}function Ua(e){return{binding:Ge(e.type),expression:e.valueExpression,field:e.field}}function Ga(e){switch(e.type){case"size":return ka(e);case"color":return Na(e);case"opacity":return Ha(e);case"rotation":return Ua(e)}}class qa{constructor(t){this.updateTracking=new ls({debugName:"FeatureCommandQueue"}),this._queueProcessor=new ms({concurrency:1,process:t.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(t){return ys(this.updateTracking.addPromise(this._doPush(t)))}async _doPush(t){const s=this._queueProcessor,i=s.last();switch(t.type){case"update":case"highlight":return i?.type===t.type?void 0:s.push(t);case"edit-by-id":case"edit-by-feature":return s.push(t)}}}export{za as M,ua as T,Ti as a,_i as b,qa as c,Oa as d,mi as e,ht as f,xi as g,Z as h,Ma as i,mt as j,ba as m,Pa as n,Vi as p,wi as t,Si as u,ca as w,Ue as x,Pi as y,Mi as z};
