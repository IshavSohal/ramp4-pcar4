import{k as t,o as s,b3 as _,A as d,cH as A,au as C,bC as O,V as g,cW as H,s as q,aE as o,f1 as l,aG as x,n as m,da as E,gu as T,bP as P,aD as I,C as L}from"./main-BZ5cNcLx.js";import{n as U}from"./Container-BWa0jekd.js";import{i as w,l as k,a as V,r as M,b as j}from"./MapView-1VOif7rz.js";import{a as b,p as G}from"./ClipRect-DF-ksBTL.js";import{r as B,a as R}from"./layerViewUtils-Cbih7hiU.js";import{h as D}from"./UpdatingHandles-ClQpiZlS.js";function N(i){return i!=null&&typeof i=="object"&&i.type==="2d"&&i.view2dType==="linkchart"}var v;const F={base:A,key:"type",typeMap:{extent:C,polygon:O}};let u=v=class extends b{constructor(i){super(i),this.type="geometry",this.geometry=null}clone(){return new v({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};t([s({types:F,json:{read:_,write:!0}})],u.prototype,"geometry",void 0),u=v=t([d("esri.views.layers.support.Geometry")],u);const S=u;let c=class extends b{constructor(i){super(i),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};t([s({type:[[[Number]]],json:{write:!0}})],c.prototype,"path",void 0),c=t([d("esri.views.layers.support.Path")],c);const W=c,f=g.ofType({key:"type",base:null,typeMap:{rect:G,path:W,geometry:S}}),$=new(g.ofType(w)),z=i=>{let a=class extends i{constructor(){super(...arguments),this.attached=!1,this.clips=new f,this.highlights=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){const r=this.view?.spatialReferenceLocked??!0;this.view?.spatialReference&&r&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new q("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new U),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([o(()=>this.suspended,e=>{this.container&&(this.container.visible=!e)},l),o(()=>this.updateSuspended,e=>{this.view&&!e&&this.updateRequested&&this.view.requestUpdate()},l),o(()=>this.layer?.opacity??1,e=>{this.container&&(this.container.opacity=e)},l),o(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",e=>{this.container&&(this.container.blendMode=e)},l),o(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,e=>{this.container&&(this.container.effect=e)},l),o(()=>this._mergedHighlights.items.map(e=>({name:e.name,options:{fillColor:e.options.color,haloColor:e.options.haloColor,fillOpacity:e.options.fillOpacity,haloOpacity:e.options.haloOpacity,haloWidth:e.options.haloWidth,haloBlur:e.options.haloBlur}})),()=>{this.container.highlightGradient=V(this.container.highlightGradient,this._mergedHighlights.items)},l),o(()=>this._mergedHighlights.items.map(e=>e.name),()=>{this._updateHighlights()}),x(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},l),o(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:e,scaleRange:h})=>{const p=B(h,e);p!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=p)},l)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(e=>{e===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}_updateHighlights(){}destroy(){this.processDetach(),this.updateRequested=!1}get highlightOptions(){return M(this)}set highlightOptions(r){j(this,r)}get _mergedHighlights(){if(!this.view)return $;if(!this.highlights)return this.view.highlights;const r=this.view.highlights.clone();for(const e of this.highlights){const h=r.find(p=>p.name===e.name);h&&(h.options=e.options)}return r}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){const r=this.view?.spatialReference;return r==null||this.supportsSpatialReference(r)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(r){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",r),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(r))):this.updateRequested=!1}hitTest(r,e){return Promise.resolve(null)}supportsSpatialReference(r){return!0}canResume(){if(!this.spatialReferenceSupported)return!1;switch(this.layer?.type){case"link-chart":case"knowledge-graph-sublayer":break;default:if(N(this.view)&&!this.view.inGeographicLayout)return!1}return!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const r=super.getSuspendInfo(),e=!this.spatialReferenceSupported;return e&&(r.spatialReferenceNotSupported=e),r}addAttachHandles(r){this.addHandles(r,"attach")}_getHighlightBits(r){r=new Set(r);let e=1,h=0;if(!this.view)return 0;const p=this._mergedHighlights;for(const{name:y}of p)r.delete(y)&&(h=e),e<<=1;for(const y of r)m.getLogger(this).error("#highlights",`${y} was not found. Features in this group will not be highlighted.`);return h}};return t([s()],a.prototype,"attached",void 0),t([s({type:f,set(r){const e=H(r,this._get("clips"),f);this._set("clips",e)}})],a.prototype,"clips",void 0),t([s()],a.prototype,"container",void 0),t([s({type:k})],a.prototype,"highlightOptions",null),t([s({type:g.ofType(w)})],a.prototype,"highlights",void 0),t([s()],a.prototype,"_mergedHighlights",null),t([s()],a.prototype,"moving",void 0),t([s({readOnly:!0})],a.prototype,"spatialReferenceSupported",null),t([s({readOnly:!0})],a.prototype,"updateParameters",void 0),t([s()],a.prototype,"updateRequested",void 0),t([s()],a.prototype,"updating",null),t([s()],a.prototype,"view",void 0),t([s()],a.prototype,"_visibleAtCurrentScale",void 0),t([s({readOnly:!0})],a.prototype,"visibleAtCurrentScale",null),a=t([d("esri.views.2d.layers.LayerView2D")],a),a};let n=class extends E(T(P.EventedMixin(I))){constructor(i){super(i),this._updatingHandles=new D,this.layer=null,this.parent=null}initialize(){this.when().catch(i=>{if(i.name!=="layerview:create-error"){const a=this.layer&&this.layer.id||"no id",r=this.layer?.title||"no title";m.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${r}', id: '${a}')`,i)}})}destroy(){this._updatingHandles=L(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return this.destroyed||!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&this.layer?.legendEnabled===!0}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get updateSuspended(){return this.suspended}get visible(){return this.layer?.visible===!0}set visible(i){this._overrideIfSome("visible",i)}get visibleAtCurrentScale(){return!0}get visibleAtCurrentTimeExtent(){const i=this.view.timeExtent,a=this.layer?.visibilityTimeExtent;return!i||!a||!i.intersection(a).isEmpty}canResume(){const i=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready&&R(i)&&this.visibleAtCurrentScale&&this.visibleAtCurrentTimeExtent||!1}getSuspendInfo(){const i=this.parent?.suspended?this.parent.suspendInfo:{};this.view?.ready||(i.viewNotReady=!0),this.layer&&this.layer.loaded||(i.layerNotLoaded=!0);const a=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return R(a)&&this.visibleAtCurrentScale||(i.outsideScaleRange=!0),this.visibleAtCurrentTimeExtent||(i.outsideVisibilityTimeExtent=!0),this.visible||(i.layerInvisible=!0),i}isUpdating(){return!1}};t([s()],n.prototype,"view",void 0),t([s()],n.prototype,"fullOpacity",null),t([s()],n.prototype,"layer",void 0),t([s()],n.prototype,"parent",void 0),t([s({readOnly:!0})],n.prototype,"suspended",null),t([s({readOnly:!0})],n.prototype,"suspendInfo",null),t([s({readOnly:!0})],n.prototype,"legendEnabled",null),t([s({type:Boolean,readOnly:!0})],n.prototype,"updating",null),t([s({readOnly:!0})],n.prototype,"updatingProgress",null),t([s()],n.prototype,"updateSuspended",null),t([s()],n.prototype,"visible",null),t([s({readOnly:!0})],n.prototype,"visibleAtCurrentScale",null),t([s({readOnly:!0})],n.prototype,"visibleAtCurrentTimeExtent",null),n=t([d("esri.views.layers.LayerView")],n);const Z=n;export{S as a,z as j,Z as y};
