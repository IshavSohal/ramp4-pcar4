{"version":3,"file":"index-CQ2u_fY7.js","sources":["../../src/fixtures/extentguard/api/extentguard.ts","../../src/fixtures/extentguard/index.ts"],"sourcesContent":["import { FixtureInstance } from '@/api';\r\nimport { useExtentguardStore } from '../store';\r\nimport type { ExtentguardConfig } from '../store';\r\n\r\n/**\r\n * Will force map extent to remain within the defined maximum extent\r\n */\r\nexport class ExtentguardAPI extends FixtureInstance {\r\n    /**\r\n     * Parses the extentguard config JSON snippet from the config file and save to the fixture store.\r\n     *\r\n     * @param {extentguardConfig} [ExtentguardConfig]\r\n     * @memberof ExtentguardAPI\r\n     */\r\n    _parseConfig(extentguardConfig?: ExtentguardConfig) {\r\n        // NOTE: do not set store.active in this method.\r\n        //       it needs to remain inactive so the handler managing code\r\n        //       can know if it needs to wire up new handlers\r\n\r\n        if (extentguardConfig) {\r\n            const store = useExtentguardStore(this.$vApp.$pinia);\r\n\r\n            if (extentguardConfig.alwaysOn) {\r\n                store.setAlwaysOn(true);\r\n            }\r\n\r\n            const esi = extentguardConfig.extentSetIds;\r\n            if (esi && Array.isArray(esi) && esi.length > 0) {\r\n                store.setExtentSetIds(esi);\r\n            }\r\n        }\r\n    }\r\n\r\n    get config(): ExtentguardConfig | undefined {\r\n        return super.config;\r\n    }\r\n}\r\n","import { Extent } from '@/geo/api';\r\nimport type { BasemapChange } from '@/geo/api';\r\nimport { ExtentguardAPI } from './api/extentguard';\r\nimport { type ExtentguardConfig, useExtentguardStore } from './store';\r\nimport { GlobalEvents } from '@/api';\r\n\r\ninterface ClipResult {\r\n    min: number;\r\n    max: number;\r\n    changed: boolean;\r\n}\r\n\r\n/**\r\n * Compares a range of co-ordinates to a bounding range of co-ordinates. If center of the range falls outside\r\n * the bounding range, function will return a range that is back inside the bounding range\r\n *\r\n * @function clipCoords\r\n * @param {Number} testMax maximum value of the range to test\r\n * @param {Number} testMin minimum value of the range to test\r\n * @param {Number} boundingMax maximum value of the bounding range\r\n * @param {Number} boundingMin minimum value of the bounding range\r\n * @return {ClipResult} bundle of information. resulting range and flag if it was adjusted\r\n */\r\nfunction clipCoords(testMax: number, testMin: number, boundingMax: number, boundingMin: number): ClipResult {\r\n    // center co-ord of the  range to test\r\n    const testLength = testMax - testMin;\r\n    const middle = testMin + testLength / 2;\r\n\r\n    // smallest of the two input ranges.\r\n    // this is required to avoid a \"washing machine\" effect when the test range\r\n    // is much larger than the bounding range. Re-adjusting by the test range size can\r\n    // overshoot the bound and then another bound violation triggers. Which sends it\r\n    // back too far. Over and over and over.\r\n    const safeLength = Math.min(testLength, boundingMax - boundingMin);\r\n\r\n    if (middle > boundingMax) {\r\n        // our midpoint is too high\r\n        return {\r\n            min: boundingMax - safeLength,\r\n            max: boundingMax,\r\n            changed: true\r\n        };\r\n    } else if (middle < boundingMin) {\r\n        // our midpoint is too low\r\n        return {\r\n            min: boundingMin,\r\n            max: boundingMin + safeLength,\r\n            changed: true\r\n        };\r\n    } else {\r\n        // range was all good\r\n        return {\r\n            min: testMin,\r\n            max: testMax,\r\n            changed: false\r\n        };\r\n    }\r\n}\r\n\r\nclass ExtentguardFixture extends ExtentguardAPI {\r\n    /**\r\n     * Schema change event handler name\r\n     */\r\n    private schemaEH = '';\r\n\r\n    /**\r\n     * Extent change event handler name\r\n     */\r\n    private extentEH = '';\r\n\r\n    added(): void {\r\n        // take in any configuration\r\n\r\n        this._parseConfig(this.config);\r\n\r\n        // watch for configuration changes\r\n        const unwatch = this.$vApp.$watch(\r\n            () => this.config,\r\n            (value: ExtentguardConfig | undefined) => this._parseConfig(value)\r\n        );\r\n\r\n        // override the removed method here to get access to scope\r\n        this.removed = () => {\r\n            // cleanup\r\n\r\n            unwatch();\r\n\r\n            const store = useExtentguardStore(this.$vApp.$pinia);\r\n            store.$reset();\r\n            this.evtOff('schemaEH');\r\n            this.evtOff('extentEH');\r\n        };\r\n\r\n        // watch for basemap schema changes\r\n        this.schemaEH = this.$iApi.event.on(GlobalEvents.MAP_BASEMAPCHANGE, (payload: BasemapChange) => {\r\n            if (payload.schemaChanged) {\r\n                // make sure new schema wants the fixture active\r\n                this.checkActive();\r\n            }\r\n        });\r\n\r\n        // do a status check when map creates, or if map already created\r\n        if (this.$iApi.geo.map.created) {\r\n            this.checkActive();\r\n        } else {\r\n            this.$iApi.event.once(GlobalEvents.MAP_CREATED, () => {\r\n                this.checkActive();\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Examines current state of the instance and activates or deactivates appropriately\r\n     */\r\n    private checkActive(): void {\r\n        const store = useExtentguardStore(this.$vApp.$pinia);\r\n        if (store.alwaysOn || store.extentSetIds.includes(this.$iApi.geo.map.getExtentSet().id)) {\r\n            if (!store.active) {\r\n                // turn on, start listening to extent changes\r\n                store.setActive(true);\r\n\r\n                this.extentEH = this.$iApi.event.on(GlobalEvents.MAP_EXTENTCHANGE, (extent: Extent) => {\r\n                    if (!store.enforcing) {\r\n                        this.enforceBoundary(extent, false);\r\n                    }\r\n                });\r\n            }\r\n        } else if (store.active) {\r\n            // turn off\r\n            store.setActive(false);\r\n            this.evtOff('extentEH');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Wraps the act of checking if an event handler exists, and if so, removing it.\r\n     * Just a reapeated code saver\r\n     * @param eventPropName property name of this class that can hold an event handler name\r\n     * @private\r\n     */\r\n    private evtOff(eventPropName: 'extentEH' | 'schemaEH'): void {\r\n        if (this[eventPropName]) {\r\n            this.$iApi.event.off(this[eventPropName]);\r\n            this[eventPropName] = '';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks if the center of the given extent is outside of the maps maximum extent. If it is,\r\n     * will pan the map back to something appropriate\r\n     *\r\n     * @function enforceBoundary\r\n     * @param {Extent} extent an extent to adjudicate\r\n     * @param {boolean} safetyCheck indicates if this enforcement is a check against an original enforcement\r\n     */\r\n    private enforceBoundary(extent: Extent, safetyCheck: boolean): void {\r\n        const maxExtent = this.$iApi.geo.map.getExtentSet().maximumExtent;\r\n\r\n        const xTest = clipCoords(extent.xmax, extent.xmin, maxExtent.xmax, maxExtent.xmin);\r\n\r\n        const yTest = clipCoords(extent.ymax, extent.ymin, maxExtent.ymax, maxExtent.ymin);\r\n\r\n        if (yTest.changed || xTest.changed) {\r\n            // something was adjusted.\r\n\r\n            if (safetyCheck) {\r\n                // stranded in a stuck zone.\r\n                // attempting to zoomTo back to a good location will not work. esri map will\r\n                // just derivate the equivalent co-ord in the stuck zone and stay there.\r\n                // this hard-resets our view back to a safe zone, then the following zoomTo\r\n                // will place the map where we wanted it.\r\n\r\n                this.$iApi.geo.map.esriView!.extent = maxExtent.toESRI();\r\n            }\r\n\r\n            const respectfulExtent = Extent.fromParams(\r\n                'extguard',\r\n                xTest.min,\r\n                yTest.min,\r\n                xTest.max,\r\n                yTest.max,\r\n                extent.sr\r\n            );\r\n\r\n            const store = useExtentguardStore(this.$vApp.$pinia);\r\n            store.setEnforcing(true);\r\n            // timeout due to how spammy extent change events are when mouse-panning.\r\n            // lets the user pan finish before triggering the snapback.\r\n            // adjusted animation as the default is pretty aggressive and mildly shocking.\r\n            // 300ms on linear is also ok. ease-in-out feels a bit more natural to me.\r\n            setTimeout(() => {\r\n                this.$iApi.geo.map.zoomMapTo(respectfulExtent, undefined, true, 400, 'ease-in-out').then(() => {\r\n                    store.setEnforcing(false);\r\n                    // need to check again. a very wild pan on a wrappable co-ord system\r\n                    // can strand us in a zone where you get stuck.\r\n                    // the saftey param gets turned on, will perform rescue moves if\r\n                    // we're stuck.\r\n                    this.enforceBoundary(this.$iApi.geo.map.getExtent(), true);\r\n                });\r\n            }, 150);\r\n        }\r\n    }\r\n}\r\n\r\nexport default ExtentguardFixture;\r\n"],"names":["ExtentguardAPI","FixtureInstance","extentguardConfig","store","useExtentguardStore","esi","clipCoords","testMax","testMin","boundingMax","boundingMin","testLength","middle","safeLength","ExtentguardFixture","unwatch","value","GlobalEvents","payload","extent","eventPropName","safetyCheck","maxExtent","xTest","yTest","respectfulExtent","Extent"],"mappings":"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"}