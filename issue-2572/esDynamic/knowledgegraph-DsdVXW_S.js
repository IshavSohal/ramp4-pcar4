import{C as W,cW as w,cX as S,Y as A,M as b,cK as I,cY as k,a6 as J,c_ as M,c$ as j}from"./main-DqrbaFR_.js";import{o as T,V as C,j as G,X as Q,J as U,c as P,K as V,Z as q,a0 as X,a1 as Y,a2 as O,U as D}from"./arcade-CiozHetb.js";import{a as l,r as p}from"./unitConversion-oSjaFFR6.js";import{l as Z}from"./portalUtils-N3LgtQKb.js";import{k as _,K as $,O as z}from"./projection-cn5ptHC1.js";import B from"./PortalItem-BkYKHrOL.js";import{m as E,n as H}from"./project-CowwUG1B.js";import{p as L,c as ee,t as re,a as ae,b as te}from"./Relationship-D264b2ib.js";let f=null;async function ie(e){const r=A.geometryServiceUrl??"";if(!r){_()||await $();for(const a of e)a.container[a.indexer]=z(a.container[a.indexer],b.WGS84);return}const t=e.map(a=>a.container[a.indexer]),n=new E({geometries:t,outSpatialReference:b.WGS84}),s=await H(r,n);for(let a=0;a<s.length;a++){const i=e[a];i.container[i.indexer]=s[a]}}async function F(e,r){const t=new B({portal:e,id:r});return await t.load(),f===null&&(f=await import("./knowledgeGraphService-CXFtV0Wy.js").then(n=>n.k)),await f.fetchKnowledgeGraph(t.url)}function R(e,r,t,n,s){if(e===null)return null;if(w(e)||I(e))return e;if(q(e)||q(e))return e.toJSDate();if(X(e))return e.toStorageFormat();if(Y(e))return e.toStorageString();if(O(e)){const a={};for(const i of e.keys())a[i]=R(e.field(i),r,t,n,s),a[i]instanceof k&&s.push({container:a,indexer:i});return a}if(S(e)){const a=e.map(i=>R(i,r,t,n,s));for(let i=0;i<a.length;i++)a[i]instanceof k&&s.push({container:a,indexer:i});return a}return D(e)?e.spatialReference.isWGS84?e:e.spatialReference.isWebMercator&&r?J(e):e:void 0}function ne(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return j(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new l(r,p.WrongSpatialReference,null)}function v(e,r){if(!e)return null;const t={};for(const n in e)t[n]=m(e[n],r);return t}function m(e,r){return e===null?null:S(e)?e.map(t=>m(t,r)):e instanceof ee?{graphTypeName:e.typeName,id:e.id,graphType:"entity",properties:v(e.properties,r)}:e instanceof re?{graphType:"object",properties:v(e.properties,r)}:e instanceof ae?{graphTypeName:e.typeName,id:e.id,graphType:"relationship",originId:e.originId??null,destinationId:e.destinationId??null,properties:v(e.properties,r)}:e instanceof te?{graphType:"path",path:e.path?e.path.map(t=>m(t,r)):null}:D(e)?ne(e,r):w(e)||I(e)||M(e)?e:null}function oe(e){e.mode==="async"&&(e.functions.knowledgegraphbyportalitem=function(r,t){return e.standardFunctionAsync(r,t,(n,s,a)=>{if(T(a,2,2,r,t),a[0]===null)throw new l(r,p.PortalRequired,t);if(a[0]instanceof C){const d=G(a[1]);let u;return u=r.services?.portal?r.services.portal:W.getDefault(),F(Z(a[0],u),d)}if(w(a[0])===!1)throw new l(r,p.InvalidParameter,t);const i=G(a[0]);return F(r.services?.portal??W.getDefault(),i)})},e.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),e.functions.querygraph=function(r,t){return e.standardFunctionAsync(r,t,async(n,s,a)=>{T(a,2,4,r,t);const i=a[0];if(!Q(i))throw new l(r,p.InvalidParameter,t);const d=a[1];if(!w(d))throw new l(r,p.InvalidParameter,t);f===null&&(f=await import("./knowledgeGraphService-CXFtV0Wy.js").then(o=>o.k));let u=null;const h=U(a[2],null);if(!(h instanceof P||h===null))throw new l(r,p.InvalidParameter,t);if(h){let o=[];u=R(h,!0,!1,r,o),o=o.filter(c=>!c.container[c.indexer].spatialReference.isWGS84),o.length>0&&await ie(o)}const x=new L({openCypherQuery:d,bindParameters:u});(i?.serviceDefinition?.currentVersion??11.3)>11.2&&(x.outputSpatialReference=r.spatialReference);const K=(await f.executeQueryStreaming(i,x)).resultRowsStream.getReader(),y=[];try{for(;;){const{done:o,value:c}=await K.read();if(o)break;if(S(c))for(const g of c)y.push(m(g,r));else{const g=[];for(const N of c)g.push(m(c[N],r));y.push(g)}}}catch(o){throw o}return P.convertJsonToArcade(y,V(r),!1,!0)})},e.signatures.push({name:"querygraph",min:2,max:4}))}export{oe as registerFunctions};
