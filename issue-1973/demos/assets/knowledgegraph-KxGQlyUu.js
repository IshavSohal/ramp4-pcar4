const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./knowledgeGraphService-Ca4yQOHt.js","./main-5ivotA7d.js","./preload-helper-dJJaZANz.js","./main-Dm4D1JVC.css","./GraphQueryStreaming-DYENJpiQ.js"])))=>i.map(i=>d[i]);
import { _ as __vitePreload } from './preload-helper-dJJaZANz.js';
import { C as C$1, D as s$1, bq as _, br as W, bs as K$1, bA as f$1, S, eY as n$1, f0 as R, f1 as d } from './main-5ivotA7d.js';
import { a as ae, b as a, r, I as t, m as me, G, ab as $, P, N, U, A as He, E as E$1, X, w as ee, v as te, ac as K$2, ad as q, ae as re } from './arcadeUtils-okWKKURq.js';
import { l } from './portalUtils-C2_3lN_s.js';
import { p, n } from './project-BFXXiN9s.js';
import { s, m, t as t$1, p as p$1, c } from './GraphQueryStreaming-DYENJpiQ.js';
import './TimeOnly-Bm6ucPlH.js';
import './ImmutableArray-B20xHd08.js';
import './number-7FD0uDwu.js';

let F=null;async function J(r){const t=s$1.geometryServiceUrl??"";if(!t){_()||await W();for(const e of r)e.container[e.indexer]=K$1(e.container[e.indexer],f$1.WGS84);return}const n$1=r.map((e=>e.container[e.indexer])),o=new p({geometries:n$1,outSpatialReference:f$1.WGS84}),a=await n(t,o);for(let e=0;e<a.length;e++){const t=r[e];t.container[t.indexer]=a[e];}}async function M(e,r){const t=new S({portal:e,id:r});return await t.load(),null===F&&(F=await __vitePreload(() => import('./knowledgeGraphService-Ca4yQOHt.js').then(n => n.k),true?__vite__mapDeps([0,1,2,3,4]):void 0,import.meta.url)),await F.fetchKnowledgeGraph(t.url)}function Q(e,r,t,n,o){if(null===e)return null;if(G(e)||E$1(e))return e;if(X(e))return e.toJSDate();if(X(e))return e.toJSDate();if(ee(e))return e.toStorageFormat();if(te(e))return e.toStorageString();if(K$2(e)){const a={};for(const i of e.keys())a[i]=Q(e.field(i),r,t,n,o),a[i]instanceof n$1&&o.push({container:a,indexer:i});return a}if(U(e)){const a=e.map((e=>Q(e,r,t,n,o)));for(let e=0;e<a.length;e++)a[e]instanceof n$1&&o.push({container:a,indexer:e});return a}return q(e)?e.spatialReference.isWGS84?e:e.spatialReference.isWebMercator&&r?R(e):e:void 0}function E(e,r$1){if(!e)return e;if(e.spatialReference.isWGS84&&r$1.spatialReference.isWebMercator)return d(e);if(e.spatialReference.equals(r$1.spatialReference))return e;throw new a(r$1,r.WrongSpatialReference,null)}function K(e,r){if(!e)return null;const t={};for(const n in e)t[n]=V(e[n],r);return t}function V(e,r){return null===e?null:U(e)?e.map((e=>V(e,r))):e instanceof m?{graphTypeName:e.typeName,id:e.id,graphType:"entity",properties:K(e.properties,r)}:e instanceof t$1?{graphType:"object",properties:K(e.properties,r)}:e instanceof p$1?{graphTypeName:e.typeName,id:e.id,graphType:"relationship",originId:e.originId??null,destinationId:e.destinationId??null,properties:K(e.properties,r)}:e instanceof c?{graphType:"path",path:e.path?e.path.map((e=>V(e,r))):null}:q(e)?E(e,r):G(e)||E$1(e)||re(e)?e:null}function C(e){"async"===e.mode&&(e.functions.knowledgegraphbyportalitem=function(t$1,p){return e.standardFunctionAsync(t$1,p,((e,l$1,c)=>{if(ae(c,2,2,t$1,p),null===c[0])throw new a(t$1,r.PortalRequired,p);if(c[0]instanceof t){const e=me(c[1]);let r;r=t$1.services?.portal?t$1.services.portal:C$1.getDefault();return M(l(c[0],r),e)}if(!1===G(c[0]))throw new a(t$1,r.InvalidParameter,p);const f=me(c[0]);return M(t$1.services?.portal??C$1.getDefault(),f)}))},e.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),e.functions.querygraph=function(r$1,i){return e.standardFunctionAsync(r$1,i,(async(e,u,m)=>{ae(m,2,4,r$1,i);const d=m[0];if(!$(d))throw new a(r$1,r.InvalidParameter,i);const g=m[1];if(!G(g))throw new a(r$1,r.InvalidParameter,i);null===F&&(F=await __vitePreload(() => import('./knowledgeGraphService-Ca4yQOHt.js').then(n => n.k),true?__vite__mapDeps([0,1,2,3,4]):void 0,import.meta.url));let h=null;const w=P(m[2],null);if(!(w instanceof N||null===w))throw new a(r$1,r.InvalidParameter,i);if(w){let e=[];h=Q(w,!0,!1,r$1,e),e=e.filter((e=>!e.container[e.indexer].spatialReference.isWGS84)),e.length>0&&await J(e);}const y=new s({openCypherQuery:g,bindParameters:h});(d?.serviceDefinition?.currentVersion??11.3)>11.2&&(y.outputSpatialReference=r$1.spatialReference);const j=(await F.executeQueryStreaming(d,y)).resultRowsStream.getReader(),S=[];try{for(;;){const{done:e,value:t}=await j.read();if(e)break;if(U(t))for(const n of t)S.push(V(n,r$1));else {const e=[];for(const n of t)e.push(V(t[n],r$1));S.push(e);}}}catch(v){throw v}return N.convertJsonToArcade(S,He(r$1),!1,!0)}))},e.signatures.push({name:"querygraph",min:2,max:4}));}

export { C as registerFunctions };
