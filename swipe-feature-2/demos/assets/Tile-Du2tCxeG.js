import{bz as re,bG as oe,l as G,a as fe,w as de,L as me,u as Q,A as pe,S as ge,v as B,x as k,J as _e,bo as ye,d5 as we,ak as ve,j1 as xe,dm as J,gG as Me,eX as Ie,j2 as Se}from"./main-C1jnFJXF.js";import{m as be,b as H}from"./vec2-maR1OrZI.js";import{s as $e}from"./Queue-CmNWFva0.js";import{s as N}from"./ReactiveMap-BIi0AGbF.js";import{r as Be}from"./signal-BCySYmLx.js";import{e as Te}from"./common-DQOJ18NT.js";import{t as Fe}from"./quickselect-QQC62dOK.js";import{a as Ce}from"./Query-Ckfmrrtp.js";let z=class C{static getId(e,t,i,r){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${t}/${i}/${r}`}constructor(e,t,i,r){this.set(e,t,i,r)}get key(){return this}get id(){return this.toString()}get normalizedId(){return`${this.level}/${this.row}/${this.col}`}set id(e){this.set(e)}get hash(){const e=4095&this.row,t=4095&this.col,i=63&this.level;return(3&this.world)<<30|t<<22|e<<8|i}acquire(e,t,i,r){this.set(e,t,i,r)}contains(e){const t=e.level-this.level;return t>=0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}containsChild(e){const t=e.level-this.level;return t>0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new C(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,t,i,r){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[o,l,n,h]=e.split("/");this.level=parseFloat(o),this.row=parseFloat(l),this.col=parseFloat(n),this.world=parseFloat(h)}else this.level=+e,this.row=+t,this.col=+i,this.world=+r||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new C(this.level-1,this.row>>1,this.col>>1,this.world)}getNormalizedNeighbor(e,t,i){const r=this.clone();return r.col+=e,r.row+=t,i.normalizeKey(r),r}getChildKeys(){const e=this.level+1,t=this.row<<1,i=this.col<<1,r=this.world;return[new C(e,t,i,r),new C(e,t,i+1,r),new C(e,t+1,i,r),new C(e,t+1,i+1,r)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}};z.pool=new re(z,null,null,25,50);function P(s,e){return[s,e]}function T(s,e,t){return s[0]=e,s[1]=t,s}function ze(s,e,t,i,r){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}const x=new z("0/0/0/0");let ke=class le{static create(e,t,i=null){const r=oe(e.spatialReference),o=t.origin||P(e.origin.x,e.origin.y),l=P(e.size[0]*t.resolution,e.size[1]*t.resolution),n=P(-1/0,-1/0),h=P(1/0,1/0),a=P(1/0,1/0);i!=null&&(T(n,Math.max(0,Math.floor((i.xmin-o[0])/l[0])),Math.max(0,Math.floor((o[1]-i.ymax)/l[1]))),T(h,Math.max(0,Math.floor((i.xmax-o[0])/l[0])),Math.max(0,Math.floor((o[1]-i.ymin)/l[1]))),T(a,h[0]-n[0]+1,h[1]-n[1]+1));const{cols:c,rows:f}=t;let d,g,_,y;return!i&&c&&f&&(T(n,c[0],f[0]),T(h,c[1],f[1]),T(a,c[1]-c[0]+1,f[1]-f[0]+1)),e.isWrappable?(d=P(Math.ceil(Math.round((r.valid[1]-r.valid[0])/t.resolution)/e.size[0]),a[1]),g=!0,_=r.origin,y=r.valid):(d=a,g=!1),new le(t.level,t.resolution,t.scale,o,n,h,a,l,d,g,_,y)}constructor(e,t,i,r,o,l,n,h,a,c,f,d){this.level=e,this.resolution=t,this.scale=i,this.origin=r,this.first=o,this.last=l,this.size=n,this.norm=h,this.worldSize=a,this.wrap=c,this._spatialReferenceOrigin=f,this._spatialReferenceValid=d}normalizeCol(e){if(!this.wrap)return e;const t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}normalizeKey(e){if(!this.wrap)return;const t=this.worldSize[0],i=e.col;i<0?(e.col=i+t,e.world-=1):i>=t&&(e.col=i-t,e.world+=1)}denormalizeCol(e,t){return this.wrap?this.worldSize[0]*t+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const t=this.origin[0]+e*this.norm[0],i=this._spatialReferenceOrigin,r=this._spatialReferenceValid;return this.wrap&&i&&r?t===i[0]?r[0]:this.origin[0]===i[0]&&e===this.worldSize[0]?r[1]:t:t}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,t,i=!1){x.set(t);const r=i?x.col:this.denormalizeCol(x.col,x.world),o=x.row;return ze(e,this.getXForColumn(r),this.getYForRow(o+1),this.getXForColumn(r+1),this.getYForRow(o)),e}getTileCoords(e,t,i=!1){x.set(t);const r=i?x.col:this.denormalizeCol(x.col,x.world);return Array.isArray(e)?T(e,this.getXForColumn(r),this.getYForRow(x.row)):(e.x=this.getXForColumn(r),e.y=this.getYForRow(x.row)),e}},E=class{constructor(){this.spans=[]}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:t,colFrom:i,colTo:r}of this.spans)for(let o=i;o<=r;o++){const l=e.getWorldForColumn(o);yield new z(e.level,t,e.normalizeCol(o),l)}}forEach(e,t){const{spans:i,lodInfo:r}=this,{level:o}=r;if(i.length!==0)for(const{row:l,colFrom:n,colTo:h}of i)for(let a=n;a<=h;a++)e.call(t,o,l,r.normalizeCol(a),r.getWorldForColumn(a))}};E.pool=new re(E);let j=class{constructor(e,t,i){this.row=e,this.colFrom=t,this.colTo=i}};const p=new z("0/0/0/0");let Pe=class ne{static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[i,r]=e,[o,l]=t,n=o-i,h=l-r,a=h!==0?n/h:0,c=(Math.ceil(r)-r)*a,f=(Math.floor(r)-r)*a;return new ne(i,Math.floor(r),Math.ceil(l),a,n<0?c:f,n<0?f:c,n<0?o:i,n<0?i:o)}constructor(e,t,i,r,o,l,n,h){this.x=e,this.ymin=t,this.ymax=i,this.invM=r,this.leftAdjust=o,this.rightAdjust=l,this.leftBound=n,this.rightBound=h}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const v=[[0,0],[0,0],[0,0],[0,0]],Ye=1e-6;let It=class{constructor(e,t=null,i=e.lods[0].level,r=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=t,this.scales=[],this._infoByScale={},this._infoByLevel={};const o=e.lods.filter(n=>n.level>=i&&n.level<=r);this.minScale=o[0].scale,this.maxScale=o[o.length-1].scale;const l=this._lodInfos=o.map(n=>ke.create(e,n,t));o.forEach((n,h)=>{this._infoByLevel[n.level]=l[h],this._infoByScale[n.scale]=l[h],this.scales[h]=n.scale},this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel[typeof e=="number"?e:e.level]}getTileBounds(e,t,i=!1){p.set(t);const r=this._infoByLevel[p.level];return r?r.getTileBounds(e,p,i):e}getTileCoords(e,t,i=!1){p.set(t);const r=this._infoByLevel[p.level];return r?r.getTileCoords(e,p,i):e}getTileCoverage(e,t=192,i=!0,r="closest"){if(!i&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const o=r==="closest"?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),l=E.pool.acquire(o),n=this._wrap;let h,a,c,f=1/0,d=-1/0;const g=l.spans;v[0][0]=v[0][1]=v[1][1]=v[3][0]=-t,v[1][0]=v[2][0]=e.size[0]+t,v[2][1]=v[3][1]=e.size[1]+t;for(const u of v)e.toMap(u,u),u[0]=o.getColumnForX(u[0]),u[1]=o.getRowForY(u[1]);const _=[];let y=3;for(let u=0;u<4;u++){if(v[u][1]===v[y][1]){y=u;continue}const m=Pe.create(v[u],v[y]);f=Math.min(m.ymin,f),d=Math.max(m.ymax,d),_[m.ymin]===void 0&&(_[m.ymin]=[]),_[m.ymin].push(m),y=u}if(f==null||d==null||d-f>100)return null;let w=[];for(h=f;h<d;){_[h]!=null&&(w=w.concat(_[h])),a=1/0,c=-1/0;for(let u=w.length-1;u>=0;u--){const m=w[u];a=Math.min(a,m.getLeftCol()),c=Math.max(c,m.getRightCol())}if(a=Math.floor(a),c=Math.floor(c),h>=o.first[1]&&h<=o.last[1])if(n)if(o.size[0]<o.worldSize[0]){const u=Math.floor(c/o.worldSize[0]);for(let m=Math.floor(a/o.worldSize[0]);m<=u;m++)g.push(new j(h,Math.max(o.getFirstColumnForWorld(m),a),Math.min(o.getLastColumnForWorld(m),c)))}else g.push(new j(h,a,c));else a>o.last[0]||c<o.first[0]||(a=Math.max(a,o.first[0]),c=Math.min(c,o.last[0]),g.push(new j(h,a,c)));h+=1;for(let u=w.length-1;u>=0;u--){const m=w[u];m.ymax>=h?m.incrRow():w.splice(u,1)}}return l}getTileParentId(e){p.set(e);const t=this._infoByLevel[p.level],i=this._lodInfos.indexOf(t)-1;return i<0?null:(this._getTileIdAtLOD(p,this._lodInfos[i],p),p.id)}getTileResolution(e){const t=this._infoByLevel[typeof e=="object"?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){p.set(t);const i=this._infoByLevel[p.level],r=e.lodInfo;if(r.resolution>i.resolution){this._getTileIdAtLOD(p,r,p);const l=r.denormalizeCol(p.col,p.world);for(const n of e.spans)if(n.row===p.row&&n.colFrom<=l&&n.colTo>=l)return!0}if(r.resolution<i.resolution){const[l,n,h,a]=e.spans.reduce((y,w)=>(y[0]=Math.min(y[0],w.row),y[1]=Math.max(y[1],w.row),y[2]=Math.min(y[2],w.colFrom),y[3]=Math.max(y[3],w.colTo),y),[1/0,-1/0,1/0,-1/0]),c=i.denormalizeCol(p.col,p.world),f=r.getColumnForX(i.getXForColumn(c)),d=r.getRowForY(i.getYForRow(p.row)),g=r.getColumnForX(i.getXForColumn(c+1))-1,_=r.getRowForY(i.getYForRow(p.row+1))-1;return!(f>a||g<h||d>n||_<l)}const o=r.denormalizeCol(p.col,p.world);return e.spans.some(l=>l.row===p.row&&l.colFrom<=o&&l.colTo>=o)}normalizeBounds(e,t,i){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){const r=oe(this.tileInfo.spatialReference),o=-i*(r.valid[1]-r.valid[0]);e[0]+=o,e[2]+=o}return e}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let i=1;i<t.length-1;i++)if(e>t[i]+Ye)return this._infoByScale[t[i-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce((i,r)=>Math.abs(r-e)<Math.abs(i-e)?r:i,t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let i=t.length-1;i>=0;i--)if(e<t[i])return i===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[i]].level+(t[i]-e)/(t[i]-t[i+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,t,i){const r=this._infoByLevel[i.level];return e.set(i),t.resolution<r.resolution?null:(t.resolution===r.resolution||(e.level=t.level,e.col=Math.floor(i.col*r.resolution/t.resolution+.01),e.row=Math.floor(i.row*r.resolution/t.resolution+.01)),e)}},Xe=class{constructor(e,t){this.item=e,this.controller=t,this.promise=null}},Re=class{constructor(e){this._schedule=null,this._task=null,this._deferreds=new N,this._controllers=new N,this._processingItems=new N,this._pausedSignal=Be(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new $e(e.peeker),this.process=e.process;const t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=G(this._schedule),this._task=G(this._task)}get updating(){return!!this._task?.updating||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(t=>e.push(t)),this._controllers.clear(),e.forEach(t=>t.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((t,i)=>e(i))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const i=this.get(e);if(i)return i;const r=new AbortController;let o=null;t&&(o=fe(t,()=>r.abort()));const l=()=>{const c=this._processingItems.get(e);c&&c.controller.abort(),n(),a.reject(Q())},n=()=>{h.remove(),o?.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},h=de(r.signal,l),a=me();return this._deferreds.set(e,a),this._controllers.set(e,r),a.promise.then(n,n),this._queue.push(e),this._scheduleNext(),a.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){const e=this._queue.popLast();return e&&(this._deferreds.get(e)?.reject(Q()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=pe(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(e==null)return;let t;const i=new AbortController,r=new Xe(e,i);this._processingItems.set(e,r);try{t=this.process(e,i.signal)}catch(o){this._processError(r,o)}ge(t)?(r.promise=t,t.then(o=>this._processResult(r,o),o=>this._processError(r,o))):this._processResult(r,t)}get test(){}};const U=[0,0];let b=class extends ye{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:t,scheduler:i,priority:r}=this;this._queue=new Re({concurrency:e,scheduler:i,priority:r,process:(o,l)=>{const n=this._keyToItem.get(o);return t(n,{signal:l})},peeker:o=>this._peek(o)})}destroy(){this.clear(),this._queue=we(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const t=typeof e=="string"?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return typeof e=="string"?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const i=this._queue.push(t),r=this.tileInfoView.getTileScale(e.key),o=ve(this._tilesByScale,r,()=>new Set),l=()=>{o.delete(e.key),o.size===0&&this._tilesByScale.delete(r),this._keyToItem.delete(t)};return o.add(e.key),this._keyToItem.set(t,e),i.then(l,l),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const t=new Set;for(const l of e)t.add(this._keyToItem.get(l).key);const i=this.state.scale;let r,o=Number.POSITIVE_INFINITY;for(const[l,n]of this._tilesByScale)if(xe(n,h=>t.has(h))){const h=Math.abs(l-i);h<o&&(r=n,o=h)}return this._getClosestTileKey(r,e).id}_getClosestTileKey(e,t){const i=this.tileInfoView,r=this.state.center;let o,l=Number.POSITIVE_INFINITY;for(const n of e)if(t.has(n.id)){i.getTileCoords(U,n);const h=be(U,r);h<l&&(l=h,o=n)}return o}};B([k({constructOnly:!0})],b.prototype,"concurrency",void 0),B([k({constructOnly:!0})],b.prototype,"priority",void 0),B([k({constructOnly:!0})],b.prototype,"process",void 0),B([k({constructOnly:!0})],b.prototype,"scheduler",void 0),B([k()],b.prototype,"state",void 0),B([k({constructOnly:!0})],b.prototype,"tileInfoView",void 0),b=B([_e("esri.views.2d.tiling.TileQueue")],b);const Tt=b;let qe=class{constructor(e,t,i){this.maxSize=e,this._tileInfoView=t,this._removedFunc=i,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){const t=this._tilePerId.get(e);if(!t)return;const i=t.key.level,r=this._tileKeysPerLevel[i];ee(this._tilePerId,e);for(let o=0;o<r.length;o++)if(r[o].id===e){r.splice(o,1);break}return t.visible=!0,t}add(e){e.visible=!1;const t=e.key,i=t.id;if(this._tilePerId.has(i))return;this._tilePerId.set(i,e);const r=t.level;this._tileKeysPerLevel[r]||(this._tileKeysPerLevel[r]=[]),this._tileKeysPerLevel[r].push(t)}prune(e,t,i){let r=this._tilePerId.size;if(r<=this.maxSize)return;let o=this._tileKeysPerLevel.length-1;for(;r>this.maxSize&&o>=0;)o!==e&&(r=this._pruneAroundCenterTile(r,t,i,o)),o--;r>this.maxSize&&(r=this._pruneAroundCenterTile(r,t,i,e))}_pruneAroundCenterTile(e,t,i,r){const o=this._tileKeysPerLevel[r];if(!o||o.length===0)return e;const{size:l,origin:n}=this._tileInfoView.tileInfo,h=i*l[0],a=i*l[1],c=[0,0],f=[0,0];for(o.sort((d,g)=>(c[0]=n.x+h*(d.col+.5),c[1]=n.y-a*(d.row+.5),f[0]=n.x+h*(g.col+.5),f[1]=n.y-a*(g.row+.5),H(c,t)-H(f,t)));o.length>0;){const d=o.pop();if(this._removeTile(d.id),--e===this.maxSize)break}return e}_removeTile(e){const t=this._tilePerId.get(e);this._removedFunc&&t&&this._removedFunc(t),ee(this._tilePerId,e)}};function ee(s,e){s.delete(e)}const F=new z(0,0,0,0),S=new Map,R=[],K=[];let Ct=class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,e.resampling!=null&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),e.buffer!=null&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new qe(e.cacheSize,this.tileInfoView,t=>{this.releaseTile(t)}))}destroy(){this.tileIndex.clear()}update(e){const{resampling:t,tileIndex:i}=this,{scale:r,center:o,resolution:l}=e.state,{minScale:n,maxScale:h}=this.tileInfoView,a=!e.stationary&&r>this._previousScale;if(this._previousScale=r,!t&&(r>n||r<h))return this.tiles.length=0,void this.clear();const c=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!c)return this.tiles.length=0,void this.clear();const{spans:f,lodInfo:d}=c,{level:g}=d;this.tiles.length=0,i.forEach(u=>u.visible=!0);let _=0,y=0;if(f.length>0)for(const{row:u,colFrom:m,colTo:A}of f)for(let $=m;$<=A;$++){_++;const M=F.set(g,u,d.normalizeCol($),d.getWorldForColumn($)).id;let I=i.get(M);if(I)I.isReady?(S.set(M,I),y++):a||this._addParentTile(M,S);else{if(this._tileCache?.has(M)){if(I=this._tileCache.pop(M),this.tileIndex.set(M,I),I.isReady){S.set(M,I),y++;continue}}else I=this.acquireTile(F),this.tileIndex.set(M,I);a||this._addParentTile(M,S)}}const w=y===_;for(const[u,m]of i){if(S.has(u))continue;F.set(u);const A=this.tileInfoView.intersects(c,F),$=this.cachePolicy==="purge"?F.level!==g:F.level>g;!A||!a&&w?!$&&A||R.push(m):m.isReady?$&&this.cachePolicy==="purge"&&this._hasReadyAncestor(F,g)?R.push(m):K.push(m):$&&R.push(m)}for(const u of K)u.isReady&&S.set(u.key.id,u);for(const u of R)this._tileCache?this._tileCache.add(u):this.releaseTile(u),i.delete(u.key.id);for(const u of S.values())this.tiles.push(u);for(const u of i.values())S.has(u.key.id)||(u.visible=!1);this._tileCache?.prune(g,o,l),E.pool.release(c),K.length=0,R.length=0,S.clear()}clear(){const{tileIndex:e}=this;for(const t of e.values())this.releaseTile(t);e.clear()}refresh(e){for(const t of this.tileIndex.values())e(t);this._tileCache?.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,t){let i=e,r=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(r=this.tileIndex.get(i),r?.isReady){t.has(r.key.id)||t.set(r.key.id,r);break}}else if(this._tileCache?.has(i)&&(r=this._tileCache.pop(i),this.tileIndex.set(i,r),r?.isReady)){t.has(r.key.id)||t.set(r.key.id,r);break}}_hasReadyAncestor(e,t){const i=J();this.tileInfoView.getTileBounds(i,e,!0);for(const r of this.tileIndex.values())if(r.isReady&&r.key.level>=t&&r.key.level<e.level){const o=J();if(this.tileInfoView.getTileBounds(o,r.key,!0),Me(o,i))return!0}return!1}};function Le(){const s=new Float32Array(6);return s[0]=1,s[3]=1,s}function Ae(s){const e=new Float32Array(6);return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e}function Oe(s,e,t,i,r,o){const l=new Float32Array(6);return l[0]=s,l[1]=e,l[2]=t,l[3]=i,l[4]=r,l[5]=o,l}function Ve(s,e){return new Float32Array(s,e,6)}function he(s,e,t,i){const r=e[i],o=e[i+1];s[i]=t[0]*r+t[2]*o+t[4],s[i+1]=t[1]*r+t[3]*o+t[5]}function Ee(s,e,t,i=0,r=0,o=2){const l=r||e.length/o;for(let n=i;n<l;n++)he(s,e,t,n*o)}Object.freeze(Object.defineProperty({__proto__:null,clone:Ae,create:Le,createView:Ve,fromValues:Oe,transform:he,transformMany:Ee},Symbol.toStringTag,{value:"Module"}));function Ne(s,e){return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s}function je(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=1,s[4]=0,s[5]=0,s}function Ke(s,e,t,i,r,o,l){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s[4]=o,s[5]=l,s}function We(s,e){const t=e[0],i=e[1],r=e[2],o=e[3],l=e[4],n=e[5];let h=t*o-i*r;return h?(h=1/h,s[0]=o*h,s[1]=-i*h,s[2]=-r*h,s[3]=t*h,s[4]=(r*n-o*l)*h,s[5]=(i*l-t*n)*h,s):null}function De(s){return s[0]*s[3]-s[1]*s[2]}function ae(s,e,t){const i=e[0],r=e[1],o=e[2],l=e[3],n=e[4],h=e[5],a=t[0],c=t[1],f=t[2],d=t[3],g=t[4],_=t[5];return s[0]=i*a+o*c,s[1]=r*a+l*c,s[2]=i*f+o*d,s[3]=r*f+l*d,s[4]=i*g+o*_+n,s[5]=r*g+l*_+h,s}function Je(s,e,t){const i=e[0],r=e[1],o=e[2],l=e[3],n=e[4],h=e[5],a=Math.sin(t),c=Math.cos(t);return s[0]=i*c+o*a,s[1]=r*c+l*a,s[2]=i*-a+o*c,s[3]=r*-a+l*c,s[4]=n,s[5]=h,s}function Ze(s,e,t){const i=e[0],r=e[1],o=e[2],l=e[3],n=e[4],h=e[5],a=t[0],c=t[1];return s[0]=i*a,s[1]=r*a,s[2]=o*c,s[3]=l*c,s[4]=n,s[5]=h,s}function Ge(s,e,t){const i=e[0],r=e[1],o=e[2],l=e[3],n=e[4],h=e[5],a=t[0],c=t[1];return s[0]=i,s[1]=r,s[2]=o,s[3]=l,s[4]=i*a+o*c+n,s[5]=r*a+l*c+h,s}function Qe(s,e){const t=Math.sin(e),i=Math.cos(e);return s[0]=i,s[1]=t,s[2]=-t,s[3]=i,s[4]=0,s[5]=0,s}function He(s,e){return s[0]=e[0],s[1]=0,s[2]=0,s[3]=e[1],s[4]=0,s[5]=0,s}function Ue(s,e){return s[0]=1,s[1]=0,s[2]=0,s[3]=1,s[4]=e[0],s[5]=e[1],s}function et(s){return"mat2d("+s[0]+", "+s[1]+", "+s[2]+", "+s[3]+", "+s[4]+", "+s[5]+")"}function tt(s){return Math.sqrt(s[0]**2+s[1]**2+s[2]**2+s[3]**2+s[4]**2+s[5]**2+1)}function st(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s[4]=e[4]+t[4],s[5]=e[5]+t[5],s}function ce(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s[3]=e[3]-t[3],s[4]=e[4]-t[4],s[5]=e[5]-t[5],s}function it(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s[4]=e[4]*t,s[5]=e[5]*t,s}function rt(s,e,t,i){return s[0]=e[0]+t[0]*i,s[1]=e[1]+t[1]*i,s[2]=e[2]+t[2]*i,s[3]=e[3]+t[3]*i,s[4]=e[4]+t[4]*i,s[5]=e[5]+t[5]*i,s}function ot(s,e){return s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2]&&s[3]===e[3]&&s[4]===e[4]&&s[5]===e[5]}function lt(s,e){const t=s[0],i=s[1],r=s[2],o=s[3],l=s[4],n=s[5],h=e[0],a=e[1],c=e[2],f=e[3],d=e[4],g=e[5],_=Te();return Math.abs(t-h)<=_*Math.max(1,Math.abs(t),Math.abs(h))&&Math.abs(i-a)<=_*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-c)<=_*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(o-f)<=_*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(l-d)<=_*Math.max(1,Math.abs(l),Math.abs(d))&&Math.abs(n-g)<=_*Math.max(1,Math.abs(n),Math.abs(g))}const nt=ae,ht=ce;Object.freeze(Object.defineProperty({__proto__:null,add:st,copy:Ne,determinant:De,equals:lt,exactEquals:ot,frob:tt,fromRotation:Qe,fromScaling:He,fromTranslation:Ue,identity:je,invert:We,mul:nt,multiply:ae,multiplyScalar:it,multiplyScalarAndAdd:rt,rotate:Je,scale:Ze,set:Ke,str:et,sub:ht,subtract:ce,translate:Ge},Symbol.toStringTag,{value:"Module"}));function Z(s,e){if(!(this instanceof Z))return new Z(s,e);this._maxEntries=Math.max(4,s||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function at(s,e,t){if(!t)return e.indexOf(s);for(var i=0;i<e.length;i++)if(t(s,e[i]))return i;return-1}function Y(s,e){q(s,0,s.children.length,e,s)}function q(s,e,t,i,r){r||(r=X(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o,l=e;l<t;l++)o=s.children[l],L(r,s.leaf?i(o):o);return r}function L(s,e){return s.minX=Math.min(s.minX,e.minX),s.minY=Math.min(s.minY,e.minY),s.maxX=Math.max(s.maxX,e.maxX),s.maxY=Math.max(s.maxY,e.maxY),s}function te(s,e){return s.minX-e.minX}function se(s,e){return s.minY-e.minY}function W(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function O(s){return s.maxX-s.minX+(s.maxY-s.minY)}function ct(s,e){return(Math.max(e.maxX,s.maxX)-Math.min(e.minX,s.minX))*(Math.max(e.maxY,s.maxY)-Math.min(e.minY,s.minY))}function ut(s,e){var t=Math.max(s.minX,e.minX),i=Math.max(s.minY,e.minY),r=Math.min(s.maxX,e.maxX),o=Math.min(s.maxY,e.maxY);return Math.max(0,r-t)*Math.max(0,o-i)}function D(s,e){return s.minX<=e.minX&&s.minY<=e.minY&&e.maxX<=s.maxX&&e.maxY<=s.maxY}function V(s,e){return e.minX<=s.maxX&&e.minY<=s.maxY&&e.maxX>=s.minX&&e.maxY>=s.minY}function X(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ie(s,e,t,i,r){for(var o,l=[e,t];l.length;)(t=l.pop())-(e=l.pop())<=i||(o=e+Math.ceil((t-e)/i/2)*i,Fe(s,o,e,t,r),l.push(e,o,o,t))}Z.prototype={all:function(){return this._all(this.data,[])},search:function(s){var e=this.data,t=[],i=this.toBBox;if(!V(s,e))return t;for(var r,o,l,n,h=[];e;){for(r=0,o=e.children.length;r<o;r++)l=e.children[r],V(s,n=e.leaf?i(l):l)&&(e.leaf?t.push(l):D(s,n)?this._all(l,t):h.push(l));e=h.pop()}return t},collides:function(s){var e=this.data,t=this.toBBox;if(!V(s,e))return!1;for(var i,r,o,l,n=[];e;){for(i=0,r=e.children.length;i<r;i++)if(o=e.children[i],V(s,l=e.leaf?t(o):o)){if(e.leaf||D(s,l))return!0;n.push(o)}e=n.pop()}return!1},load:function(s){if(!s||!s.length)return this;if(s.length<this._minEntries){for(var e=0,t=s.length;e<t;e++)this.insert(s[e]);return this}var i=this._build(s.slice(),0,s.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var r=this.data;this.data=i,i=r}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(s){return s!=null&&this._insert(s,this.data.height-1),this},clear:function(){return this.data=X([]),this},remove:function(s,e){if(s==null)return this;for(var t,i,r,o,l=this.data,n=this.toBBox(s),h=[],a=[];l||h.length;){if(l||(l=h.pop(),i=h[h.length-1],t=a.pop(),o=!0),l.leaf&&(r=at(s,l.children,e))!==-1)return l.children.splice(r,1),h.push(l),this._condense(h),this;o||l.leaf||!D(l,n)?i?(t++,l=i.children[t],o=!1):l=null:(h.push(l),a.push(t),t=0,i=l,l=l.children[0])}return this},toBBox:function(s){return s},compareMinX:te,compareMinY:se,toJSON:function(){return this.data},fromJSON:function(s){return this.data=s,this},_all:function(s,e){for(var t=[];s;)s.leaf?e.push.apply(e,s.children):t.push.apply(t,s.children),s=t.pop();return e},_build:function(s,e,t,i){var r,o=t-e+1,l=this._maxEntries;if(o<=l)return Y(r=X(s.slice(e,t+1)),this.toBBox),r;i||(i=Math.ceil(Math.log(o)/Math.log(l)),l=Math.ceil(o/Math.pow(l,i-1))),(r=X([])).leaf=!1,r.height=i;var n,h,a,c,f=Math.ceil(o/l),d=f*Math.ceil(Math.sqrt(l));for(ie(s,e,t,d,this.compareMinX),n=e;n<=t;n+=d)for(ie(s,n,a=Math.min(n+d-1,t),f,this.compareMinY),h=n;h<=a;h+=f)c=Math.min(h+f-1,a),r.children.push(this._build(s,h,c,i-1));return Y(r,this.toBBox),r},_chooseSubtree:function(s,e,t,i){for(var r,o,l,n,h,a,c,f;i.push(e),!e.leaf&&i.length-1!==t;){for(c=f=1/0,r=0,o=e.children.length;r<o;r++)h=W(l=e.children[r]),(a=ct(s,l)-h)<f?(f=a,c=h<c?h:c,n=l):a===f&&h<c&&(c=h,n=l);e=n||e.children[0]}return e},_insert:function(s,e,t){var i=this.toBBox,r=t?s:i(s),o=[],l=this._chooseSubtree(r,this.data,e,o);for(l.children.push(s),L(l,r);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(r,o,e)},_split:function(s,e){var t=s[e],i=t.children.length,r=this._minEntries;this._chooseSplitAxis(t,r,i);var o=this._chooseSplitIndex(t,r,i),l=X(t.children.splice(o,t.children.length-o));l.height=t.height,l.leaf=t.leaf,Y(t,this.toBBox),Y(l,this.toBBox),e?s[e-1].children.push(l):this._splitRoot(t,l)},_splitRoot:function(s,e){this.data=X([s,e]),this.data.height=s.height+1,this.data.leaf=!1,Y(this.data,this.toBBox)},_chooseSplitIndex:function(s,e,t){var i,r,o,l,n,h,a,c;for(h=a=1/0,i=e;i<=t-e;i++)l=ut(r=q(s,0,i,this.toBBox),o=q(s,i,t,this.toBBox)),n=W(r)+W(o),l<h?(h=l,c=i,a=n<a?n:a):l===h&&n<a&&(a=n,c=i);return c},_chooseSplitAxis:function(s,e,t){var i=s.leaf?this.compareMinX:te,r=s.leaf?this.compareMinY:se;this._allDistMargin(s,e,t,i)<this._allDistMargin(s,e,t,r)&&s.children.sort(i)},_allDistMargin:function(s,e,t,i){s.children.sort(i);var r,o,l=this.toBBox,n=q(s,0,e,l),h=q(s,t-e,t,l),a=O(n)+O(h);for(r=e;r<t-e;r++)o=s.children[r],L(n,s.leaf?l(o):o),a+=O(n);for(r=t-e-1;r>=e;r--)o=s.children[r],L(h,s.leaf?l(o):o),a+=O(h);return a},_adjustParentBBoxes:function(s,e,t){for(var i=t;i>=0;i--)L(e[i],s)},_condense:function(s){for(var e,t=s.length-1;t>=0;t--)s[t].children.length===0?t>0?(e=s[t-1].children).splice(e.indexOf(s[t]),1):this.clear():Y(s[t],this.toBBox)},_initFormat:function(s){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(s[0])),this.compareMinY=new Function("a","b",e.join(s[1])),this.toBBox=new Function("a","return {minX: a"+s[0]+", minY: a"+s[1]+", maxX: a"+s[2]+", maxY: a"+s[3]+"};")}};function ft(s,{timeZone:e,timeExtent:t}){return{$view:{scale:s,timeZone:e,timeProperties:{currentStart:t?.start,currentEnd:t?.end}}}}class ue{constructor(e,t){this.key=new z(0,0,0,0),this.bounds=J(),this.objectIds=new Set,this.key.set(t);const i=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=i.resolution,this.level=i.level,this.scale=i.scale,this.minScale=e.zoomToScale(i.level-1),this.maxScale=e.zoomToScale(i.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return Ie(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return ft(this.scale,e)}createChildTiles(){const e=this.key.getChildKeys(),t=Se.acquire();for(let i=0;i<e.length;i++)t[i]=new ue(this.tileInfoView,e[i]);return t}getQuantizationParameters(){return Ce.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}export{Qe as M,Ge as a,je as b,Je as c,Ke as d,z as e,ae as f,Ze as g,It as h,Z as i,Ee as j,ft as k,ue as l,Ue as m,Le as n,He as o,Tt as p,Ct as r,E as s,We as u};
