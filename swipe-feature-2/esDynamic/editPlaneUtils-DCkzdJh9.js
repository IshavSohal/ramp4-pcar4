import{o as l,q as p,aC as U,G as T,bD as vt,X as kn,gi as Vn,eG as In,K as zn,gr as An,eF as Gn,Y as Un,fi as Fn,M as Wt,bo as he,bb as _t,V as Nt,bm as ot,L as Hn,bC as st,b8 as me,fx as ge,db as ye,fN as jt,l as fe,dt as Yt,jp as Dn,jD as Zn,c7 as D,ee as qt,fe as Ln,e_ as wt,d2 as q,aB as Bt,eY as Wn,aw as C,bV as Xt,cl as Nn,ck as jn,jE as ve,aM as Yn,e5 as qn,c2 as _e,jF as Bn,b9 as Kt,g_ as we,e1 as $t,cG as Xn,aS as xe,aT as Kn,a_ as $n,N as xt,ay as Qn,fg as be}from"./main-BfV_Ya13.js";import{t as Se}from"./memoize-DZv29EwT.js";import{t as Jn}from"./ReactiveSet-Bfy953LE.js";import{y as ti}from"./defaultCIMValues-BdszZujA.js";import{h as Me}from"./UpdatingHandles-BMR5uPT-.js";import{a1 as bt,Q as Qt,c as B,S as ei,a2 as Te,a3 as Oe,P as ni,a4 as X,a0 as K,a5 as Pe,a6 as ii,M as oi,m as si,a7 as Ce,a8 as ri,g as ai,o as Ee,W as Re,a9 as li,aa as ci,V as pi,ab as ke,ac as ui,ad as di,ae as hi,i as Ve}from"./SketchOptions-CFCypsHU.js";import{l as mi}from"./ViewingMode-CyR_b1T8.js";import{E as Jt,e as te,P as gi,p as yi,c as fi,h as rt,k as vi,R as _i,y as Ie,F as ze,Q as wi,w as xi,u as Ae,t as bi,d as Si,f as Mi,g as Ti}from"./automaticAreaMeasurementUtils-DsEu5smJ.js";import{O as St}from"./projection-Xiqt9C3K.js";import{c as Oi}from"./meshVertexSpaceUtils-Cg5IE_oz.js";import{k as Pi,x as Mt}from"./hydratedFeatures-D8n6efsO.js";import{g as Ge,F as Ue}from"./Scheduler-62aspnrG.js";import{e as ee,a as Tt}from"./projectVectorToVector-j40_kZ30.js";import{r as Z,V as Ci,c as Ei,m as Ot,a as Ri,j as ki,R as Vi,b as Ii,d as zi,O as Ai}from"./automaticLengthMeasurementUtils-CJ5UfyeN.js";import Gi from"./GraphicsLayer-Cvv_Hl69.js";import{c as Fe,s as Ui,u as Pt,g as ne,P as Fi,A as Hi,_ as Di,Q as He,I as Zi,o as De,w as Ze}from"./vec32-D2jQCZiP.js";import{j as Li,N as Wi}from"./geodesicUtils-DV1oOM9p.js";import{y as Ni,l as ji}from"./geodesicLengthMeasurementUtils-BooX-zQm.js";import{u as Yi}from"./Tile-DS3MuxfO.js";import{C as L,D as Le,F as qi}from"./MapView-CfcyJ-YQ.js";import{R as Bi,L as Xi}from"./quat-DUiVHAKf.js";import{e as We}from"./quatf64-C16JxGFv.js";import{f as Ct,a as Ne,o as Ki,d as at,h as W,j as $i}from"./quantityUtils-DXFBqyQk.js";import{o as lt,j as je,f as Qi,M as Ji,e as to,u as eo,l as Ye,k as qe}from"./vec2-BnynUbeJ.js";import{W as no,K as Et}from"./boundedPlane-CA4ff9MG.js";import{t as ct}from"./plane-tjMJ7XU0.js";var ie;let F=ie=class extends vt{constructor(t){super(t),this.center=null,this.geodesic=!1,this.numberOfPoints=60,this.radius=1e3,this.radiusUnit="meters"}initialize(){const t=this.center,e=this.numberOfPoints;if(this.hasZ=t?.hasZ??!1,this.rings.length!==0||!t)return;const n=kn(this.radius,this.radiusUnit,"meters"),i=t.spatialReference;let o,s="geographic";if(i.isWebMercator?s="webMercator":((i.wkid&&Vn[i.wkid])!=null||(i.wkt2||i.wkt)&&In(i.wkt2||i.wkt))&&(s="projected"),this.geodesic){let r;switch(s){case"webMercator":r=zn(t);break;case"projected":console.error("Creating a geodesic circle requires the center to be specified in web mercator or geographic coordinate system");break;case"geographic":r=t}o=this._createGeodesicCircle(r,n,e),s==="webMercator"&&(o=An(o))}else{let r;s==="webMercator"||s==="projected"?r=n/Gn(t.spatialReference):s==="geographic"&&(r=Un(n,"meters",Fn(t.spatialReference).radius)),o=this._createPlanarCircle(t,r,e)}this.spatialReference=o.spatialReference,this.addRing(o.rings[0])}clone(){const{center:t,numberOfPoints:e,radius:n,radiusUnit:i,geodesic:o}=this;return new ie({center:t?.clone(),numberOfPoints:e,radius:n,radiusUnit:i,geodesic:o})}_createGeodesicCircle(t,e,n){const i=[],o=[t.x,t.y];for(let s=0;s<360;s+=360/n){const r=this.hasZ?[0,0,t.z??0]:[0,0];Li(r,o,s,e,Wt.WGS84),i.push(r)}return i.push(i[0]),new vt({rings:[i]})}_createPlanarCircle(t,e,n){const i=[],o=2*Math.PI/n;for(let s=0;s<n;++s){const r=o*s,a=[t.x+Math.cos(-r)*e,t.y+Math.sin(-r)*e];this.hasZ&&a.push(t.z??0),i.push(a)}return i.push(i[0]),new vt({spatialReference:t.spatialReference,rings:[i]})}};l([p({type:U})],F.prototype,"center",void 0),l([p()],F.prototype,"geodesic",void 0),l([p()],F.prototype,"numberOfPoints",void 0),l([p()],F.prototype,"radius",void 0),l([p()],F.prototype,"radiusUnit",void 0),F=ie=l([T("esri.geometry.Circle")],F);const io=F;function pt(t,e){return t===e||t!=null&&e!=null&&he(t.spatialReference,e.spatialReference)&&t.x===e.x&&t.y===e.y&&t.z===e.z&&t.m===e.m}function oe(t,e,n){return t===e||t!=null&&e!=null&&he(t.spatialReference,e.spatialReference)&&_t(t.x,e.x,n)&&_t(t.y,e.y,n)&&_t(t.z??0,e.z??0,n)&&_t(t.m??0,e.m??0,n)}var N;(function(t){t[t.WhenToolEditable=0]="WhenToolEditable",t[t.WhenToolNotEditable=1]="WhenToolNotEditable",t[t.Always=2]="Always"})(N||(N={}));let oo=class{constructor(){this._isToolEditable=!0,this._manipulators=new Nt,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=N.WhenToolEditable){this.addMany([t],e)}addMany(t,e=N.WhenToolEditable){for(const n of t){const i={manipulator:n,visibilityPredicate:e,attached:!1};this._manipulators.add(i),this._attached&&this._updateManipulatorAttachment(i)}}remove(t){for(let e=0;e<this._manipulators.length;e++)if(this._manipulators.at(e).manipulator===t){const n=this._manipulators.splice(e,1)[0];this._detachManipulator(n);break}}removeAll(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(t=>{this._updateManipulatorAttachment(t)}),this._attached=!0}detach(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach(({manipulator:t})=>t.destroy()),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,n=>{e(n)})}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach(e=>t.push(e.manipulator)),t}intersect(t,e){let n=null,i=Number.MAX_VALUE;return this._manipulators.forEach(({manipulator:o,attached:s})=>{if(!s||!o.interactive)return;const r=o.intersectionDistance(t,e);r!=null&&r<i&&(i=r,n=o)}),n}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===N.Always||(this._isToolEditable?t.visibilityPredicate===N.WhenToolEditable:t.visibilityPredicate===N.WhenToolNotEditable)}},M=class extends ot{constructor(t){super(t),this.manipulators=new oo,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[L.MANAGER,!0],[L.USER,!0]]),this._creationFinishedResolver=Hn()}get active(){return this.view!=null&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(L.USER)}set editable(t){this.setEditableFlag(L.USER,t)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){this.view!=null&&(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===L.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){return this._editableFlags.get(t)??!1}endDrag(){const t=this.view.inputManager.latestPointerLocation;if(!t)return;let e=!1;this.manipulators.forEach(({manipulator:n})=>{n.dragging&&(e=!0,n.events.emit("drag",{action:"end",start:t,screenPoint:t}))}),e&&(this.view.toolViewManager.activeTool=null)}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(L.USER)&&this.getEditableFlag(L.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized){if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};l([p({constructOnly:!0})],M.prototype,"view",void 0),l([p({readOnly:!0})],M.prototype,"active",null),l([p({value:!0})],M.prototype,"visible",null),l([p({value:!0})],M.prototype,"editable",null),l([p({readOnly:!0})],M.prototype,"manipulators",void 0),l([p({readOnly:!0})],M.prototype,"updating",null),l([p()],M.prototype,"cursor",null),l([p({readOnly:!0})],M.prototype,"automaticManipulatorSelection",void 0),l([p()],M.prototype,"hasFocusedManipulators",null),l([p()],M.prototype,"hasGrabbedManipulators",void 0),l([p()],M.prototype,"hasHoveredManipulators",void 0),l([p()],M.prototype,"firstGrabbedManipulator",void 0),l([p({readOnly:!0})],M.prototype,"created",void 0),l([p({readOnly:!0})],M.prototype,"removeIncompleteOnCancel",void 0),M=l([T("esri.views.interactive.InteractiveToolBase")],M);function so(t,e){let n=null,i=null;return o=>{if(o.action==="cancel")return void(i!=null&&(i.execute({action:"cancel"}),n=null,i=null));const s={action:o.action,screenStart:o.start,screenEnd:o.screenPoint};o.action==="start"&&n==null&&(n=new kt,i=new kt,e(t,n,i,o.pointerType,s)),n?.execute(s),o.action==="end"&&n!=null&&(n=null,i=null)}}function Rt(t,e){return t.events.on("drag",so(t,e))}function ro(t,e){const n=[t.x,t.y,t.z??0],i=e,o=[Math.cos(i),Math.sin(i)],s=Math.sqrt(o[0]*o[0]+o[1]*o[1]);if(s===0)return null;o[0]/=s,o[1]/=s;const r=a=>{const c=(a.x-n[0])*o[0]+(a.y-n[1])*o[1];a.x=n[0]+c*o[0],a.y=n[1]+c*o[1]};return a=>(r(a.mapStart),r(a.mapEnd),{...a,axis:o})}function Be(t){let e=null;return n=>{if(n.action==="start"&&(e=ao(t,n.mapStart.spatialReference)),e==null)return null;const i=n.mapEnd.x-n.mapStart.x,o=n.mapEnd.y-n.mapStart.y,s=(n.mapEnd.z??0)-(n.mapStart.z??0);return e.move(i,o,s,n.action),{...n,translationX:i,translationY:o,translationZ:s}}}function Xe(t,e){return t==null?null:t.spatialReference.equals(e)?t.clone():St(t,e)}function ao(t,e){const n=t.operations;if(!n)return null;const i=n.data.geometry,o=Pi(e);if(i.spatialReference.equals(o))return se(t,n,()=>{});if(i.type!=="mesh"){const s=Xe(i,o);if(s==null)return null;const r=i.spatialReference;return se(t,Jt.fromGeometry(s,n.viewingMode),()=>{const a=St(i,r);n.trySetGeometry(a)})}if(Oi(i)){const s=Xe(i.origin,o);if(!s)return null;const r=i.spatialReference,a=Jt.fromGeometry(s,n.viewingMode);return se(t,n,()=>{const c=St(a.data.geometry,r),u=c.x-i.origin.x,d=c.y-i.origin.y,m=(c.z??0)-(i.origin.z??0);n.move(u,d,m)})}return null}function se(t,e,n){let i=0,o=0,s=0;return{move:(r,a,c,u)=>{u==="start"&&(i=0,o=0,s=0);const d=r-i,m=a-o,f=c-s;e.move(d,m,f),i+=d,o+=m,s+=f,n(),u==="end"&&t.endInteraction?.()}}}function lo(t,e=null,n){let i=null;const o=e==null||t.spatialReference?.equals(e)?r=>r:r=>r!=null?St(r,e):r,s={exclude:[],...n};return r=>{if(r.action==="start"&&(i=o(t.toMap(r.screenStart,s))),i==null)return null;const a=o(t.toMap(r.screenEnd,s));return a!=null?{...r,mapStart:i,mapEnd:a}:null}}function co(t){const e=t.map(n=>Be(n)).filter(st);return n=>{const i=n.mapEnd.x-n.mapStart.x,o=n.mapEnd.y-n.mapStart.y,s=n.mapEnd.z-n.mapStart.z;return e.forEach(r=>r(n)),{...n,translationX:i,translationY:o,translationZ:s}}}function Ke(t){const e=t.operations?.createResetState();return n=>(e?.remove(),n)}function po(t){const e=t.map(n=>Ke(n)).filter(n=>n!=null);return n=>(e.forEach(i=>i(n)),n)}function uo(){let t=0,e=0,n=0;return i=>{i.action==="start"&&(t=i.mapStart.x,e=i.mapStart.y,n=i.mapStart.z);const o=i.mapEnd.x-t,s=i.mapEnd.y-e,r=i.mapEnd.z-n;return t=i.mapEnd.x,e=i.mapEnd.y,n=i.mapEnd.z,{...i,mapDeltaX:o,mapDeltaY:s,mapDeltaZ:r,mapDeltaSpatialReference:i.mapStart.spatialReference}}}function ho(){let t=0,e=0;return n=>{n.action==="start"&&(t=n.screenStart.x,e=n.screenStart.y);const i=n.screenEnd.x-t,o=n.screenEnd.y-e;return t=n.screenEnd.x,e=n.screenEnd.y,{...n,screenDeltaX:i,screenDeltaY:o}}}function mo(t,e){let n=null,i=0,o=0;return s=>{if(s.action==="start"&&(n=t.toScreen?.(e),n!=null&&(n.x<0||n.x>t.width||n.y<0||n.y>t.height?n=null:(i=s.screenStart.x-n.x,o=s.screenStart.y-n.y))),n==null)return null;const r=me(s.screenEnd.x-i,0,t.width),a=me(s.screenEnd.y-o,0,t.height),c=ge(r,a);return s.screenStart=n,s.screenEnd=c,s}}const go=()=>{};let kt=class On{constructor(){this.execute=go}next(e,n=new On){return e!=null&&(this.execute=i=>{const o=e(i);o!=null&&n.execute(o)}),n}};function $e(t,e,n=[]){if(t.type==="2d")return o=>o;let i=null;return o=>{o.action==="start"&&(i=t.toMap(o.screenStart,{exclude:n}),i!=null&&(i.z=bt(i,t,e)));const s=t.toMap(o.screenEnd,{exclude:n});s!=null&&(s.z=bt(s,t,e));const r=i!=null&&s!=null?{sceneStart:i,sceneEnd:s}:null;return{...o,scenePoints:r}}}function Qe(t,e,n){const i=e.elevationProvider.getElevation(t.x,t.y,t.z??0,t.spatialReference,"scene")??0,o=Mt(t);return o.z=i,o.hasZ=!0,o.z=bt(o,e,n),o}function yo(t,e){if(t.type==="2d")return i=>i;let n=null;return i=>{i.action==="start"&&(n=Qe(i.mapStart,t,e));const o=Qe(i.mapEnd,t,e),s=n!=null&&o!=null?{sceneStart:n,sceneEnd:o}:null;return{...i,scenePoints:s}}}let j=class extends ot{constructor(t){super(t),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=ye(async(e,n,i,o)=>{const s=this._frameTask;if(s==null)return;const r=await s.schedule(()=>n.snap({...e,context:i,signal:o}),o);r.valid&&await s.schedule(()=>{this.stagedPoint=r.apply(),e!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=n.update({...this._snapPoints,context:i}))},o)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(t){this._stagedPoint=this.constrainResult(t)}initialize(){const t=this.view.type==="3d"?this.view?.resourceController?.scheduler:null;this._frameTask=t!=null?t.registerTask(Ge.SNAPPING):Ue}destroy(){this._abortController=jt(this._abortController),this._frameTask=fe(this._frameTask)}update(t,e,n){this._snapPoints=t;const{point:i,scenePoint:o}=t,s=e.update({point:i,scenePoint:o,context:n});return this.stagedPoint=s,s}async snap(t,e,n){const{point:i,scenePoint:o}=t;return this.stagedPoint=e.update({point:i,scenePoint:o,context:n}),this._snapPoints=t,this._abortController==null&&(this._abortController=new AbortController),this._snap(t,e,n,this._abortController.signal)}async snapAgainNearPreviousMapPoint(t,e){this._snapPoints!=null&&await this.snap(this._snapPoints,t,e)}abort(){this._abortController=jt(this._abortController),this._snapPoints=null}};l([p({constructOnly:!0})],j.prototype,"view",void 0),l([p()],j.prototype,"stagedPoint",null),l([p()],j.prototype,"constrainResult",void 0),l([p()],j.prototype,"_stagedPoint",void 0),j=l([T("esri.views.interactive.snapping.SnappingOperation")],j);const Je="click";let fo=class{constructor({consumesClicks:t,grabbableForEvent:e}){this.events=new Yt,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.consumesClicks=t,this.grabbableForEvent=e}destroy(){}intersectionDistance(t,e){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};function vo(t,e,n,i,o,s){let r="geodesic",a=Wi(n);const c=B();return Qt(t,e,i,c),c[2]=0,a&&Tt(c,n,c,a)||(r="euclidean",a=n),{mode:r,view:e,elevationInfo:i,hasZ:o,directionMode:s,spatialReference:t.spatialReference,measurementSR:a,origin:c}}function _o(t,e,n){if(e==null||t==null)return;const i=Zn(n.measurementSR);if(i==null)return;const o=Vt(t,n);if(o==null)return;const s=Ct(e,i);return new ni(o,s)}function wo(t,e,n,i){if(n==null||t==null)return;const o=Vt(t,i);if(o==null)return;const s=X(n),r=10,a=u=>{if(u==null)return;const d=B(),m=Ki(u,"degrees","geographic");return oi(d,o,i.measurementSR,r,m,i.mode)?new si(o,d):void 0},c=()=>{if(e!=null&&t!=null)return X(Ce(e,t))};switch(i.directionMode){case K.Absolute:return a(s);case K.Relative:{const u=c();return u==null?void 0:a(u+s)}case K.RelativeBilateral:{const u=c();return u==null?void 0:Pe([a(u+s),a(u-s)])}}}function tn(t,e){const n=It(t,e);return n!=null?new ii(n):void 0}function en(t,e,n){const{context:i,longitude:o,latitude:s,direction:r,distance:a,elevation:c}=n;if(o!=null||s!=null||a!=null||c!=null||r!=null){if(o!=null||s!=null){const u=X(o),d=X(s),m=It(c,i);return new Te(u,d,m)}return xo(t,e,n)}}function xo(t,e,{context:n,direction:i,distance:o,elevation:s}){if(e==null)return tn(s,n);const{view:r,elevationInfo:a,measurementSR:c}=n,u=Qt(e,r,a);if(!c||!Tt(u,e.spatialReference,on,c))return;const[d,m]=on,f=o!=null?Ct(o,"meters"):void 0,h=X(i),v=It(s,n),g=w=>{const S=new ri([d,m],c,f,v,w);return f==null||w==null||v==null&&n.hasZ?S:new ai(S.closestTo(u))};if(h==null)return g(void 0);const b=()=>{if(t!=null&&e!=null)return X(Ce(t,e))};switch(n.directionMode){case K.Absolute:return g(h);case K.Relative:{const w=b();return w==null?void 0:g(w+h)}case K.RelativeBilateral:{const w=b();return w==null?void 0:Pe([g(w+h),g(w-h)])}}}function bo(t){return t.context.mode==="geodesic"?en(null,null,t):nn(t)}function So(t,e,n){const{context:i,x:o,y:s,distance:r,direction:a,elevation:c}=n;return i.mode==="geodesic"?en(e,t,n):o!=null||s!=null?nn(n):Mo([_o(t,r,i),wo(t,e,a,i),tn(c,i)])}function nn({x:t,y:e,elevation:n,context:i}){zt.x=t?.value??0,zt.y=e?.value??0,zt.spatialReference=i.spatialReference;const o=Vt(zt,i,Po);return new Te(t!=null&&o!=null?o[0]:void 0,e!=null&&o!=null?o[1]:void 0,It(n,i))}function Mo(t){let e;for(const n of t)n&&(e=e?.intersect(n)??n);return e}function Vt(t,e,n=B()){const{view:i,elevationInfo:o,measurementSR:s,origin:r,mode:a}=e;if(Qt(t,i,o,n),Tt(n,t.spatialReference,n,s))return a!=="geodesic"&&Fe(n,n,r),n}function To(t,e,n,i){const{view:o,measurementSR:s,spatialReference:r,origin:a,mode:c}=n;if(c==="geodesic"?Ui(ut,t):Pt(ut,t,a),Tt(ut,s,ut,r))return ei(ut,o,e,n,i)}function It(t,e){return Oo(t,e)?.value??void 0}function Oo(t,{view:e,origin:n,elevationInfo:i,hasZ:o,measurementSR:s}){if(t==null||!o)return;const r=Dn(s);if(r==null)return;const[a,c]=n,u=Ct(t,r),d=e?.type==="3d"?Oe(e,a,c,u,s,i):u;return d!=null?Ne(d,r):void 0}const on=B(),Po=B(),ut=B(),zt=ee(0,0,0,Wt.WGS84);function sn({predicate:t=()=>!0,snappingManager:e,snappingContext:n,updatingHandles:i,useZ:o=!0}){const s=new kt;if(e==null)return{snappingStep:[ln,s],cancelSnapping:ln};let r,a=null,c=null,u=null;const d=()=>{a=jt(a),e.doneSnapping(),c?.frameTask.remove(),c=null,r=fe(r),u=null},m=Co(e,o,s);let f=null,h=null,v=null;return{snappingStep:[g=>{if(!t(g))return g;const{action:b}=g;if(b==="start"){const{info:w}=g,S=Eo(e.view);if(c=Ro(n,g,S),c.context.selfSnappingZ=null,!o&&w!=null){const R=Vo(n.coordinateHelper,w.handle.component);R!=null&&(c.context.selfSnappingZ={value:R,elevationInfo:n.elevationInfo??Ee})}}if(c!=null){const{context:w,originalScenePos:S,originalPos:R}=c,{mapEnd:G,mapStart:H,scenePoints:P}=g,it=rn(R,re(G,H)),ft=re(H,R),Pn={...g,action:"update"},Cn=c.context,Lt=ko(S,P),de=e.update({point:it,scenePoint:Lt,context:w});if(v=de,an(G,de,ft,o),f=it,h=Lt,b!=="end"){const{frameTask:En}=c;a==null&&(a=new AbortController),u=Rn=>{i.addPromise(qt(m({frameTask:En,event:Pn,context:Cn,point:it,scenePoint:Lt,delta:ft,getLastState:()=>({point:f,scenePoint:h,updatePoint:Rn.forceUpdate?null:v})},a.signal)))},u({forceUpdate:!1}),r==null&&(r=D(()=>e.options.effectiveEnabled,()=>u?.({forceUpdate:!0})))}}return b==="end"&&d(),g},s],cancelSnapping:g=>(d(),g)}}function Co(t,e,n){return ye(async({frameTask:i,point:o,scenePoint:s,context:r,event:a,delta:c,getLastState:u},d)=>{const m=await i.schedule(()=>t.snap({point:o,scenePoint:s,context:r,signal:d}),d);if(m.valid){let f=await i.schedule(()=>m.apply(),d);const h=u();h.point!=null&&o!==h.point&&(f=t.update({point:h.point,scenePoint:h.scenePoint,context:r})),h.updatePoint!=null&&pt(f,h.updatePoint)||(an(a.mapEnd,f,c,e),n.execute(a))}})}function Eo(t){return t.type==="3d"?t.resourceController.scheduler.registerTask(Ge.SNAPPING):Ue}function Ro(t,e,n){return{context:new te({editGeometryOperations:t.editGeometryOperations,elevationInfo:t.elevationInfo,pointer:t.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:t.excludeFeature,feature:t.feature,visualizer:t.visualizer}),originalPos:e.snapOrigin!=null?t.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:n}}function rn(t,[e,n,i]){const o=Mt(t);return o.x+=e,o.y+=n,o.hasZ&&(o.z+=i),o}function ko(t,e){return t==null||e==null?null:rn(t,re(e.sceneEnd,e.sceneStart))}function re(t,e){const n=t.hasZ&&e.hasZ?t.z-e.z:0;return[t.x-e.x,t.y-e.y,n]}function an(t,e,[n,i,o],s){t.x=e.x+n,t.y=e.y+i,s&&t.hasZ&&e.hasZ&&(t.z=e.z+o)}function Vo(t,e){if(!t.hasZ())return null;const n=e.vertices;let i=null;for(const o of n){const s=t.getZ(o.pos);if(i!=null&&s!=null&&Math.abs(s-i)>1e-6)return null;i==null&&(i=s)}return i}function ln(t){return t}const Io="crosshair",zo="progress",cn=Symbol(),pn=Symbol();let y=class extends Yt.EventedMixin(ot){constructor(t){super(t),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new Jn,this._stagedScreenPoint=null,this._stagedPointerType=null,this._updatingHandles=new Me,this._stagedPointerId=null,this.constraintsEnabled=!1,this.constraints=void 0,this._getPointConstraint=Se(bo),this._getPolylineOrPolygonConstraint=Se(So),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new Re,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,t.elevationInfo==null&&(this.elevationInfo=li(!!t.hasZ))}initialize(){const{geometryType:t,view:e}=this,n=e.spatialReference,i="viewingMode"in e.state?e.state.viewingMode:mi.Local,o=t==="segment"||t==="multipoint"?"polyline":t;this.coordinateHelper=gi(this.hasZ,this.hasM,n),this._editGeometryOperations=new Jt(new yi(o,this.coordinateHelper),i),this._snappingOperation=new j({view:e}),this.addHandles([D(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this._constraint}),({stagedPoint:a,constraint:c},u)=>{const{snappingOptions:d}=this;if(d&&(d.forceDisabled=c!=null&&ci(c)),u!=null&&a===u.stagedPoint&&c!==u.constraint)return this._onKeyboardBasedChange();this._processCursor(a??this._screenToMap(this._stagedScreenPoint))},{equals:(a,c)=>a.stagedPoint===c.stagedPoint&&Ln(a.constraint,c.constraint)}),D(()=>this.view.viewpoint,(a,c)=>{a&&c&&ti(a,c)&&this._onKeyboardBasedChange()})]),this._activeComponent=new fi(n,i),this._editGeometryOperations.data.components.push(this._activeComponent);const s=this.segmentLabels;s!=null&&(s.context={view:e,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.addHandles(D(()=>this.labelOptions.enabled,a=>{s.visible=a},wt))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],a=>{const c=a.vertices.map(h=>({componentIndex:0,vertexIndex:h.index,coordinates:this.coordinateHelper.vectorToArray(h.pos)})),u=c.map(h=>h.coordinates),d=this.coordinateHelper.vectorToDehydratedPoint(this._activeComponent.getFirstVertex()?.pos)??null;pt(d,this.firstVertex)||(this.firstVertex=d);const m=this.coordinateHelper.vectorToDehydratedPoint(this._activeComponent.getLastVertex()?.pos)??null;pt(m,this.lastVertex)||(this.lastVertex=m);const f=this.coordinateHelper.vectorToDehydratedPoint(this._activeComponent.edges.at(-1)?.leftVertex?.pos)??null;switch(pt(f,this.secondToLastVertex)||(this.secondToLastVertex=f),this._processCursor(this.cursorVertex),a.type){case"vertex-add":this.emit(a.type,{...a,added:u,vertices:c});break;case"vertex-update":this.emit(a.type,{...a,updated:u,vertices:c});break;case"vertex-remove":this.emit(a.type,{...a,removed:u,vertices:c})}}));const r=this._manipulator=new fo({consumesClicks:!1,grabbableForEvent:a=>this.drawingMode!=="click"||a.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(r),r.grabbable=t!=="point"&&t!=="multipoint",this.addHandles([r.events.on("immediate-click",a=>this._onImmediateClick(a)),r.events.on("immediate-double-click",a=>this._onImmediateDoubleClick(a)),D(()=>this.drawingMode,()=>{this.removeHandles(cn),this.addHandles(this._createManipulatorDragPipeline(r),cn)},wt),D(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:a})=>{r.cursor=a},wt)]),pi(this,()=>{const a=this.view.inputManager.latestPointerType??"mouse",c=this._getSnappingContext(a);if(this.snappingManager!=null){const u=this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,c);this._updatingHandles.addPromise(qt(u))}})}destroy(){q(this.segmentLabels),q(this._snappingOperation),this._editGeometryOperations=q(this._editGeometryOperations),this._updatingHandles.destroy()}get _isDragging(){const{_stagedPointerId:t,_manipulator:e}=this;return t!=null&&this._pointerDownStates.has(t)||e.grabbing||!e.interactive}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const t=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==t}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map(t=>this.coordinateHelper.vectorToArray(t.pos))}get _constraint(){const{constraints:t,constraintsEnabled:e}=this;if(t&&e)switch(this.geometryType){case"point":case"multipoint":return this._getPointConstraint(t);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,t)}}set drawingMode(t){this._set("drawingMode",t??Je)}get effectiveCursor(){return this.loading?zo:this._hideDefaultCursor?null:this.cursor||Io}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:t,lastVertex:e,firstVertex:n,geometryType:i}=this;return i==="polygon"&&oe(t,n)||oe(t,e)?null:t}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:t,committableVertex:e,coordinateHelper:n}=this,i=t.slice();return e!=null&&i.push(n.pointToArray(e)),i}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:t}=this;t!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t))}complete(t){const e=t?.aborted||!1;this._snappingOperation.abort(),this.snappingManager?.doneSnapping();const{geometryType:n,numCommittedVertices:i}=this,o=n==="multipoint"&&i===0||n==="polyline"&&i<2||n==="polygon"&&i<3;n!=="segment"&&n!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!o,(this.isCompleted||e)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((s,r)=>({componentIndex:0,vertexIndex:r,coordinates:s})),aborted:e,type:"complete"}))}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(t){const e=Bt(this.cursorVertex),n=Bt(t),i=n&&(this._updateAndGetEffectiveDrawSurface()?.constrainZ(n)??n),o=this._snapToClosingVertex(i),s=this._applyConstraints(o);oe(e,s)||(this._set("cursorVertex",s),this.segmentLabels?.set("stagedVertex",s!=null?this.coordinateHelper.pointToVector(s):null),s==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(s)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(t){if(t==null||this._isDragging||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return t;const e=this._mapToScreen(t);if(!e)return t;const n=this._activeComponent;return this._vertexWithinPointerDistance(n.vertices[0].pos,e)?this.firstVertex:this._vertexWithinPointerDistance(n.vertices.at(-1).pos,e)?this.lastVertex:t}_createManipulatorDragPipeline(t){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return Rt(t,(e,n,i,o)=>{const s=o==="touch"&&this._snappingEnabled;if(this.isCompleted||!s)return;const{snappingStep:r,cancelSnapping:a}=sn({predicate:()=>s,snappingManager:this.snappingManager,snappingContext:new te({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:o,visualizer:this.snappingVisualizer,drawConstraints:this.constraints}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});i=i.next(c=>(s&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),c)).next(a),n.next(this._screenToMapDragEventStep()).next(c=>(c.action==="start"&&(this._processCursor(c.mapStart),(this.geometryType==="segment"||s&&!this.numCommittedVertices)&&this.commitStagedVertex()),c)).next($e(this.view,this.elevationInfo)).next(...r).next(c=>(s&&(this._processCursor(c.mapEnd),c.action==="end"&&this.commitStagedVertex()),c)).next(c=>(c.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),c))})}_createManipulatorDragPipelineFreehand(t){return Rt(t,(e,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(i.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return i})})}_createManipulatorDragPipelineHybrid(t){return Rt(t,(e,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this.addHandles(this._editGeometryOperations.createUndoGroup(),pn),this._processCursor(i.mapStart),this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.removeHandles(pn),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return i})})}get _drawAtFixedElevation(){const{constraintsEnabled:t,constraintZ:e,geometryType:n,numCommittedVertices:i}=this;return t?e!=null||n==="segment"&&i>0:(n==="segment"||n==="polygon")&&i>0}_updateAndGetEffectiveDrawSurface(){const{constraintsEnabled:t,coordinateHelper:e,drawSurface:n,elevationDrawSurface:i,snapToSceneEnabled:o}=this;if(i==null)return n;if(!this.hasZ)return i.defaultZ=null,i;const s=this.elevationInfo?.mode;let r=this.defaultZ,a=t||s==="absolute-height";return o!=null&&(a=o),s==="on-the-ground"&&(a=!1),this._drawAtFixedElevation&&(r=(t?this.constraintZ:null)??e.getZ(this._activeComponent.vertices[0].pos),a=!1),a?n:(i.defaultZ=r,i)}_mapToScreen(t){return this._updateAndGetEffectiveDrawSurface()?.mapToScreen(t)}_onHold(t){this._snappingOperation.abort(),this.drawingMode==="click"&&t.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if(!(t.pointerType==="mouse"&&t.button===2||this._manipulator.dragging))try{const{drawingMode:e,geometryType:n}=this;this._stagedPointerType=t.pointerType,this._stagedScreenPoint=t.screenPoint;const i=this._screenToMap(t.screenPoint);if(i==null||i==null||e==="freehand"&&n!=="point"&&n!=="multipoint")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(i),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),t.pointerType!=="mouse"&&this._processCursor(null),(e==="freehand"&&this.geometryType!=="multipoint"||n==="point"||n==="segment"&&this.numCommittedVertices===2||n==="segment"&&e==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{t.stopPropagation()}}_onImmediateDoubleClick(t){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),t.stopPropagation())}_onPointerMove(t){const e=ge(t.x,t.y);this._stagedScreenPoint=e,this._stagedPointerType=t.pointerType,this._stagedPointerId=t.pointerId,this._isDragging?this._snappingOperation.abort():(t.stopPropagation(),this._processCursorMovementRelativeToSurface(e,t.pointerType))}_onKeyboardBasedChange(){this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._isDragging?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(t,e){const n=this._snappingOperation,i=this._screenToMap(t),o=this._requiresScenePoint?this.drawSurface?.screenToMap(t):null;if(i==null)return this._hideDefaultCursor=!0,this._processCursor(null),void n.abort();this._hideDefaultCursor=!1;const s=this.snappingManager;if(s==null)return this._processCursor(i),void n.abort();const r=this._getSnappingContext(e);this._updatingHandles.addPromise(qt(n.snap({point:i,scenePoint:o},s,r)))}_applyConstraints(t){const{_constraint:e,constraints:n}=this;if(!t||!n||!e)return t;const{context:i}=n,o=Vt(t,i),s=o?e.closestTo(o):void 0;if(!s)return t;const r=To(s,t,i),a=this.view.type==="2d"||i.elevationInfo.mode!=="absolute-height";return r!=null&&a&&this.constraintZ!=null&&this.hasZ&&(r.z=this.constraintZ),r}_screenToMap(t){return t?this._updateAndGetEffectiveDrawSurface()?.screenToMap(t):null}_screenToMapDragEventStep(){let t=null;return e=>{if(e.action==="start"&&(t=this._screenToMap(e.screenStart)),t==null)return null;const n=this._screenToMap(e.screenEnd);return n!=null?{...e,mapStart:t,mapEnd:n}:null}}_vertexWithinPointerDistance(t,e){const n=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return n!=null&&Ao(n,e,25)}_getSnappingContext(t){const e=this._drawAtFixedElevation?this.elevationDrawSurface?.defaultZ:null;return new te({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:e!=null?{value:e,elevationInfo:this.elevationInfo}:null,drawConstraints:this.constraints})}};function Ao(t,e,n){const i=t.x-e.x,o=t.y-e.y;return i*i+o*o<=n}l([p()],y.prototype,"_hideDefaultCursor",void 0),l([p()],y.prototype,"_stagedPointerId",void 0),l([p()],y.prototype,"_isDragging",null),l([p()],y.prototype,"_snappingOperation",void 0),l([p()],y.prototype,"_snappingEnabled",null),l([p({constructOnly:!0})],y.prototype,"graphic",void 0),l([p()],y.prototype,"constraintsEnabled",void 0),l([p()],y.prototype,"constraints",void 0),l([p()],y.prototype,"_constraint",null),l([p()],y.prototype,"constraintZ",void 0),l([p()],y.prototype,"defaultZ",void 0),l([p()],y.prototype,"isDraped",void 0),l([p({value:Je})],y.prototype,"drawingMode",null),l([p({constructOnly:!0})],y.prototype,"elevationDrawSurface",void 0),l([p({constructOnly:!0})],y.prototype,"elevationInfo",void 0),l([p({constructOnly:!0,type:Re})],y.prototype,"labelOptions",void 0),l([p({constructOnly:!0})],y.prototype,"geometryType",void 0),l([p({constructOnly:!0})],y.prototype,"hasM",void 0),l([p({constructOnly:!0})],y.prototype,"hasZ",void 0),l([p()],y.prototype,"cursor",void 0),l([p()],y.prototype,"effectiveCursor",null),l([p()],y.prototype,"loading",void 0),l([p({constructOnly:!0})],y.prototype,"manipulators",void 0),l([p({constructOnly:!0})],y.prototype,"drawSurface",void 0),l([p({constructOnly:!0})],y.prototype,"segmentLabels",void 0),l([p({constructOnly:!0})],y.prototype,"snappingManager",void 0),l([p({constructOnly:!0})],y.prototype,"snappingVisualizer",void 0),l([p()],y.prototype,"snapToSceneEnabled",void 0),l([p({readOnly:!0})],y.prototype,"cursorVertex",null),l([p({readOnly:!0})],y.prototype,"visualizationCursorVertex",null),l([p()],y.prototype,"committableVertex",null),l([p()],y.prototype,"firstVertex",void 0),l([p()],y.prototype,"lastVertex",void 0),l([p()],y.prototype,"secondToLastVertex",void 0),l([p()],y.prototype,"updating",null),l([p({constructOnly:!0})],y.prototype,"view",void 0),y=l([T("esri.views.draw.DrawOperation")],y);let Go=class{constructor(t,e,n,i=null){this._elevationInfo=t,this.defaultZ=e,this._view=n,this._excludeGraphics=i}screenToMap(t){const{defaultZ:e,_view:n}=this,i=n.sceneIntersectionHelper.intersectElevationFromScreen(Wn(t.x,t.y),this._elevationInfo,e??0,this._excludeGraphics);return e==null&&i!=null&&(i.z=void 0),i}mapToScreen(t){const e=ee(t.x,t.y,ke(this._view,t,this._elevationInfo),t.spatialReference);return this._view.toScreen(e)}constrainZ(t){const{defaultZ:e}=this;return e!=null&&t.z!==e&&((t=Mt(t)).z=e),t}},Uo=class{constructor(t,e,n=[]){this.view=t,this.elevationInfo=e,this.exclude=n}screenToMap(t){const e=this.view.toMap(t,{exclude:this.exclude,excludeLabels:!0});return e!=null&&(e.z=bt(e,this.view,this.elevationInfo)),e}mapToScreen(t){let e=t;return this.elevationInfo!=null&&(e=ee(t.x,t.y,ke(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(e)}constrainZ(t){return t}},Fo=class{constructor(t,e=!1,n=0){this.view=t,this.hasZ=e,this.defaultZ=n,this.mapToScreen=i=>t.toScreen(i),this.screenToMap=e?i=>{const o=t.toMap(i);return o.z=n,o}:i=>t.toMap(i)}constrainZ(t){const{defaultZ:e}=this;return this.hasZ&&t.z!==e&&((t=Mt(t)).z=e),t}};new Wt;function At(t,e,n=null){return n!=null?[t,e,n]:[t,e]}function x(t,e,n=null){return n!=null?{x:t,y:e,z:n}:{x:t,y:e}}let un=class{constructor(t){this.spatialReference=t}mapToLocalMultiple(t){return t.map(e=>this.mapToLocal(e)).filter(st)}get doUnnormalization(){return!1}},Ho=class extends un{constructor(t,e,n=null){super(e),this._defaultZ=n,this.transform=Le(),this.transformInv=Le(),this.transform=qi(t),Yi(this.transformInv,this.transform)}makeMapPoint(t,e){return At(t,e,this._defaultZ)}mapToLocal(t){return x(this.transform[0]*t[0]+this.transform[2]*t[1]+this.transform[4],this.transform[1]*t[0]+this.transform[3]*t[1]+this.transform[5])}localToMap(t){return At(this.transformInv[0]*t.x+this.transformInv[2]*t.y+this.transformInv[4],this.transformInv[1]*t.x+this.transformInv[3]*t.y+this.transformInv[5],this._defaultZ)}},Do=class extends un{constructor(t,e){super(t.spatialReference),this.view=t,this.defaultZ=null,this.pWS=C(),this.tangentFrameUpWS=C(),this.tangentFrameRightWS=C(),this.tangentFrameForwardWS=C(),this.localFrameRightWS=C(),this.localFrameUpWS=C(),this.worldToLocalTransform=We(),this.localToWorldTransform=We(),this.scale=1,this.scale=t.resolution,this.referenceMapPoint=e,this.defaultZ=e.hasZ?e.z:null;const n=t.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,Xt.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,Xt.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,Xt.Z,this.tangentFrameForwardWS);const i=C();ne(i,this.tangentFrameForwardWS,Fi(n,this.tangentFrameForwardWS)),Fe(this.localFrameRightWS,n,i),Hi(this.localFrameRightWS,this.localFrameRightWS),Di(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),Bi(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),Xi(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return this.view.viewingMode==="global"}makeMapPoint(t,e){return At(t,e,this.defaultZ)}mapToLocal(t){const e=C();this.view.renderCoordsHelper.toRenderCoords(new U({x:t[0],y:t[1],spatialReference:this.spatialReference}),e),He(e,e,this.worldToLocalTransform);const n=this.view.renderCoordsHelper.fromRenderCoords(e,new U({spatialReference:this.view.spatialReference}));return n!=null?x(n.x/this.scale,n.y/this.scale):null}localToMap(t){const e=C();this.view.renderCoordsHelper.toRenderCoords(new U({x:t.x*this.scale,y:t.y*this.scale,spatialReference:this.spatialReference}),e),He(e,e,this.localToWorldTransform);const n=this.view.renderCoordsHelper.fromRenderCoords(e,new U({spatialReference:this.view.spatialReference}));return n!=null?At(n.x,n.y,this.defaultZ):null}};function Zo(t,e){if(t.type==="2d")return new Ho(t.state.transform,t.spatialReference,e.length>2?e[2]:null);if(t.type==="3d"){const n=e.length>2?new U({x:e[0],y:e[1],z:e[2],spatialReference:t.spatialReference}):new U({x:e[0],y:e[1],spatialReference:t.spatialReference});return new Do(t,n)}return null}function $(t,e,n){if(t==null)return"noTool";switch(t){case"point":return Lo();case"multipoint":return"multipoint";case"polyline":return Wo(e,n);case"polygon":return No(e,n);case"rectangle":case"circle":return jo(e,n);default:return}}function Lo(t){return"point"}function Wo(t,e){const n=t!=null&&t.type==="polyline"&&t.paths.length?t.paths[0].length:0;return e==="freehand"?n<2?"freehandStart":"freehandEnd":n<2?"polylineZeroVertices":"polylineOneVertex"}function No(t,e){const n=t!=null&&t.type==="polygon"&&t.rings.length?t.rings[0].length:0;if(n<3)switch(e){case"freehand":return"freehandStart";case"hybrid":return"polygonZeroVerticesHybrid";default:return"polygonZeroVertices"}else if(n<4)return e==="freehand"?"freehandEnd":"polygonOneVertex";return"polygonTwoVertices"}function jo(t,e){if((t!=null&&t.type==="polygon"&&t.rings.length?t.rings[0].length:0)<3)switch(e){case"freehand":return"freehandStart";case"click":return"shapeStartClick";default:return"shapeStartHybrid"}switch(e){case"freehand":return"freehandEnd";case"click":return"shapeEndClick";default:return"shapeEndHybrid"}}function Y(t,e){const n=new U({x:t[0],y:t[1],spatialReference:e});return t.length>2&&(n.z=t[2]),n}function Yo(t,e){return new Nn({points:t,spatialReference:e})}function dn(t,e,n){const i=new jn({paths:t,spatialReference:e});return n&&ve(i),i}function dt(t,e,n,i=!0){const o=Bt(t);o.forEach(r=>{const a=r[0],c=r[r.length-1];Yn(a,c)&&r.length!==1||r.push(r[0])});let s=new vt({rings:o,spatialReference:e});return s.rings.forEach(r=>{qn(r)||r.reverse()}),n&&ve(s),i&&s.isSelfIntersecting&&_e(e)&&(s=Ni(s)),s}function hn(t,e,n){const i=e.mapToLocalMultiple(t),o=[],s={x:i[0].x,y:i[0].y},r={x:i[1].x,y:i[1].y},a=Math.round(r.x-s.x),c=Math.round(r.y-s.y),u=Math.max(Math.abs(a),Math.abs(c));if(n){const d={x:s.x+u,y:s.y+u},m={x:s.x-u,y:s.y-u};o.push(x(d.x,m.y),x(m.x,m.y),x(m.x,d.y),x(d.x,d.y))}else{const d={x:a>0?s.x+u:s.x-u,y:c>0?s.y+u:s.y-u};o.push(x(s.x,s.y),x(d.x,s.y),x(d.x,d.y),x(s.x,d.y))}return mn(dt([o.map(d=>e.localToMap(d)).filter(st)],e.spatialReference,e.doUnnormalization,!0),o,e)}function qo(t,e,n){let i=e.mapToLocalMultiple(t);if(i.length===1){const a=i[0];i=[x(a.x-48,a.y+48),x(a.x+48,a.y-48),x(a.x+48,a.y-48),x(a.x-48,a.y+48)]}const o=[],s={x:i[0].x,y:i[0].y},r={x:i[1].x,y:i[1].y};if(n){const a=Math.round(r.x-s.x),c=Math.round(r.y-s.y);o.push(x(s.x-a,s.y-c),x(r.x,s.y-c),x(r.x,r.y),x(s.x-a,r.y))}else o.push(x(s.x,s.y),x(r.x,s.y),x(r.x,r.y),x(s.x,r.y));return mn(dt([o.map(a=>e.localToMap(a)).filter(st)],e.spatialReference,e.doUnnormalization,!0),o,e)}function mn(t,e,n){const i=Gt(e[3],e[2],n),o=Gt(e[1],e[2],n),s=Gt(e[0],e[1],n),r=Gt(e[0],e[3],n);return{geometry:t,midpoints:i!=null&&o!=null&&s!=null&&r!=null?{top:i,right:o,bottom:s,left:r}:null}}function Gt(t,e,n){Q[0]=t.x,Q[1]=t.y,Q[2]=0,J[0]=e.x,J[1]=e.y,J[2]=0,Zi(Q,Q,J,.5),Ut.x=Q[0],Ut.y=J[1],Ut.z=J[2];const i=n.localToMap(Ut);return i!=null?Y(i,n.spatialReference):null}const Ut=x(0,0,0),Q=C(),J=C();function gn(t,e,n,i){const o=e.mapToLocalMultiple(t);let s=null,r=null;if(n)s=o[0],r=o[1];else{const v=o[0],g=o[1],b=Math.round(g.x-v.x),w=Math.round(g.y-v.y),S=Math.max(Math.abs(b),Math.abs(w));s=x(b>0?v.x+S/2:v.x-S/2,w>0?v.y+S/2:v.y-S/2),r=x(Math.abs(b)>Math.abs(w)?s.x-S/2:s.x,Math.abs(b)>Math.abs(w)?s.y:s.y-S/2)}const a=e.localToMap(s),c=e.localToMap(r);if(a==null||c==null)return null;e.doUnnormalization&&Bn([[a,c]],e.spatialReference);const u=Y(a,e.spatialReference),d=Y(c,e.spatialReference),m=Kt(e.spatialReference);let f=0;if(_e(e.spatialReference))f=m*ji(u,d,null);else{const v=s.x-r.x,g=s.y-r.y;f=m*Math.sqrt(v*v+g*g)*1}const h=new io({center:u,radius:f,radiusUnit:"meters",spatialReference:e.spatialReference});return{geometry:dt(h.rings,h.spatialReference,!1),center:u,edge:d}}function Bo(t,e,n){const i=e.mapToLocalMultiple(t),o=i[0],s=i[1],r=Math.round(s.x-o.x),a=Math.round(s.y-o.y),c=x(n?o.x:o.x+r/2,n?o.y:o.y+a/2),u=n?r:r/2,d=n?a:a/2,m=60,f=[],h=2*Math.PI/m;function v(P){const it=Math.cos(P),ft=Math.sin(P);return x(u*it+c.x,d*ft+c.y)}for(let P=0;P<m;P++)f.push(v(P*h));f.push(f[0]);const{spatialReference:g,doUnnormalization:b}=e,w=dt([f.map(P=>e.localToMap(P)).filter(st)],g,b,!1),S=e.localToMap(v(Math.PI/2)),R=e.localToMap(v(0)),G=e.localToMap(v(-Math.PI/2)),H=e.localToMap(v(Math.PI));return{geometry:w,midpoints:S!=null&&R!=null&&G!=null&&H!=null?{top:Y(S,g),right:Y(R,g),bottom:Y(G,g),left:Y(H,g)}:null}}var O;(function(t){t[t.NeverApplied=0]="NeverApplied",t[t.Applied=1]="Applied",t[t.Undone=2]="Undone"})(O||(O={}));var k;(function(t){t.UndoRedoUpdating="UndoRedoUpdating",t.UndoInvalidError="UndoInvalidError",t.RedoInvalidError="RedoInvalidError",t.ApplyInvalidError="ApplyInvalidError"})(k||(k={}));const Ft={[k.UndoRedoUpdating]:"Cannot perform operation whilst undo redo is updating",[k.UndoInvalidError]:"There are no items to Undo",[k.RedoInvalidError]:"There are no items to Redo",[k.ApplyInvalidError]:"Cannot apply an item that is already applied"};class ht extends Error{constructor(){super(Ft[k.UndoRedoUpdating]),this.type="undo-redo-updating-error"}}let ae=class extends Error{constructor(){super(Ft[k.UndoInvalidError]),this.type="undo-redo-undo-error"}};class yn extends Error{constructor(){super(Ft[k.RedoInvalidError]),this.type="undo-redo-redo-error"}}class Xo extends Error{constructor(){super(Ft[k.ApplyInvalidError]),this.type="undo-redo-apply-error"}}var z;(function(t){t[t.Apply=0]="Apply",t[t.Undo=1]="Undo",t[t.Redo=2]="Redo"})(z||(z={}));let Ht=class extends ot{constructor(){super(...arguments),this.name="",this.tag=Symbol(),this.status=O.NeverApplied}get canUndo(){return this.status===O.Applied}get canRedo(){return this.status===O.Undone}async executeUndoRedoOperation(t){switch(t){case z.Apply:if(this.status!==O.NeverApplied)throw new Xo;return await this.apply(),void(this.status=O.Applied);case z.Undo:if(this.status!==O.Applied)throw new ae;return await this.undo(),void(this.status=O.Undone);case z.Redo:if(this.status!==O.Undone)throw new ae;return await this.redo(),void(this.status=O.Applied)}}};l([p()],Ht.prototype,"name",void 0),l([p()],Ht.prototype,"tag",void 0),Ht=l([T("esri.undoredo.UndoableOperation")],Ht);let V=class extends ot{constructor(){super(...arguments),this._stack=new Nt,this._stackPosition=-1,this._updatingHandles=new Me}get updating(){return this._updatingHandles.updating}get canUndo(){return this.hasUndo&&!this.updating}get hasUndo(){return this._stackPosition>=0}get canRedo(){return this.hasRedo&&!this.updating}get hasRedo(){return this._stackPosition<this._stack.length-1}_truncateForwardStack(){this._stack.splice(this._stackPosition+1,this._stack.length-this._stackPosition).forEach(t=>t.destroy())}_drainStack(){this._stack.drain(t=>t.destroy()),this._stackPosition=-1}async undo(){if(!this.hasUndo)throw new ae;if(this.updating)throw new ht;const t=this._stack.getItemAt(this._stackPosition);t&&await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(z.Undo),--this._stackPosition,t.canRedo||this._truncateForwardStack()})())}async redo(){if(!this.hasRedo)throw new yn;if(this.updating)throw new ht;const t=this._stack.getItemAt(this._stackPosition+1);if(!t)throw new yn;await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(z.Redo),++this._stackPosition})())}peekUndo(){if(this.canUndo)return this._stack.getItemAt(this._stackPosition)}peekRedo(){if(this.canRedo)return this._stack.getItemAt(this._stackPosition+1)}async inject(t){if(this.updating)throw new ht;await this._updatingHandles.addPromise((async()=>{t.status===O.NeverApplied&&await t.executeUndoRedoOperation(z.Apply),t.canUndo?(this._stack.splice(this._stackPosition+1,0,t),this._stackPosition++):this._stackPosition>-1&&(this._stack.splice(0,this._stackPosition+1).forEach(e=>e.destroy()),this._stackPosition=-1)})())}async add(t){if(this.updating)throw new ht;await this._updatingHandles.addPromise((async()=>{t.status===O.NeverApplied&&await t.executeUndoRedoOperation(z.Apply),this._stackPosition>=-1&&this._truncateForwardStack(),t.canUndo?(this._stack.push(t),this._stackPosition=this._stack.length-1):this._drainStack()})())}async removeTagged(t,e=!1){if(this.updating&&!e)return;await we(()=>!this.updating);const n=new Nt;for(let i=0;i<this._stack.length;i++){const o=this._stack.getItemAt(i);o&&(o.tag===t?(o.destroy(),i===this._stackPosition&&(this._stackPosition=n.length-1)):n.push(o))}this._stack=n,this._stackPosition>n.length-1&&(this._stackPosition=n.length-1)}async clear(t=!1){if(this.updating&&!t)throw new ht;await we(()=>!this.updating),this._drainStack()}};l([p()],V.prototype,"_stack",void 0),l([p()],V.prototype,"_stackPosition",void 0),l([p()],V.prototype,"updating",null),l([p({readOnly:!0})],V.prototype,"canUndo",null),l([p({readOnly:!0})],V.prototype,"hasUndo",null),l([p({readOnly:!0})],V.prototype,"canRedo",null),l([p({readOnly:!0})],V.prototype,"hasRedo",null),V=l([T("esri.UndoRedo")],V);class Ko{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}}function $o(t,e){const n=t?.geometry;if(!t||n?.type!=="mesh"||!e)return;const{renderCoordsHelper:i,elevationProvider:o}=e,{camera:s}=e.state,{extent:r}=n,{center:a,spatialReference:c}=r,u=Kt(c),d=$t(c),m=Kt(i.spatialReference),f=r.width*u,h=r.height*d,v=(r.zmax??0)*d,g=v-(r.zmin??0)*d,b=Math.max(f,h,g)/m,{x:w,y:S}=a,R=a.z??0;De(Dt,w,S,R),i.toRenderCoords(Dt,c,Dt);const G=b/s.computeScreenPixelSizeAt(Dt);if(G>s.width*Jo)return"meshTooClose";if(G<Qo)return"meshTooFar";const H=ui(t),{absoluteZ:P}=di(w,S,v,c,e,H);return P<(o.getElevation(w,S,R,c,"ground")??0)*d+g*ts?"meshUnderground":"mesh"}const Qo=20,Jo=1,ts=.1,Dt=C();let I=class extends Z{constructor(t){super(t),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=at}get allFields(){return[]}};l([p()],I.prototype,"type",void 0),l([p()],I.prototype,"radius",void 0),l([p()],I.prototype,"xSize",void 0),l([p()],I.prototype,"ySize",void 0),l([p()],I.prototype,"area",void 0),l([p()],I.prototype,"helpMessage",void 0),l([p()],I.prototype,"allFields",null),I=l([T("esri.views.interactive.tooltip.infos.DrawCircleTooltipInfo")],I);let mt=class extends rt(Z){constructor(t){super(t),this.type="draw-mesh",this.orientation=vi({lockable:!1}),this.scale=_i({lockable:!1})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};l([p()],mt.prototype,"helpMessage",void 0),l([p()],mt.prototype,"allFields",null),mt=l([T("esri.views.interactive.tooltip.infos.DrawMeshTooltipInfo")],mt);let gt=class extends rt(Z){constructor(t){super(t),this.type="draw-multipoint"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};l([p()],gt.prototype,"helpMessage",void 0),l([p()],gt.prototype,"allFields",null),gt=l([T("esri.views.interactive.tooltip.infos.DrawMultipointTooltipInfo")],gt);let yt=class extends rt(Z){constructor(t){super(t),this.type="draw-point"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};l([p()],yt.prototype,"helpMessage",void 0),l([p()],yt.prototype,"allFields",null),yt=l([T("esri.views.interactive.tooltip.infos.DrawPointTooltipInfo")],yt);let tt=class extends rt(Z){constructor(t){super(t),this.type="draw-polygon",this.direction=Ie(),this.distance=ze(),this.area=wi(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.area]}};l([p()],tt.prototype,"xyMode",void 0),l([p()],tt.prototype,"helpMessage",void 0),l([p()],tt.prototype,"allFields",null),tt=l([T("esri.views.interactive.tooltip.infos.DrawPolygonTooltipInfo")],tt);let et=class extends rt(Z){constructor(t){super(t),this.type="draw-polyline",this.direction=Ie(),this.distance=ze(),this.totalLength=xi(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.totalLength]}};l([p()],et.prototype,"helpMessage",void 0),l([p()],et.prototype,"xyMode",void 0),l([p()],et.prototype,"allFields",null),et=l([T("esri.views.interactive.tooltip.infos.DrawPolylineTooltipInfo")],et);let A=class extends Z{constructor(t){super(t),this.type="draw-rectangle",this.xSize=W,this.ySize=W,this.area=at}get allFields(){return[]}};l([p()],A.prototype,"type",void 0),l([p()],A.prototype,"xSize",void 0),l([p()],A.prototype,"ySize",void 0),l([p()],A.prototype,"area",void 0),l([p()],A.prototype,"helpMessage",void 0),l([p()],A.prototype,"allFields",null),A=l([T("esri.views.interactive.tooltip.infos.DrawRectangleTooltipInfo")],A);function es(t,e){return{point:new yt({sketchOptions:e,viewType:t}),multipoint:new gt({sketchOptions:e,viewType:t}),polyline:new et({sketchOptions:e,viewType:t}),polygon:new tt({sketchOptions:e,viewType:t}),mesh:new mt({sketchOptions:e,viewType:t}),rectangle:new A({sketchOptions:e}),circle:new I({sketchOptions:e})}}function fn(t){const{directionOptions:e,geometryType:n,sketchOptions:i,tooltipInfos:o}=t,s=a=>{const c=Zt(t).mode,u=o[a].elevation;c==="relative-to-ground"||c==="relative-to-scene"||c==="on-the-ground"?u.lock(pe(t)):u.unlock()},r=a=>{if(e){const c=o[a].direction;c.committed=e.angle,c.unlockOnVertexPlacement=!1,i.values.directionMode=e.mode}};switch(n){case"polygon":case"polyline":s(n),r(n);break;case"point":case"mesh":s(n)}}function ns(t,e){const{drawOperation:n,view:i}=e,o=le(e),s=Zt(e);if(i.type==="2d"||!t||s.mode!=="absolute-height"||n?.numCommittedVertices!==1||!o||o.type!=="draw-polyline"&&o.type!=="draw-polygon"||o.elevation.locked)return;const[r,a,c]=t,u=gs(r,a,c,s,e);u!=null&&o.elevation.lock(u)}function vn(t){le(t)?.allFields.forEach(e=>{e.unlockOnVertexPlacement&&e.unlock()})}function le({geometryType:t,graphic:e,tooltipInfos:n}){return e?.geometry?.type!==is[t]?t==="circle"||t==="rectangle"?n[t]:null:n[t]}const is={point:"point",multipoint:"multipoint",mesh:"mesh",polyline:"polyline",polygon:"polygon",circle:"polygon",rectangle:"polygon",freehandPolygon:"polygon",freehandPolyline:"polyline"};function os(t,e){switch(t?.type){case"draw-point":ss(t,e);break;case"draw-multipoint":rs(t,e);break;case"draw-polyline":ls(t,e);break;case"draw-polygon":cs(t,e);break;case"draw-rectangle":us(t,e);break;case"draw-circle":ds(t,e);break;case"draw-mesh":as(t,e)}}function ss(t,e){const n=e.graphic?.geometry;n?.type==="point"&&(ce(t,n,e),t.helpMessage=$("point",n,e.drawOperation.drawingMode))}function rs(t,e){const n=e.graphic?.geometry;n?.type==="multipoint"&&(ce(t,n,e),t.helpMessage=$("multipoint",n,e.drawOperation.drawingMode))}function as(t,e){const{graphic:n,view:i}=e,o=n?.geometry;i.type!=="3d"||o&&o.type!=="mesh"||(ce(t,o?.origin,e),o&&Ci(t,o),t.helpMessage=$o(n,i))}function ce(t,e,n){const{drawOperation:i,view:o,sketchOptions:s}=n,{cursorVertex:r}=i;t.sketchOptions=s,t.viewType=o.type;const a=e?.type==="multipoint"?e.getPoint(e.points.length-1):e;if(t.setLocationFromPoint(a,nt(n)),wn(t.elevation,n),!r)return void(i.constraints=void 0);const c=r;i.constraints={context:Mn(c,n),x:t.x.committed,y:t.y.committed,longitude:t.longitude.committed,latitude:t.latitude.committed,elevation:t.elevation.committed,distance:null,direction:null}}function ls(t,e){const{createOperationGeometry:n,drawOperation:i}=e,o=n!=null?n.full:null;o&&o.type!=="polyline"||(_n(t,e),t.totalLength.actual=i.lastVertex?(o?Ei(o):null)??W:null,t.helpMessage=$("polyline",o,e.drawOperation.drawingMode))}function cs(t,e){const{createOperationGeometry:n,drawOperation:i}=e,o=n!=null?n.full:null;o&&o.type!=="polygon"||(_n(t,e),t.area.actual=i.lastVertex?(o?Ae(o):null)??at:null,t.helpMessage=$("polygon",o,e.drawOperation.drawingMode))}function _n(t,e){const{drawOperation:n,sketchOptions:i,view:o}=e,{cursorVertex:s,lastVertex:r,secondToLastVertex:a}=n,c=i.values.effectiveDirectionMode;t.sketchOptions=i,t.viewType=o.type;const u=r&&s?Ot(r,s)??W:null;if(t.distance.actual=u,t.distance.readOnly=r==null,t.direction.actual=null,t.direction.readOnly=!0,r&&s&&(c==="absolute"||a)){const f=hi(a,r,s,c);t.direction.actual=f??$i,t.direction.readOnly=!1}t.setLocationFromPoint(s,nt(e)),wn(t.elevation,e);const d=ps(r,e);t.xyMode=d,t.direction.visible=d==="direction-distance",t.distance.visible=d==="direction-distance",t.effectiveX.visible=d==="coordinates",t.effectiveY.visible=d==="coordinates";const m=s??r;n.constraints=m?{context:Mn(m,e),x:t.x.committed,y:t.y.committed,longitude:t.longitude.committed,latitude:t.latitude.committed,elevation:t.elevation.committed,distance:t.distance.committed,direction:t.direction.committed}:void 0}function ps(t,{sketchOptions:e}){const n=e.tooltips.xyMode;return n==="auto"?t?"direction-distance":"coordinates":n}function us(t,e){t.sketchOptions=e.sketchOptions,t.xSize=bn(e),t.ySize=Sn(e),t.area=xn(e),t.helpMessage=$("rectangle",e.graphic?.geometry,e.drawOperation.drawingMode)}function ds(t,e){const{forceUniformSize:n,sketchOptions:i}=e;t.sketchOptions=i,t.radius=n?hs(e):null,t.xSize=n?null:bn(e),t.ySize=n?null:Sn(e),t.area=xn(e),t.helpMessage=$("circle",e.graphic?.geometry,e.drawOperation.drawingMode)}function wn(t,e){const{drawOperation:n}=e,i=n?.cursorVertex??n?.lastVertex;t.actual=Ri(i)??pe(e),t.visible=n.hasZ,t.readOnly=!1,t.showAsZ=!0}function xn(t){const e=t.createOperationGeometry?.full;return e?.type!=="polygon"?at:Ae(e)??at}function bn(t){const e=t.createOperationGeometry?.rectangle?.midpoints;return(e!=null?Ot(e.left,e.right):null)??W}function Sn(t){const e=t.createOperationGeometry?.rectangle?.midpoints;return(e!=null?Ot(e.top,e.bottom):null)??W}function hs({createOperationGeometry:t}){return(t?.circle?.center!=null&&t.circle.edge!=null?Ot(t.circle.center,t.circle.edge):null)??W}function ms(t){const{geometryType:e,tooltipInfos:n}=t;switch(e){case"point":case"multipoint":case"mesh":case"polyline":case"polygon":{const i=n[e].elevation.committed;return i?Ct(i,"meters")/$t(nt(t)):void 0}default:return}}function gs(t,e,n,i,o){const{view:s,drawOperation:r}=o;if(s.type!=="3d"||!r)return;n??=0;const a=nt(o),c=Zt(o),u=Oe(s,t,e,n,a,c,i);return ki(u,a)??pe(o)}function Zt(t){return t.drawOperation.elevationInfo??Ee}function nt(t){return t.drawOperation.coordinateHelper.spatialReference}function pe(t){const e=$t(nt(t));return Ne(t.defaultZ*e,"meters")}function Mn(t,e){return vo(t,e.view,nt(e),Zt(e),e.drawOperation.coordinateHelper.hasZ(),e.sketchOptions.values.effectiveDirectionMode)}let _=class extends Yt.EventedMixin(M){constructor(t){super(t),this._graphic=null,this._coordinateFormatterLoadTask=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.elevationLockOnVertexAddDisabled=!1,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new Ve}initialize(){const{view:t}=this;this.internalGraphicsLayer=new Gi({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer);const e=this.drawOperation=this.makeDrawOperation();this.tooltipInfos=es(t.type,this.sketchOptions);const n=Vi(()=>({view:t,options:this.sketchOptions.tooltips}));this.tooltip=n,fn(this._tooltipsContext),this._coordinateFormatterLoadTask=Xn(()=>Ii()),this.addHandles([e.on("vertex-add",i=>this.onVertexAdd(i)),e.on("vertex-remove",i=>this.onVertexRemove(i)),e.on("vertex-update",i=>this.onVertexUpdate(i)),e.on("cursor-update",i=>this.onCursorUpdate(i)),e.on("cursor-remove",()=>this._updateGraphic()),e.on("complete",i=>this.onComplete(i)),this._coordinateFormatterLoadTask,n.on("paste",i=>zi(i,this.activeTooltipInfo)),D(()=>this.cursor,i=>{e.cursor=i},wt),xe(()=>{const{activeTooltipInfo:i,sketchOptions:o}=this;os(i,this._tooltipsContext),n.info=o.tooltips.effectiveEnabled?i:null}),xe(()=>{e.constraintZ=ms(this._tooltipsContext)},Kn)]),this.finishToolCreation()}destroy(){this.drawOperation=q(this.drawOperation),this.tooltip=q(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=q(this.internalGraphicsLayer),this._set("view",null)}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get _tooltipsContext(){return{createOperationGeometry:this._createOperationGeometry,defaultZ:this.defaultZ,directionOptions:this.directionOptions,drawOperation:this.drawOperation,forceUniformSize:this.forceUniformSize,geometryType:this.geometryType,graphic:this.graphic,sketchOptions:this.sketchOptions,tooltipInfos:this.tooltipInfos,view:this.view}}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(t){this._set("cursor",t)}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),this._graphic!=null&&(this._graphic.symbol=t)}set mode(t){const e=this.drawOperation;e&&(e.drawingMode=t),this._set("mode",t)}get updating(){return this.drawOperation?.updating??!1}get undoRedo(){const{view:{type:t,map:e}}=this;return t==="2d"&&e&&"undoRedo"in e&&e.undoRedo instanceof V?e.undoRedo:null}set undoRedo(t){this._override("undoRedo",t)}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.destroyed||Ai(t,this.tooltip)||this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),this.drawOperation.numCommittedVertices===0&&fn(this._tooltipsContext)}_destroyAllVisualizations(){this.removeHandles(E.outline),this.removeHandles(E.regularVertices),this.removeHandles(E.activeVertex),this.removeHandles(E.activeEdge),this.removeHandles(ue)}_createOrUpdateGraphic(t){if(this._graphic!=null)return this.updateGraphicGeometry(t),this._graphic;const e=new $n({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=e,this.updateGraphicGeometry(t),this.internalGraphicsLayer.add(e),this.addHandles(this.initializeGraphic(e)),this.notifyChange("graphic"),this.addHandles(xt(()=>{this.internalGraphicsLayer.remove(e),this._graphic===e&&(this._graphic=null)}),ue),e}updateGraphicGeometry(t){this._graphic.geometry=t}_getCreateOperationGeometry(t={operationComplete:!1}){if(this.drawOperation==null)return;const{coordinateHelper:e,view:n,visualizationCursorVertex:i,lastVertex:o,committedVertices:s,geometryIncludingUncommittedVertices:r,numCommittedVertices:a}=this.drawOperation;if(!(a>0||i!=null))return;const c=t.operationComplete?s:r,u=c.length,d=i!=null?e.pointToArray(i):null,m=this._drawSpatialReference,f=n.type==="3d"&&n.viewingMode==="global",h=new Ko;h.committedVertices=s,h.cursorVertex=d;const{geometryType:v}=this;switch(v){case"point":case"mesh":h.full=e.arrayToPoint(c[0]);break;case"multipoint":h.full=u>0?Yo(c,m):null;break;case"polyline":case"polygon":u>0&&(h.full=v==="polygon"?dt([c],m,f,!0):dn([c],m,f),h.cursorEdge=d!=null&&o&&!pt(i,o)?dn([[d,e.pointToArray(o)]],m,f):null,h.outline=u>1?h.full:null);break;case"circle":case"rectangle":{if(h.committedVertices=h.cursorVertex=null,!u)break;const g=Zo(n,c[0]),b=c[0],w=g.makeMapPoint(b[0]+fs*n.resolution,b[1]);v==="circle"?u===1&&t.operationComplete?h.circle=gn([b,w],g,!0):u===2&&(this.forceUniformSize?h.circle=gn(c,g,this.centered):h.rectangle=Bo(c,g,this.centered)):u===1&&t.operationComplete?h.rectangle=hn([b,w],g,!0):u===2&&(h.rectangle=this.forceUniformSize?hn(c,g,this.centered):qo(c,g,this.centered)),h.full=h.circle!=null?h.circle.geometry:h.rectangle?.geometry,h.outline=h.full?.type==="polygon"?h.full:null;break}default:return null}return h}initializeGraphic(t){return xt()}onComplete(t){if(!this.drawOperation)return;this._updateGraphic();let e=null;if(this.drawOperation.isCompleted){const n=this._getCreateOperationGeometry({operationComplete:!0});n!=null&&(e=this._createOrUpdateGraphic(n.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:e,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){const{drawOperation:t}=this;t&&(t.isCompleted||t.cancel())}onOutlineChanged(t){return xt()}onCursorEdgeChanged(t){return xt()}onVertexAdd(t){vn(this._tooltipsContext),this._updateGraphic(),this.elevationLockOnVertexAddDisabled||ns(t.vertices.at(0)?.coordinates,this._tooltipsContext),this.emit("vertex-add",t)}onVertexRemove(t){vn(this._tooltipsContext),this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,t!=null?(t.cursorEdge!=null?this.addHandles(this.onCursorEdgeChanged(t.cursorEdge),E.activeEdge):this.removeHandles(E.activeEdge),t.outline!=null?this.addHandles(this.onOutlineChanged(t.outline),E.outline):this.removeHandles(E.outline),t.committedVertices!=null?this.addHandles(this.onRegularVerticesChanged(t.committedVertices),E.regularVertices):this.removeHandles(E.regularVertices),t.cursorVertex!=null?this.addHandles(this.onActiveVertexChanged(t.cursorVertex),E.activeVertex):this.removeHandles(E.activeVertex),t.full!=null?this._createOrUpdateGraphic(t.full):this.removeHandles(ue)):this._destroyAllVisualizations()}get activeTooltipInfo(){return this._coordinateFormatterLoadTask?.finished?le(this._tooltipsContext):null}};l([p()],_.prototype,"_coordinateFormatterLoadTask",void 0),l([p()],_.prototype,"_createOperationGeometry",void 0),l([p()],_.prototype,"_tooltipsContext",null),l([p({value:!0})],_.prototype,"centered",null),l([p()],_.prototype,"cursor",null),l([p({nonNullable:!0})],_.prototype,"defaultZ",void 0),l([p({constructOnly:!0})],_.prototype,"directionOptions",void 0),l([p()],_.prototype,"drawOperation",void 0),l([p()],_.prototype,"elevationLockOnVertexAddDisabled",void 0),l([p({value:!0})],_.prototype,"enabled",null),l([p({value:!0})],_.prototype,"forceUniformSize",null),l([p({constructOnly:!0})],_.prototype,"geometryType",void 0),l([p()],_.prototype,"graphic",null),l([p({constructOnly:!0})],_.prototype,"graphicProperties",void 0),l([p()],_.prototype,"graphicSymbol",null),l([p({constructOnly:!0})],_.prototype,"hasZ",void 0),l([p({constructOnly:!0})],_.prototype,"geometryToPlace",void 0),l([p()],_.prototype,"mode",null),l([p()],_.prototype,"snappingManager",void 0),l([p()],_.prototype,"snapToScene",void 0),l([p()],_.prototype,"tooltip",void 0),l([p()],_.prototype,"tooltipInfos",void 0),l([p({constructOnly:!0,type:Ve})],_.prototype,"sketchOptions",void 0),l([p()],_.prototype,"updating",null),l([p({constructOnly:!0,nonNullable:!0})],_.prototype,"view",void 0),l([p({constructOnly:!0})],_.prototype,"undoRedo",null),l([p()],_.prototype,"activeTooltipInfo",null),_=l([T("esri.views.draw.DrawGraphicTool")],_);const ue=Symbol("create-operation-graphic"),E={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function ys(t){switch(t){case"point":case"polyline":case"polygon":case"multipoint":return t;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const fs=48;function vs(t,e){return Tn(t,e,!1)}function _s(t,e){return Tn(t,e,!0)}function Tn(t,e,n){if(t instanceof bi){if(t.operation instanceof Si)return ws(t.operation,e,n),!0;if(t.operation instanceof Mi)return xs(t.operation,e,n),!0;if(t.operation instanceof Ti)return bs(t.operation,e,n),!0}return!1}function ws(t,e,n=!1){const i=n?-1:1,o=Qn(i*t.dx,i*t.dy,i*t.dz);Pt(e.origin,e.origin,o),Et(e)}function xs(t,e,n=!1){const i=n?-t.angle:t.angle;Ze(e.basis1,e.basis1,be,i),Ze(e.basis2,e.basis2,be,i),Et(e)}function bs(t,e,n=!1){const i=n?1/t.factor1:t.factor1,o=n?1/t.factor2:t.factor2;ne(e.basis1,e.basis1,i),ne(e.basis2,e.basis2,o),qe(e.origin,e.origin,t.origin,t.axis1,i),qe(e.origin,e.origin,t.origin,t.axis2,o),Et(e)}function Ss(t,e,n,i,o=!1){i||(i=no());const s=lt(ct.get(),t[1],-t[0]),r=lt(ct.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),a=lt(ct.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),c=ct.get(),u=e.allVertices;u.forEach(({pos:h})=>{lt(c,je(t,h),je(s,h)),Qi(r,r,c),Ji(a,a,c)});const d=1e-6,m=lt(ct.get(),a[0]-r[0]<d?n/2:0,a[1]-r[1]<d?n/2:0);to(r,r,m),eo(a,a,m);const f=o?u.reduce((h,v)=>h+(v.pos[2]??0),0)/u.length:0;return Ye(i.basis1,t,(a[0]-r[0])/2),Ye(i.basis2,s,(a[1]-r[1])/2),De(i.origin,r[0]*t[0]+r[1]*s[0],r[0]*t[1]+r[1]*s[1],f),Pt(i.origin,i.origin,i.basis1),Pt(i.origin,i.origin,i.basis2),Et(i),i}export{$e as D,lo as E,y as F,_ as I,ys as M,Ss as S,_s as T,yo as U,vs as V,mo as a,co as b,Go as c,sn as d,Be as f,Ke as g,Fo as h,ho as j,Uo as l,ro as m,M as n,Rt as p,uo as v,kt as w,po as z};
