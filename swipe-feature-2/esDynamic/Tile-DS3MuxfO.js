import{bx as G,bE as U,l as H,a as It,w as St,L as bt,u as tt,A as Bt,S as Tt,o as T,q as k,G as Ct,bm as Ft,d2 as zt,ai as kt,iY as Yt,dj as j,gD as Pt,eU as Xt,iZ as Rt}from"./main-BfV_Ya13.js";import{m as qt,b as et}from"./vec2-BnynUbeJ.js";import{s as Lt}from"./Queue-NSkWoXKt.js";import{s as $}from"./ReactiveMap-BeojCXIb.js";import{r as At}from"./signal-BOXE_5dv.js";import{e as Ot}from"./common-CYWrYyJl.js";import{t as Vt}from"./quickselect-DHTstthl.js";import{a as Et}from"./Query-BghuEfPO.js";let B=class z{static getId(e,i,r,o){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${i}/${r}/${o}`}constructor(e,i,r,o){this.set(e,i,r,o)}get key(){return this}get id(){return this.toString()}get normalizedId(){return`${this.level}/${this.row}/${this.col}`}set id(e){this.set(e)}get hash(){const e=4095&this.row,i=4095&this.col,r=63&this.level;return(3&this.world)<<30|i<<22|e<<8|r}acquire(e,i,r,o){this.set(e,i,r,o)}contains(e){const i=e.level-this.level;return i>=0&&this.row===e.row>>i&&this.col===e.col>>i&&this.world===e.world}containsChild(e){const i=e.level-this.level;return i>0&&this.row===e.row>>i&&this.col===e.col>>i&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new z(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,i,r,o){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[n,s,h,l]=e.split("/");this.level=parseFloat(n),this.row=parseFloat(s),this.col=parseFloat(h),this.world=parseFloat(l)}else this.level=+e,this.row=+i,this.col=+r,this.world=+o||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new z(this.level-1,this.row>>1,this.col>>1,this.world)}getNormalizedNeighbor(e,i,r){const o=this.clone();return o.col+=e,o.row+=i,r.normalizeKey(o),o}getChildKeys(){const e=this.level+1,i=this.row<<1,r=this.col<<1,o=this.world;return[new z(e,i,r,o),new z(e,i,r+1,o),new z(e,i+1,r,o),new z(e,i+1,r+1,o)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}};B.pool=new G(B,null,null,25,50);function Y(t,e){return[t,e]}function C(t,e,i){return t[0]=e,t[1]=i,t}function Nt(t,e,i,r,o){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t}const v=new B("0/0/0/0");let jt=class xt{static create(e,i,r=null){const o=U(e.spatialReference),n=i.origin||Y(e.origin.x,e.origin.y),s=Y(e.size[0]*i.resolution,e.size[1]*i.resolution),h=Y(-1/0,-1/0),l=Y(1/0,1/0),a=Y(1/0,1/0);r!=null&&(C(h,Math.max(0,Math.floor((r.xmin-n[0])/s[0])),Math.max(0,Math.floor((n[1]-r.ymax)/s[1]))),C(l,Math.max(0,Math.floor((r.xmax-n[0])/s[0])),Math.max(0,Math.floor((n[1]-r.ymin)/s[1]))),C(a,l[0]-h[0]+1,l[1]-h[1]+1));const{cols:c,rows:f}=i;let m,_,d,w;return!r&&c&&f&&(C(h,c[0],f[0]),C(l,c[1],f[1]),C(a,c[1]-c[0]+1,f[1]-f[0]+1)),e.isWrappable?(m=Y(Math.ceil(Math.round((o.valid[1]-o.valid[0])/i.resolution)/e.size[0]),a[1]),_=!0,d=o.origin,w=o.valid):(m=a,_=!1),new xt(i.level,i.resolution,i.scale,n,h,l,a,s,m,_,d,w)}constructor(e,i,r,o,n,s,h,l,a,c,f,m){this.level=e,this.resolution=i,this.scale=r,this.origin=o,this.first=n,this.last=s,this.size=h,this.norm=l,this.worldSize=a,this.wrap=c,this._spatialReferenceOrigin=f,this._spatialReferenceValid=m}normalizeCol(e){if(!this.wrap)return e;const i=this.worldSize[0];return e<0?i-1-Math.abs((e+1)%i):e%i}normalizeKey(e){if(!this.wrap)return;const i=this.worldSize[0],r=e.col;r<0?(e.col=r+i,e.world-=1):r>=i&&(e.col=r-i,e.world+=1)}denormalizeCol(e,i){return this.wrap?this.worldSize[0]*i+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const i=this.origin[0]+e*this.norm[0],r=this._spatialReferenceOrigin,o=this._spatialReferenceValid;return this.wrap&&r&&o?i===r[0]?o[0]:this.origin[0]===r[0]&&e===this.worldSize[0]?o[1]:i:i}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,i,r=!1){v.set(i);const o=r?v.col:this.denormalizeCol(v.col,v.world),n=v.row;return Nt(e,this.getXForColumn(o),this.getYForRow(n+1),this.getXForColumn(o+1),this.getYForRow(n)),e}getTileCoords(e,i,r=!1){v.set(i);const o=r?v.col:this.denormalizeCol(v.col,v.world);return Array.isArray(e)?C(e,this.getXForColumn(o),this.getYForRow(v.row)):(e.x=this.getXForColumn(o),e.y=this.getYForRow(v.row)),e}},R=class{constructor(){this.spans=[]}acquire(t){this.lodInfo=t}release(){this.lodInfo=null,this.spans.length=0}*keys(){const t=this.lodInfo;for(const{row:e,colFrom:i,colTo:r}of this.spans)for(let o=i;o<=r;o++){const n=t.getWorldForColumn(o);yield new B(t.level,e,t.normalizeCol(o),n)}}forEach(t,e){const{spans:i,lodInfo:r}=this,{level:o}=r;if(i.length!==0)for(const{row:n,colFrom:s,colTo:h}of i)for(let l=s;l<=h;l++)t.call(e,o,n,r.normalizeCol(l),r.getWorldForColumn(l))}};R.pool=new G(R);let K=class{constructor(t,e,i){this.row=t,this.colFrom=e,this.colTo=i}};const g=new B("0/0/0/0");let $t=class Mt{static create(e,i){e[1]>i[1]&&([e,i]=[i,e]);const[r,o]=e,[n,s]=i,h=n-r,l=s-o,a=l!==0?h/l:0,c=(Math.ceil(o)-o)*a,f=(Math.floor(o)-o)*a;return new Mt(r,Math.floor(o),Math.ceil(s),a,h<0?c:f,h<0?f:c,h<0?n:r,h<0?r:n)}constructor(e,i,r,o,n,s,h,l){this.x=e,this.ymin=i,this.ymax=r,this.invM=o,this.leftAdjust=n,this.rightAdjust=s,this.leftBound=h,this.rightBound=l}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const y=[[0,0],[0,0],[0,0],[0,0]],Kt=1e-6;let Dt=class{constructor(t,e=null,i=t.lods[0].level,r=t.lods[t.lods.length-1].level){this.tileInfo=t,this.fullExtent=e,this.scales=[],this._infoByScale={},this._infoByLevel={};const o=t.lods.filter(s=>s.level>=i&&s.level<=r);this.minScale=o[0].scale,this.maxScale=o[o.length-1].scale;const n=this._lodInfos=o.map(s=>jt.create(t,s,e));o.forEach((s,h)=>{this._infoByLevel[s.level]=n[h],this._infoByScale[s.scale]=n[h],this.scales[h]=s.scale},this),this._wrap=t.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(t){return this._infoByLevel[typeof t=="number"?t:t.level]}getTileBounds(t,e,i=!1){g.set(e);const r=this._infoByLevel[g.level];return r?r.getTileBounds(t,g,i):t}getTileCoords(t,e,i=!1){g.set(e);const r=this._infoByLevel[g.level];return r?r.getTileCoords(t,g,i):t}getTileCoverage(t,e=192,i=!0,r="closest"){if(!i&&(t.scale>this.minScale||t.scale<this.maxScale))return null;const o=r==="closest"?this.getClosestInfoForScale(t.scale):this.getSmallestInfoForScale(t.scale),n=R.pool.acquire(o),s=this._wrap;let h,l,a,c=1/0,f=-1/0;const m=n.spans;y[0][0]=y[0][1]=y[1][1]=y[3][0]=-e,y[1][0]=y[2][0]=t.size[0]+e,y[2][1]=y[3][1]=t.size[1]+e;for(const u of y)t.toMap(u,u),u[0]=o.getColumnForX(u[0]),u[1]=o.getRowForY(u[1]);const _=[];let d=3;for(let u=0;u<4;u++){if(y[u][1]===y[d][1]){d=u;continue}const p=$t.create(y[u],y[d]);c=Math.min(p.ymin,c),f=Math.max(p.ymax,f),_[p.ymin]===void 0&&(_[p.ymin]=[]),_[p.ymin].push(p),d=u}if(c==null||f==null||f-c>100)return null;let w=[];for(h=c;h<f;){_[h]!=null&&(w=w.concat(_[h])),l=1/0,a=-1/0;for(let u=w.length-1;u>=0;u--){const p=w[u];l=Math.min(l,p.getLeftCol()),a=Math.max(a,p.getRightCol())}if(l=Math.floor(l),a=Math.floor(a),h>=o.first[1]&&h<=o.last[1])if(s)if(o.size[0]<o.worldSize[0]){const u=Math.floor(a/o.worldSize[0]);for(let p=Math.floor(l/o.worldSize[0]);p<=u;p++)m.push(new K(h,Math.max(o.getFirstColumnForWorld(p),l),Math.min(o.getLastColumnForWorld(p),a)))}else m.push(new K(h,l,a));else l>o.last[0]||a<o.first[0]||(l=Math.max(l,o.first[0]),a=Math.min(a,o.last[0]),m.push(new K(h,l,a)));h+=1;for(let u=w.length-1;u>=0;u--){const p=w[u];p.ymax>=h?p.incrRow():w.splice(u,1)}}return n}getTileParentId(t){g.set(t);const e=this._infoByLevel[g.level],i=this._lodInfos.indexOf(e)-1;return i<0?null:(this._getTileIdAtLOD(g,this._lodInfos[i],g),g.id)}getTileResolution(t){const e=this._infoByLevel[typeof t=="object"?t.level:t];return e?e.resolution:-1}getTileScale(t){const e=this._infoByLevel[t.level];return e?e.scale:-1}intersects(t,e){g.set(e);const i=this._infoByLevel[g.level],r=t.lodInfo;if(r.resolution>i.resolution){this._getTileIdAtLOD(g,r,g);const n=r.denormalizeCol(g.col,g.world);for(const s of t.spans)if(s.row===g.row&&s.colFrom<=n&&s.colTo>=n)return!0}if(r.resolution<i.resolution){const[n,s,h,l]=t.spans.reduce((d,w)=>(d[0]=Math.min(d[0],w.row),d[1]=Math.max(d[1],w.row),d[2]=Math.min(d[2],w.colFrom),d[3]=Math.max(d[3],w.colTo),d),[1/0,-1/0,1/0,-1/0]),a=i.denormalizeCol(g.col,g.world),c=r.getColumnForX(i.getXForColumn(a)),f=r.getRowForY(i.getYForRow(g.row)),m=r.getColumnForX(i.getXForColumn(a+1))-1,_=r.getRowForY(i.getYForRow(g.row+1))-1;return!(c>l||m<h||f>s||_<n)}const o=r.denormalizeCol(g.col,g.world);return t.spans.some(n=>n.row===g.row&&n.colFrom<=o&&n.colTo>=o)}normalizeBounds(t,e,i){if(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._wrap){const r=U(this.tileInfo.spatialReference),o=-i*(r.valid[1]-r.valid[0]);t[0]+=o,t[2]+=o}return t}getSmallestInfoForScale(t){const e=this.scales;if(this._infoByScale[t])return this._infoByScale[t];if(t>e[0])return this._infoByScale[e[0]];for(let i=1;i<e.length-1;i++)if(t>e[i]+Kt)return this._infoByScale[e[i-1]];return this._infoByScale[e[e.length-1]]}getClosestInfoForScale(t){const e=this.scales;return this._infoByScale[t]||(t=e.reduce((i,r)=>Math.abs(r-t)<Math.abs(i-t)?r:i,e[0])),this._infoByScale[t]}scaleToLevel(t){const e=this.scales;if(this._infoByScale[t])return this._infoByScale[t].level;for(let i=e.length-1;i>=0;i--)if(t<e[i])return i===e.length-1?this._infoByScale[e[e.length-1]].level:this._infoByScale[e[i]].level+(e[i]-t)/(e[i]-e[i+1]);return this._infoByScale[e[0]].level}scaleToZoom(t){return this.tileInfo.scaleToZoom(t)}zoomToScale(t){return this.tileInfo.zoomToScale(t)}_getTileIdAtLOD(t,e,i){const r=this._infoByLevel[i.level];return t.set(i),e.resolution<r.resolution?null:(e.resolution===r.resolution||(t.level=e.level,t.col=Math.floor(i.col*r.resolution/e.resolution+.01),t.row=Math.floor(i.row*r.resolution/e.resolution+.01)),t)}},Wt=class{constructor(t,e){this.item=t,this.controller=e,this.promise=null}},Zt=class{constructor(t){this._schedule=null,this._task=null,this._deferreds=new $,this._controllers=new $,this._processingItems=new $,this._pausedSignal=At(!1),this.concurrency=1,t.concurrency&&(this.concurrency=t.concurrency),this._queue=new Lt(t.peeker),this.process=t.process;const e=t.scheduler;t.priority&&e&&(this._task=e.registerTask(t.priority,this))}destroy(){this.clear(),this._schedule=H(this._schedule),this._task=H(this._task)}get updating(){return!!this._task?.updating||this.running}get length(){return this._processingItems.size+this._queue.length}abort(t){const e=this._controllers.get(t);e&&e.abort()}clear(){this._queue.clear();const t=[];this._controllers.forEach(e=>t.push(e)),this._controllers.clear(),t.forEach(e=>e.abort()),this._processingItems.clear(),this._cancelNext()}forEach(t){this._deferreds.forEach((e,i)=>t(i))}get(t){const e=this._deferreds.get(t);return e?e.promise:void 0}isOngoing(t){return this._processingItems.has(t)}has(t){return this._deferreds.has(t)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(t,e){const i=this.get(t);if(i)return i;const r=new AbortController;let o=null;e&&(o=It(e,()=>r.abort()));const n=()=>{const a=this._processingItems.get(t);a&&a.controller.abort(),s(),l.reject(tt())},s=()=>{h.remove(),o?.remove(),this._removeItem(t),this._queue.remove(t),this._scheduleNext()},h=St(r.signal,n),l=bt();return this._deferreds.set(t,l),this._controllers.set(t,r),l.promise.then(s,s),this._queue.push(t),this._scheduleNext(),l.promise}last(){return this._queue.last()}lastPromise(){const t=this.last();return t?this.get(t):null}peek(){return this._queue.peek()}popLast(){const t=this._queue.popLast();return t&&(this._deferreds.get(t)?.reject(tt()),this._removeItem(t)),t}reset(){const t=Array.from(this._processingItems.values());this._processingItems.clear();for(const e of t)this._queue.push(e.item),e.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const t=[];for(;this._queue.length;)t.push(this._queue.pop());return this.clear(),t}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(t){for(;!t.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),t.madeProgress()}_removeItem(t){this._deferreds.delete(t),this._controllers.delete(t),this._processingItems.delete(t)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=Bt(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(t,e){this._canProcessFulfillment(t)&&(this._scheduleNext(),this._deferreds.get(t.item).resolve(e))}_processError(t,e){this._canProcessFulfillment(t)&&(this._scheduleNext(),this._deferreds.get(t.item).reject(e))}_canProcessFulfillment(t){return!!this._deferreds.get(t.item)&&this._processingItems.get(t.item)===t}_process(t){if(t==null)return;let e;const i=new AbortController,r=new Wt(t,i);this._processingItems.set(t,r);try{e=this.process(t,i.signal)}catch(o){this._processError(r,o)}Tt(e)?(r.promise=e,e.then(o=>this._processResult(r,o),o=>this._processError(r,o))):this._processResult(r,e)}get test(){}};const it=[0,0];let I=class extends Ft{constructor(t){super(t),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:t,process:e,scheduler:i,priority:r}=this;this._queue=new Zt({concurrency:t,scheduler:i,priority:r,process:(o,n)=>{const s=this._keyToItem.get(o);return e(s,{signal:n})},peeker:o=>this._peek(o)})}destroy(){this.clear(),this._queue=zt(this._queue)}get length(){return this._queue?this._queue.length:0}abort(t){const e=typeof t=="string"?t:t.id;this._queue.abort(e)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(t){return typeof t=="string"?this._keyToItem.has(t):this._keyToItem.has(t.id)}pause(){this._queue.pause()}push(t){const e=t.key.id;if(this._queue.has(e))return this._queue.get(e);const i=this._queue.push(e),r=this.tileInfoView.getTileScale(t.key),o=kt(this._tilesByScale,r,()=>new Set),n=()=>{o.delete(t.key),o.size===0&&this._tilesByScale.delete(r),this._keyToItem.delete(e)};return o.add(t.key),this._keyToItem.set(e,t),i.then(n,n),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(t){if(!this.state)return t.values().next().value;const e=new Set;for(const n of t)e.add(this._keyToItem.get(n).key);const i=this.state.scale;let r,o=Number.POSITIVE_INFINITY;for(const[n,s]of this._tilesByScale)if(Yt(s,h=>e.has(h))){const h=Math.abs(n-i);h<o&&(r=s,o=h)}return this._getClosestTileKey(r,t).id}_getClosestTileKey(t,e){const i=this.tileInfoView,r=this.state.center;let o,n=Number.POSITIVE_INFINITY;for(const s of t)if(e.has(s.id)){i.getTileCoords(it,s);const h=qt(it,r);h<n&&(n=h,o=s)}return o}};T([k({constructOnly:!0})],I.prototype,"concurrency",void 0),T([k({constructOnly:!0})],I.prototype,"priority",void 0),T([k({constructOnly:!0})],I.prototype,"process",void 0),T([k({constructOnly:!0})],I.prototype,"scheduler",void 0),T([k()],I.prototype,"state",void 0),T([k({constructOnly:!0})],I.prototype,"tileInfoView",void 0),I=T([Ct("esri.views.2d.tiling.TileQueue")],I);const Jt=I;let Qt=class{constructor(t,e,i){this.maxSize=t,this._tileInfoView=e,this._removedFunc=i,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(t){return this._tilePerId.has(t)}get(t){return this._tilePerId.get(t)}pop(t){const e=this._tilePerId.get(t);if(!e)return;const i=e.key.level,r=this._tileKeysPerLevel[i];rt(this._tilePerId,t);for(let o=0;o<r.length;o++)if(r[o].id===t){r.splice(o,1);break}return e.visible=!0,e}add(t){t.visible=!1;const e=t.key,i=e.id;if(this._tilePerId.has(i))return;this._tilePerId.set(i,t);const r=e.level;this._tileKeysPerLevel[r]||(this._tileKeysPerLevel[r]=[]),this._tileKeysPerLevel[r].push(e)}prune(t,e,i){let r=this._tilePerId.size;if(r<=this.maxSize)return;let o=this._tileKeysPerLevel.length-1;for(;r>this.maxSize&&o>=0;)o!==t&&(r=this._pruneAroundCenterTile(r,e,i,o)),o--;r>this.maxSize&&(r=this._pruneAroundCenterTile(r,e,i,t))}_pruneAroundCenterTile(t,e,i,r){const o=this._tileKeysPerLevel[r];if(!o||o.length===0)return t;const{size:n,origin:s}=this._tileInfoView.tileInfo,h=i*n[0],l=i*n[1],a=[0,0],c=[0,0];for(o.sort((f,m)=>(a[0]=s.x+h*(f.col+.5),a[1]=s.y-l*(f.row+.5),c[0]=s.x+h*(m.col+.5),c[1]=s.y-l*(m.row+.5),et(a,e)-et(c,e)));o.length>0;){const f=o.pop();if(this._removeTile(f.id),--t===this.maxSize)break}return t}_removeTile(t){const e=this._tilePerId.get(t);this._removedFunc&&e&&this._removedFunc(e),rt(this._tilePerId,t)}};function rt(t,e){t.delete(e)}const F=new B(0,0,0,0),S=new Map,q=[],D=[];let Gt=class{constructor(t){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,t.resampling!=null&&(this.resampling=t.resampling),t.cachePolicy&&(this.cachePolicy=t.cachePolicy),t.coveragePolicy&&(this.coveragePolicy=t.coveragePolicy),t.buffer!=null&&(this.buffer=t.buffer),t.cacheSize&&(this._tileCache=new Qt(t.cacheSize,this.tileInfoView,e=>{this.releaseTile(e)}))}destroy(){this.tileIndex.clear()}update(t){const{resampling:e,tileIndex:i}=this,{scale:r,center:o,resolution:n}=t.state,{minScale:s,maxScale:h}=this.tileInfoView,l=!t.stationary&&r>this._previousScale;if(this._previousScale=r,!e&&(r>s||r<h))return this.tiles.length=0,void this.clear();const a=this.tileInfoView.getTileCoverage(t.state,this.buffer,this.resampling,this.coveragePolicy);if(!a)return this.tiles.length=0,void this.clear();const{spans:c,lodInfo:f}=a,{level:m}=f;this.tiles.length=0,i.forEach(u=>u.visible=!0);let _=0,d=0;if(c.length>0)for(const{row:u,colFrom:p,colTo:O}of c)for(let b=p;b<=O;b++){_++;const x=F.set(m,u,f.normalizeCol(b),f.getWorldForColumn(b)).id;let M=i.get(x);if(M)M.isReady?(S.set(x,M),d++):l||this._addParentTile(x,S);else{if(this._tileCache?.has(x)){if(M=this._tileCache.pop(x),this.tileIndex.set(x,M),M.isReady){S.set(x,M),d++;continue}}else M=this.acquireTile(F),this.tileIndex.set(x,M);l||this._addParentTile(x,S)}}const w=d===_;for(const[u,p]of i){if(S.has(u))continue;F.set(u);const O=this.tileInfoView.intersects(a,F),b=this.cachePolicy==="purge"?F.level!==m:F.level>m;!O||!l&&w?!b&&O||q.push(p):p.isReady?b&&this.cachePolicy==="purge"&&this._hasReadyAncestor(F,m)?q.push(p):D.push(p):b&&q.push(p)}for(const u of D)u.isReady&&S.set(u.key.id,u);for(const u of q)this._tileCache?this._tileCache.add(u):this.releaseTile(u),i.delete(u.key.id);for(const u of S.values())this.tiles.push(u);for(const u of i.values())S.has(u.key.id)||(u.visible=!1);this._tileCache?.prune(m,o,n),R.pool.release(a),D.length=0,q.length=0,S.clear()}clear(){const{tileIndex:t}=this;for(const e of t.values())this.releaseTile(e);t.clear()}refresh(t){for(const e of this.tileIndex.values())t(e);this._tileCache?.clear()}updateCacheSize(t){this._tileCache&&(this._tileCache.maxSize=t)}_addParentTile(t,e){let i=t,r=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(r=this.tileIndex.get(i),r?.isReady){e.has(r.key.id)||e.set(r.key.id,r);break}}else if(this._tileCache?.has(i)&&(r=this._tileCache.pop(i),this.tileIndex.set(i,r),r?.isReady)){e.has(r.key.id)||e.set(r.key.id,r);break}}_hasReadyAncestor(t,e){const i=j();this.tileInfoView.getTileBounds(i,t,!0);for(const r of this.tileIndex.values())if(r.isReady&&r.key.level>=e&&r.key.level<t.level){const o=j();if(this.tileInfoView.getTileBounds(o,r.key,!0),Pt(o,i))return!0}return!1}};function ot(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function Ut(t){const e=new Float32Array(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function Ht(t,e,i,r,o,n){const s=new Float32Array(6);return s[0]=t,s[1]=e,s[2]=i,s[3]=r,s[4]=o,s[5]=n,s}function te(t,e){return new Float32Array(t,e,6)}function st(t,e,i,r){const o=e[r],n=e[r+1];t[r]=i[0]*o+i[2]*n+i[4],t[r+1]=i[1]*o+i[3]*n+i[5]}function nt(t,e,i,r=0,o=0,n=2){const s=o||e.length/n;for(let h=r;h<s;h++)st(t,e,i,h*n)}Object.freeze(Object.defineProperty({__proto__:null,clone:Ut,create:ot,createView:te,fromValues:Ht,transform:st,transformMany:nt},Symbol.toStringTag,{value:"Module"}));function ee(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function lt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function ht(t,e,i,r,o,n,s){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t[4]=n,t[5]=s,t}function at(t,e){const i=e[0],r=e[1],o=e[2],n=e[3],s=e[4],h=e[5];let l=i*n-r*o;return l?(l=1/l,t[0]=n*l,t[1]=-r*l,t[2]=-o*l,t[3]=i*l,t[4]=(o*h-n*s)*l,t[5]=(r*s-i*h)*l,t):null}function ie(t){return t[0]*t[3]-t[1]*t[2]}function W(t,e,i){const r=e[0],o=e[1],n=e[2],s=e[3],h=e[4],l=e[5],a=i[0],c=i[1],f=i[2],m=i[3],_=i[4],d=i[5];return t[0]=r*a+n*c,t[1]=o*a+s*c,t[2]=r*f+n*m,t[3]=o*f+s*m,t[4]=r*_+n*d+h,t[5]=o*_+s*d+l,t}function ct(t,e,i){const r=e[0],o=e[1],n=e[2],s=e[3],h=e[4],l=e[5],a=Math.sin(i),c=Math.cos(i);return t[0]=r*c+n*a,t[1]=o*c+s*a,t[2]=r*-a+n*c,t[3]=o*-a+s*c,t[4]=h,t[5]=l,t}function ut(t,e,i){const r=e[0],o=e[1],n=e[2],s=e[3],h=e[4],l=e[5],a=i[0],c=i[1];return t[0]=r*a,t[1]=o*a,t[2]=n*c,t[3]=s*c,t[4]=h,t[5]=l,t}function ft(t,e,i){const r=e[0],o=e[1],n=e[2],s=e[3],h=e[4],l=e[5],a=i[0],c=i[1];return t[0]=r,t[1]=o,t[2]=n,t[3]=s,t[4]=r*a+n*c+h,t[5]=o*a+s*c+l,t}function dt(t,e){const i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=-i,t[3]=r,t[4]=0,t[5]=0,t}function mt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function pt(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function re(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function oe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function se(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t}function gt(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t}function ne(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t}function le(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t}function he(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function ae(t,e){const i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],h=t[5],l=e[0],a=e[1],c=e[2],f=e[3],m=e[4],_=e[5],d=Ot();return Math.abs(i-l)<=d*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(r-a)<=d*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(o-c)<=d*Math.max(1,Math.abs(o),Math.abs(c))&&Math.abs(n-f)<=d*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(s-m)<=d*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(h-_)<=d*Math.max(1,Math.abs(h),Math.abs(_))}const ce=W,ue=gt;Object.freeze(Object.defineProperty({__proto__:null,add:se,copy:ee,determinant:ie,equals:ae,exactEquals:he,frob:oe,fromRotation:dt,fromScaling:mt,fromTranslation:pt,identity:lt,invert:at,mul:ce,multiply:W,multiplyScalar:ne,multiplyScalarAndAdd:le,rotate:ct,scale:ut,set:ht,str:re,sub:ue,subtract:gt,translate:ft},Symbol.toStringTag,{value:"Module"}));function V(t,e){if(!(this instanceof V))return new V(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function fe(t,e,i){if(!i)return e.indexOf(t);for(var r=0;r<e.length;r++)if(i(t,e[r]))return r;return-1}function P(t,e){L(t,0,t.children.length,e,t)}function L(t,e,i,r,o){o||(o=X(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var n,s=e;s<i;s++)n=t.children[s],A(o,t.leaf?r(n):n);return o}function A(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function _t(t,e){return t.minX-e.minX}function wt(t,e){return t.minY-e.minY}function Z(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function E(t){return t.maxX-t.minX+(t.maxY-t.minY)}function de(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function me(t,e){var i=Math.max(t.minX,e.minX),r=Math.max(t.minY,e.minY),o=Math.min(t.maxX,e.maxX),n=Math.min(t.maxY,e.maxY);return Math.max(0,o-i)*Math.max(0,n-r)}function J(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function N(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function X(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function yt(t,e,i,r,o){for(var n,s=[e,i];s.length;)(i=s.pop())-(e=s.pop())<=r||(n=e+Math.ceil((i-e)/r/2)*r,Vt(t,n,e,i,o),s.push(e,n,n,i))}V.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,i=[],r=this.toBBox;if(!N(t,e))return i;for(var o,n,s,h,l=[];e;){for(o=0,n=e.children.length;o<n;o++)s=e.children[o],N(t,h=e.leaf?r(s):s)&&(e.leaf?i.push(s):J(t,h)?this._all(s,i):l.push(s));e=l.pop()}return i},collides:function(t){var e=this.data,i=this.toBBox;if(!N(t,e))return!1;for(var r,o,n,s,h=[];e;){for(r=0,o=e.children.length;r<o;r++)if(n=e.children[r],N(t,s=e.leaf?i(n):n)){if(e.leaf||J(t,s))return!0;h.push(n)}e=h.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,i=t.length;e<i;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var o=this.data;this.data=r,r=o}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(t){return t!=null&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=X([]),this},remove:function(t,e){if(t==null)return this;for(var i,r,o,n,s=this.data,h=this.toBBox(t),l=[],a=[];s||l.length;){if(s||(s=l.pop(),r=l[l.length-1],i=a.pop(),n=!0),s.leaf&&(o=fe(t,s.children,e))!==-1)return s.children.splice(o,1),l.push(s),this._condense(l),this;n||s.leaf||!J(s,h)?r?(i++,s=r.children[i],n=!1):s=null:(l.push(s),a.push(i),i=0,r=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:_t,compareMinY:wt,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},_build:function(t,e,i,r){var o,n=i-e+1,s=this._maxEntries;if(n<=s)return P(o=X(t.slice(e,i+1)),this.toBBox),o;r||(r=Math.ceil(Math.log(n)/Math.log(s)),s=Math.ceil(n/Math.pow(s,r-1))),(o=X([])).leaf=!1,o.height=r;var h,l,a,c,f=Math.ceil(n/s),m=f*Math.ceil(Math.sqrt(s));for(yt(t,e,i,m,this.compareMinX),h=e;h<=i;h+=m)for(yt(t,h,a=Math.min(h+m-1,i),f,this.compareMinY),l=h;l<=a;l+=f)c=Math.min(l+f-1,a),o.children.push(this._build(t,l,c,r-1));return P(o,this.toBBox),o},_chooseSubtree:function(t,e,i,r){for(var o,n,s,h,l,a,c,f;r.push(e),!e.leaf&&r.length-1!==i;){for(c=f=1/0,o=0,n=e.children.length;o<n;o++)l=Z(s=e.children[o]),(a=de(t,s)-l)<f?(f=a,c=l<c?l:c,h=s):a===f&&l<c&&(c=l,h=s);e=h||e.children[0]}return e},_insert:function(t,e,i){var r=this.toBBox,o=i?t:r(t),n=[],s=this._chooseSubtree(o,this.data,e,n);for(s.children.push(t),A(s,o);e>=0&&n[e].children.length>this._maxEntries;)this._split(n,e),e--;this._adjustParentBBoxes(o,n,e)},_split:function(t,e){var i=t[e],r=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,r);var n=this._chooseSplitIndex(i,o,r),s=X(i.children.splice(n,i.children.length-n));s.height=i.height,s.leaf=i.leaf,P(i,this.toBBox),P(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(i,s)},_splitRoot:function(t,e){this.data=X([t,e]),this.data.height=t.height+1,this.data.leaf=!1,P(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,i){var r,o,n,s,h,l,a,c;for(l=a=1/0,r=e;r<=i-e;r++)s=me(o=L(t,0,r,this.toBBox),n=L(t,r,i,this.toBBox)),h=Z(o)+Z(n),s<l?(l=s,c=r,a=h<a?h:a):s===l&&h<a&&(a=h,c=r);return c},_chooseSplitAxis:function(t,e,i){var r=t.leaf?this.compareMinX:_t,o=t.leaf?this.compareMinY:wt;this._allDistMargin(t,e,i,r)<this._allDistMargin(t,e,i,o)&&t.children.sort(r)},_allDistMargin:function(t,e,i,r){t.children.sort(r);var o,n,s=this.toBBox,h=L(t,0,e,s),l=L(t,i-e,i,s),a=E(h)+E(l);for(o=e;o<i-e;o++)n=t.children[o],A(h,t.leaf?s(n):n),a+=E(h);for(o=i-e-1;o>=e;o--)n=t.children[o],A(l,t.leaf?s(n):n),a+=E(l);return a},_adjustParentBBoxes:function(t,e,i){for(var r=i;r>=0;r--)A(e[r],t)},_condense:function(t){for(var e,i=t.length-1;i>=0;i--)t[i].children.length===0?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():P(t[i],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};function vt(t,{timeZone:e,timeExtent:i}){return{$view:{scale:t,timeZone:e,timeProperties:{currentStart:i?.start,currentEnd:i?.end}}}}class Q{constructor(e,i){this.key=new B(0,0,0,0),this.bounds=j(),this.objectIds=new Set,this.key.set(i);const r=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=r.resolution,this.level=r.level,this.scale=r.scale,this.minScale=e.zoomToScale(r.level-1),this.maxScale=e.zoomToScale(r.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return Xt(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return vt(this.scale,e)}createChildTiles(){const e=this.key.getChildKeys(),i=Rt.acquire();for(let r=0;r<e.length;r++)i[r]=new Q(this.tileInfoView,e[r]);return i}getQuantizationParameters(){return Et.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}export{dt as M,ft as a,lt as b,ct as c,ht as d,B as e,W as f,ut as g,Dt as h,V as i,nt as j,vt as k,Q as l,pt as m,ot as n,mt as o,Jt as p,Gt as r,R as s,at as u};
